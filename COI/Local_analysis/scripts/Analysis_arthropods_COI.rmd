---
title: "Analysis - Arthropods - COI"
author: "Emil Ellegaard Thomassen"
date: "`r Sys.Date()"
output: github_document
editor_options: 
  chunk_output_type: console
---

The following script performs plots of species richness, read distributions and community compositions of the arthropod reads in the COI data.

# Setup

Setup R and load packages

```{r Setup and load packages}
knitr::opts_chunk$set(
	echo = TRUE,
	fig.height = 5.5,
	message = FALSE,
	warning = FALSE,
	autodep = TRUE,
	cache = TRUE,
	cache.lazy = FALSE,
	tidy = TRUE,
	tidy.opts = list(width.cutoff = 80)
)
rm(list=ls())
gc()
Dir.Base <- here::here()



# Installing packages as needed
install.load.package <- function(x) {
  if (!require(x, character.only = TRUE))
    install.packages(x, repos='http://cran.us.r-project.org', dependencies = TRUE)
  require(x, character.only = TRUE)
}
package_vec <- c("kableExtra", "tidyverse","png", "jpeg", "sp", "ncf","rgdal","MASS", "raster", "ggmap", "ggplot2", "BiodiversityR", "pheatmap", "knitr", "printr", "ade4", "vegan", "ROBITools", "ROBITaxonomy", "dplyr", "tidyr", "plotrix")
sapply(package_vec, install.load.package)

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE, cache.lazy=FALSE, tidy.opts=list(width.cutoff=80),tidy=TRUE, fig.height=5.5)
options(digits=4, width = 90)

```

# All dung-associated Arthropods

```{r Extract dung associated arthropods}

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final")



m=dataset
reads = m@reads
samples = m@samples
motus = m@motus

##Extract all nematode hits
dung.idx<-which(m@motus$phylum_name=="Arthropoda" & m@motus$dung.associated=="yes")

motus<-motus[dung.idx,]
reads<-reads[,dung.idx]
idx.include<-which(rowSums(reads)>0)
reads<-reads[rowSums(reads)>0,]
samples<-samples[idx.include,]

samples<-samples[,-1]
samples<-samples[,-c(26:29)]


m@reads <- reads
m@samples <- samples
m@motus <- motus

dataset = m

total_dung_ass_arthropods<-sum(reads)

par(mfrow=c(1,2))

mean_sample<-mean(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))
hist(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]), #CHANGE Stream_water
     breaks=50,xlab="Reads",main="Read counts")
sem_sample<-std.error(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))
sd_sample<-sd(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))

hist(log(rowSums(dataset@reads[dataset@samples$samples.DungSamples,])), #CHANGE Stream_water
     breaks=50,xlab="Reads",main="Read counts")


saveRDS(dataset, file="COI/Local_analysis/output/RDS_files/dataset_final_arthropods")

```

```{r Generating input df and create species list with reads}

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_arthropods")


#Generating input df


#Create temporary df with read counts in each sample from metabarcoding file
df_tmp<-data.frame(dataset@reads)
colnames(df_tmp)<-dataset@motus$final.otu



#Create temporary df to build file with the columns (sample, species, count, totalreads, freq)
df<-data.frame("sample"=c(), "species"=c(),"count"=c())
df<-rbind(df, c(1,1,1))
colnames(df)<-c("sample", "species", "count")


#Add row to the dataframe for each sample/species combination
for (i in 1:nrow(df_tmp)) {
  for (j in 1:ncol(df_tmp)) {
   if (df_tmp[i,j]!=0) 
     {df<-rbind(df, c(row.names(df_tmp)[i],colnames(df_tmp)[j],df_tmp[i,j]))
     } 
  }
}

#Subtract the first row which was only used to keep correct format
df<-df[-1,]

#Change type of columns (sample=factor, count=numeric)
df2<-data.frame("sample"=as.factor(df$sample), "species"=df$species, "count"=as.numeric(df$count))

#Calculate total reads in each sample
#Create df with unique sample names and totalreads vector
totalreads1<-data.frame("sample"=as.factor(unique(df2$sample)))
totalreads<-c()

#Add value for total reads in each sample to the sample_count vector
for (sample in unique(df2$sample)) {
  x1<-which(df2$sample==sample)
  x2<-sum(df2$count[x1[1]:x1[length(x1)]])
  totalreads<-append(totalreads, rep(x2, each=length(x1))) #Each total count added as many times as each sample in represented in df2
}

#Add totalreads to df2
df2<-cbind(df2,totalreads)


#Calculate frequency of each species in the sample
freq<-c()

for (i in 1:nrow(df2)) {
  x<-df2$count[i]/df2$totalreads[i]
  freq<-append(freq,x)
  
  
}


#Add to df2
df2<-cbind(df2, freq)

#Save as RDS

saveRDS(df2, file="COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_arthropods")



#Generate df with ID and reads

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_arthropods")

reads<-as.data.frame(dataset@reads)

reads<-t(reads)
otu<-as.character(dataset@motus$final.otu)
kingdom<-as.character(dataset@motus$kingdom_name)
phylum<-as.character(dataset@motus$phylum_name)
class<-as.character(dataset@motus$class_name)
order<-as.character(dataset@motus$order_name)
family<-as.character(dataset@motus$family_name)
genus<-as.character(dataset@motus$genus_name)
species<-as.character(dataset@motus$species_name)
dung<-as.character(dataset@motus$dung.associated)
type<-as.character(dataset@motus$type)
row.names(reads)<-otu

total<-rowSums(reads)

df<-as.data.frame(cbind(reads,total))
df<-as.data.frame(cbind(df,kingdom,phylum,class,order,family,genus))
df<-df[order(df$total, decreasing=TRUE),]

#Save as RDS

saveRDS(df, file="COI/Local_analysis/output/RDS_files/df_species_reads_arthropods")

#Export list
write.csv2(df,"COI/Local_analysis/output/tables/MOLS2020_COI_arthropod_ASVs_with_reads.csv", row.names=TRUE)



#Aggregate on genera
df_genera<-aggregate(. ~ genus, data=df[,c(1:140)], FUN=sum)


saveRDS(df_genera, file="COI/Local_analysis/output/RDS_files/df_genera_reads_arthropods")

#Aggregate on family
df_family<-aggregate(. ~ family, data=df[,c(1:140)], FUN=sum)


saveRDS(df_family, file="COI/Local_analysis/output/RDS_files/df_family_reads_arthropods")



```


```{r Richness plot and stacked barplot ASVs/species}

#Plotting the richness of sampling time as well as stacked barplot of all sampling times


#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)
library(MetBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
df_raw <- readRDS("COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_arthropods")

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_arthropods")

Samples<-unique(df_raw$sample)
Richness<-list()

for (i in 1:length(Samples)){
  df<-as.data.frame(Samples[i])
  colnames(df)<-c("Samples")
  Count<-sum(df_raw$count[df_raw$sample==Samples[i]] !=0)
  df<-cbind(df, Count)
  Richness<-rbind(Richness, df)
}

Richness<-Richness %>%
  dplyr::mutate(Samples=factor(Samples))  




#Mean richness pr. month - Galloway

Richness<-cbind(Richness, "source"=dataset@samples$source, "month"=dataset@samples$month, "habitat"=dataset@samples$habitat, "lat"=dataset@samples$lat, "lon"=dataset@samples$lon)

Richness<-Richness[order(Richness$month),]

saveRDS(Richness, file="COI/Local_analysis/output/RDS_files/Richness_df_arthropods")

Richness_gal<-subset(Richness, Richness$source=="galloway")
Richness_exm<-subset(Richness, Richness$source=="exmoor")

#Calculate std error

Gal_agg<-aggregate( . ~ month, data=Richness_gal, std.error)
Exm_agg<-aggregate( . ~ month, data=Richness_exm, std.error)



se_gal<-c(rep(Gal_agg$Count[1], each=9),
          rep(Gal_agg$Count[2], each=9),
          rep(Gal_agg$Count[3], each=10),
          rep(Gal_agg$Count[4], each=8),
          rep(Gal_agg$Count[5], each=8),
          rep(Gal_agg$Count[6], each=10),
          rep(Gal_agg$Count[7], each=9),
          rep(Gal_agg$Count[8], each=10),
          rep(Gal_agg$Count[9], each=5),
          rep(Gal_agg$Count[10], each=9),
          rep(Gal_agg$Count[11], each=10),
          rep(Gal_agg$Count[12], each=10))

se_exm<-c(rep(Exm_agg$Count[1], each=11),
          rep(Exm_agg$Count[2], each=10),
          rep(Exm_agg$Count[3], each=10),
          rep(Exm_agg$Count[4], each=10),
          rep(Exm_agg$Count[5], each=10),
          rep(Exm_agg$Count[6], each=10),
          rep(Exm_agg$Count[7], each=10),
          rep(Exm_agg$Count[8], each=8),
          rep(Exm_agg$Count[9], each=15),
          rep(Exm_agg$Count[10], each=10),
          rep(Exm_agg$Count[11], each=10),
          rep(Exm_agg$Count[12], each=10))

Richness_gal<-cbind(Richness_gal, se_gal)
Richness_exm<-cbind(Richness_exm, se_exm)

Richness_gal[is.na(Richness_gal)]=0
Richness_exm[is.na(Richness_exm)]=0



#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 


#Plotting species richness over time
#Galloway
Species_Richness_gal<-ggplot(Richness_gal, aes(x=factor(month, level=level_order), y=Count, group=1)) +
  geom_point(stat="summary", fun=mean, col="darkorange") +
  geom_errorbar(stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_gal, ymax=Count+se_gal), width=0.5, col="darkorange") +
  #geom_errorbar(stat="summary", data=Richness_gal$Count[which(Richness_gal$month!="December")], aes(x=factor(Richness_gal$month[-which(Richness_gal$month=="December")], level=level_order), ymin=Richness_gal$Count-0.5, ymax=Richness_gal$Count+0.5), width=0.5, fun="mean_se") +
  scale_y_continuous(breaks=c(seq(0, 36, by = 2))) +
  stat_summary(fun=mean, geom="line", col="darkorange") +
  ggtitle("Species richness in cowpats") +
  theme_bw() +
  coord_cartesian(ylim=c(1,36)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) +
  xlab("Month") +
  ylab("Number of arthropod species")

Species_Richness_gal

#Set level order for plots
#level_order <- c("January","February","April", "June", "August","December") 

level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Exmoor
Species_Richness_exm<-ggplot(Richness_exm, aes(x=factor(month, level=level_order), y=Count, group=1)) + 
  geom_point(stat="summary", fun=mean, col="darkred") +
  geom_errorbar(stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_exm, ymax=Count+se_exm), width=0.5, col="darkred") +
  #geom_point(stat="identity") +
  scale_y_continuous(breaks=c(seq(0, 36, by = 2))) +
  stat_summary(fun=mean, geom="line", col="darkred") +
  ggtitle("Species richness in horse dung") +
  theme_bw() +
  coord_cartesian(ylim=c(1,36)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) +
  xlab("Month") +
  ylab("Number of arthropod species")

Species_Richness_exm

level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

dummy<-data.frame("Count"=c(rep(0,each=12)),"month"=level_order)

#Both
Species_Richness<-ggplot(dummy, aes(x=factor(month, level=level_order), y=Count, group=1)) + 
  geom_vline(xintercept="April",colour="white", linetype=2)+
  geom_vline(xintercept=4.5,colour="darkgrey", linetype=2)+
  geom_vline(xintercept=8.5,colour="darkgrey", linetype=2)+
  geom_point(data=Richness_gal, stat="summary", fun=mean, colour="darkseagreen4") +
  geom_errorbar(data=Richness_gal, stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_gal, ymax=Count+se_gal), width=0.5, colour="darkseagreen4") +
  geom_point(data=Richness_exm, stat="summary", fun=mean, colour="dodgerblue3") +
  geom_errorbar(data=Richness_exm, stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_exm, ymax=Count+se_exm), width=0.5, colour="dodgerblue3") +
  scale_y_continuous(breaks=c(seq(0,26, by=2))) +
  stat_summary(data=Richness_gal, fun=mean, geom="line", colour="darkseagreen4") +
  stat_summary(data=Richness_exm, fun=mean, geom="line", colour="dodgerblue3") +
  #ggtitle("Species richness - dung associated coleopterans") +
  annotate("text", x=2.5, y=25, label="Early season", cex=3.5) +
  annotate("text", x=6.5, y=25, label ="Mid season", cex=3.5) +
  annotate("text", x=10.5, y=25, label="Late season", cex=3.5) +
  annotate("text", x=2.5, y=23.5, label="ns. ", cex=3.5) +
  annotate("text", x=6.5, y=23.5, label=" ( *** ) ", cex=3.5) +
  annotate("text", x=10.5, y=23.5, label=" ns. ", cex=3.5) +
  theme_bw() +
  #coord_cartesian(ylim=c(1,26)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=14, hjust = 0.5, face="italic"),axis.text.x = element_text(vjust=0.5,angle = 75, size=14),axis.text.y = element_text(size=12), axis.title.y = element_text(size=14)) +
  xlab("Month") +
  ylab("Species richness")

Species_Richness

ggarrange(Species_Richness, ncol = 1, nrow = 1)
ggsave("COI/Local_analysis/output/plots/SpeciesRichnessBothOneFig_arthropods.pdf", width=10, height=6)


saveRDS(Species_Richness, file="COI/Local_analysis/output/RDS_files/Species_Richness_arthropods")

ggarrange(Species_Richness_gal, Species_Richness_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/SpeciesRichnessBoth_arthropods.pdf", width=14, height=8)

RichnessBoth<-ggarrange(Species_Richness_gal, Species_Richness_exm, labels = c("A", "B"), ncol = 1, nrow = 2)

saveRDS(RichnessBoth, file="COI/Local_analysis/output/RDS_files/RichnessBoth_arthropods")


#Find most abundant species across all samples

samples.data = read.table("COI/MetaBarFlow/output/Metadata_MOLS2020_invertebrates_corrected_source.txt",
                        header=TRUE,row.names=1,na.strings="NA")



source_vec<-c()
month_vec<-c()

for (i in 1:nrow(df_raw)) {
  sample<-as.character(df_raw$sample[i])
  idx<-which(row.names(samples.data)==sample)
  source_vec<-append(source_vec, as.character(samples.data$source[idx]))
  month_vec<-append(month_vec, as.character(samples.data$month[idx]))
}

source<-as.factor(source_vec)
month<-as.factor(month_vec)

df_raw<-cbind(df_raw, source, month)

df_gal<-subset(df_raw, df_raw$source=="galloway")
df_exm<-subset(df_raw, df_raw$source=="exmoor")

#Galloway
Species<-unique(df_gal$species)
abun<-list()

for (i in 1:length(Species)){
  df<-as.data.frame(Species[i])
  colnames(df)<-c("Species")
  Count<-sum(df_gal$count[df_gal$species==Species[i]])
  df<-cbind(df, Count)
  abun<-rbind(abun, df)
}

abundance<-abun[order(abun$Count),c(1,2)]

#Create vector of 20 most abundant species/ASVs
high_20_gal<-as.character(abundance$Species[(nrow(abundance)-19):(nrow(abundance))])

#Add "Other" as level in the df_raw$species vector
levels(df_gal$species) <- c(levels(df_gal$species),"Other")

#Check if species is in the 20 most abundant - if not, change species to "Other"
for (i in 1:nrow(df_gal)) {
  x<-as.character(df_gal$species[i])
  vec<-grepl(as.character(x), high_20_gal, fixed=TRUE)
  if (sum(vec)==0) {df_gal$species[i]="Other"     }
}


#Rename genus column to Genus
df_gal<-df_gal %>%
  dplyr::rename(Species=species)

#Change order of sampling time
df_gal<-df_gal %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-append(sort(high_20_gal),"Other")


df_gal<-df_gal %>%
  dplyr::mutate(Species=factor(Species, levels=levels))

#Adding 21 color option
nb.cols <- 20
#mycolorsbase<-met.brewer("Redon",nb.cols,type="continuous")
#mycolors <- colorRampPalette(brewer.pal(8, "Pastel2"))(nb.cols)
mycolorsbase <-c("darkolivegreen3","chocolate","brown2","darkolivegreen1","darkseagreen4","brown4","burlywood4","darkolivegreen","burlywood3","darkseagreen1","cornflowerblue","bisque4","chocolate1","yellow","darkorange4","burlywood1","brown","darkred","cyan","burlywood2","chartreuse3","darkkhaki","cadetblue4","goldenrod2","lightpink1","hotpink2","palegreen", "darkblue","darkmagenta","yellowgreen","magenta2","seagreen","mintcream","coral1", "grey")
#mycolors<-c('#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4', '#469990', '#dcbeff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#a9a9a9', '#000000')
mycolors<-mycolorsbase[c(3:4,6,10,12:13,15:17,19:21,26:33)]
mycolors<-append(mycolors,"black")

#Plotting Galloway
stacked_gal<-ggplot(df_gal, aes(fill=Species, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=2)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Relative frequency")

stacked_gal

#Exmoor
Species<-unique(df_exm$species)
abun<-list()

for (i in 1:length(Species)){
  df<-as.data.frame(Species[i])
  colnames(df)<-c("Species")
  Count<-sum(df_exm$count[df_exm$species==Species[i]])
  df<-cbind(df, Count)
  abun<-rbind(abun, df)
}

abundance<-abun[order(abun$Count),c(1,2)]

#Create vector of 20 most abundant species/ASVs
high_20_exm<-as.character(abundance$Species[(nrow(abundance)-19):(nrow(abundance))])

#Add "Other" as level in the df_raw$species vector
levels(df_exm$species) <- c(levels(df_exm$species),"Other")

#Check if species is in the 20 most abundant - if not, change species to "Other"
for (i in 1:nrow(df_exm)) {
  x<-as.character(df_exm$species[i])
  vec<-grepl(as.character(x), high_20_exm, fixed=TRUE)
  if (sum(vec)==0) {df_exm$species[i]="Other"     }
}


#Rename genus column to Genus
df_exm<-df_exm %>%
  dplyr::rename(Species=species)

#Change order of sampling time
df_exm<-df_exm %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-append(sort(high_20_exm),"Other")


df_exm<-df_exm %>%
  dplyr::mutate(Species=factor(Species, levels=levels))

mycolors<-mycolorsbase[c(1:3,5:9,11:16,18,20,22:25)]
mycolors<-append(mycolors,"black")

#Plotting Exmoor
stacked_exm<-ggplot(df_exm, aes(fill=Species, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=2)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Relative frequency")

write.csv(cbind(sort(high_20_exm),sort(high_20_gal)), file="COI/Local_analysis/output/tables/high-20_dung_arthropods.csv")


ggarrange(stacked_gal,stacked_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothSpecies_arthropods.pdf", width=14, height=8)



StackedBoth<-ggarrange(stacked_gal,stacked_exm, labels = c("A", "B"), ncol = 1, nrow = 2)

saveRDS(StackedBoth, file="COI/Local_analysis/output/RDS_files/StackedBothSpecies_arthropods")

#ggsave("Stacked_barplot_all_time.pdf",width=15,height=8.5)

#Aggregate samples by month

gal_month<-aggregate(df_gal, list(Month = df_gal$month, Species = df_gal$Species), FUN=mean)
exm_month<-aggregate(df_exm, list(Month = df_exm$month, Species = df_exm$Species), FUN=mean)

#Remove redundant columns
gal_month<-gal_month[,-c(3:4,6:9)]
exm_month<-exm_month[,-c(3:4,6:9)]

gal_month_20<-gal_month
exm_month_20<-exm_month

#Calculate total reads in each month

jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()
for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {jan<-append(jan, gal_month$count[i])}
  if (gal_month$Month[i]=="February") {feb<-append(feb, gal_month$count[i])}
  if (gal_month$Month[i]=="March") {mar<-append(mar, gal_month$count[i])}
  if (gal_month$Month[i]=="April") {apr<-append(apr, gal_month$count[i])}
  if (gal_month$Month[i]=="May") {may<-append(may, gal_month$count[i])}
  if (gal_month$Month[i]=="June") {jun<-append(jun, gal_month$count[i])}
  if (gal_month$Month[i]=="July") {jul<-append(jul, gal_month$count[i])}
  if (gal_month$Month[i]=="August") {aug<-append(aug, gal_month$count[i])}
  if (gal_month$Month[i]=="September") {sep<-append(sep, gal_month$count[i])}
  if (gal_month$Month[i]=="October") {oct<-append(oct, gal_month$count[i])}
  if (gal_month$Month[i]=="November") {nov<-append(nov, gal_month$count[i])}
  if (gal_month$Month[i]=="December") {dec<-append(dec, gal_month$count[i])}
}
total_each_gal<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(gal_month)))

gal_month<-cbind(gal_month, totalreads)

for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {gal_month$totalreads[i]=total_each_gal[1]}
  if (gal_month$Month[i]=="February") {gal_month$totalreads[i]=total_each_gal[2]}
  if (gal_month$Month[i]=="March") {gal_month$totalreads[i]=total_each_gal[3]}
  if (gal_month$Month[i]=="April") {gal_month$totalreads[i]=total_each_gal[4]}
  if (gal_month$Month[i]=="May") {gal_month$totalreads[i]=total_each_gal[5]}
  if (gal_month$Month[i]=="June") {gal_month$totalreads[i]=total_each_gal[6]}
  if (gal_month$Month[i]=="July") {gal_month$totalreads[i]=total_each_gal[7]}
  if (gal_month$Month[i]=="August") {gal_month$totalreads[i]=total_each_gal[8]}
  if (gal_month$Month[i]=="September") {gal_month$totalreads[i]=total_each_gal[9]}
  if (gal_month$Month[i]=="October") {gal_month$totalreads[i]=total_each_gal[10]}
  if (gal_month$Month[i]=="November") {gal_month$totalreads[i]=total_each_gal[11]}
  if (gal_month$Month[i]=="December") {gal_month$totalreads[i]=total_each_gal[12]}
  }

freq<-c()

for (i in 1:nrow(gal_month)) {
  x<-gal_month$count[i]/gal_month$totalreads[i]
  freq<-append(freq,x)
}

gal_month<-cbind(gal_month, freq)

#And for exmoor ponies


jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {jan<-append(jan, exm_month$count[i])}
  if (exm_month$Month[i]=="February") {feb<-append(feb, exm_month$count[i])}
  if (exm_month$Month[i]=="March") {mar<-append(mar, exm_month$count[i])}
  if (exm_month$Month[i]=="April") {apr<-append(apr, exm_month$count[i])}
  if (exm_month$Month[i]=="May") {may<-append(may, exm_month$count[i])}
  if (exm_month$Month[i]=="June") {jun<-append(jun, exm_month$count[i])}
  if (exm_month$Month[i]=="July") {jul<-append(jul, exm_month$count[i])}
  if (exm_month$Month[i]=="August") {aug<-append(aug, exm_month$count[i])}
  if (exm_month$Month[i]=="September") {sep<-append(sep, exm_month$count[i])}
  if (exm_month$Month[i]=="October") {oct<-append(oct, exm_month$count[i])}
  if (exm_month$Month[i]=="November") {nov<-append(nov, exm_month$count[i])}
  if (exm_month$Month[i]=="December") {dec<-append(dec, exm_month$count[i])}
}
total_each_exm<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(exm_month)))

exm_month<-cbind(exm_month, totalreads)

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {exm_month$totalreads[i]=total_each_exm[1]}
  if (exm_month$Month[i]=="February") {exm_month$totalreads[i]=total_each_exm[2]}
  if (exm_month$Month[i]=="March") {exm_month$totalreads[i]=total_each_exm[3]}
  if (exm_month$Month[i]=="April") {exm_month$totalreads[i]=total_each_exm[4]}
  if (exm_month$Month[i]=="May") {exm_month$totalreads[i]=total_each_exm[5]}
  if (exm_month$Month[i]=="June") {exm_month$totalreads[i]=total_each_exm[6]}
  if (exm_month$Month[i]=="July") {exm_month$totalreads[i]=total_each_exm[7]}
  if (exm_month$Month[i]=="August") {exm_month$totalreads[i]=total_each_exm[8]}
  if (exm_month$Month[i]=="September") {exm_month$totalreads[i]=total_each_exm[9]}
  if (exm_month$Month[i]=="October") {exm_month$totalreads[i]=total_each_exm[10]}
  if (exm_month$Month[i]=="November") {exm_month$totalreads[i]=total_each_exm[11]}
  if (exm_month$Month[i]=="December") {exm_month$totalreads[i]=total_each_exm[12]}
  }

freq<-c()

for (i in 1:nrow(exm_month)) {
  x<-exm_month$count[i]/exm_month$totalreads[i]
  freq<-append(freq,x)
}

exm_month<-cbind(exm_month, freq)

mycolors<-mycolorsbase[c(3:4,6,10,12:13,15:17,19:21,26:33)]
mycolors<-append(mycolors,"black")


#Plotting Galloway
stacked_gal_months<-ggplot(gal_month, aes(fill=Species, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=2)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Relative frequency")

mycolors<-mycolorsbase[c(1:3,5:9,11:16,18,20,22:25)]
mycolors<-append(mycolors,"black")

#Plotting Exmoor
stacked_exm_months<-ggplot(exm_month, aes(fill=Species, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=2)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Relative frequency")



ggarrange(stacked_gal_months, stacked_exm_months, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothMonthsSpecies_arthropods.pdf", width=14, height=8)


StackedBothMonths<-ggarrange(stacked_gal_months, stacked_exm_months, labels = c("A", "B"), ncol = 1, nrow = 2)

saveRDS(StackedBothMonths, file="COI/Local_analysis/output/RDS_files/StackedBothMonthsSpecies_arthropods")



```


```{r Stacked barplots functional groups}

#Plotting the richness of sampling time as well as stacked barplot of all sampling times


#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)
library(MetBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_arthropods")


# Extract only dung-associated

m=dataset
reads = m@reads
samples = m@samples
motus = m@motus

##Extract all dung-associated hits
dung.idx<-which(m@motus$dung.associated=="yes")

motus<-motus[dung.idx,]
reads<-reads[,dung.idx]
idx.include<-which(rowSums(reads)>0)
reads<-reads[rowSums(reads)>0,]
samples<-samples[idx.include,]

samples<-samples[,-1]
samples<-samples[,-c(26:29)]


m@reads <- reads
m@samples <- samples
m@motus <- motus

dataset = m

total_dung_arthropods<-sum(reads)


saveRDS(dataset, file="COI/Local_analysis/output/RDS_files/dataset_final_dung_associated_arthropods")



#Generating input df


#Create temporary df with read counts in each sample from metabarcoding file
df_tmp<-data.frame(dataset@reads)
colnames(df_tmp)<-dataset@motus$type



#Create temporary df to build file with the columns (sample, species, count, totalreads, freq)
df<-data.frame("sample"=c(), "type"=c(),"count"=c())
df<-rbind(df, c(1,1,1))
colnames(df)<-c("sample", "type", "count")


#Add row to the dataframe for each sample/type combination
for (i in 1:nrow(df_tmp)) {
  for (j in 1:ncol(df_tmp)) {
   if (df_tmp[i,j]!=0) 
     {df<-rbind(df, c(row.names(df_tmp)[i],colnames(df_tmp)[j],df_tmp[i,j]))
     } 
  }
}

#Subtract the first row which was only used to keep correct format
df<-df[-1,]

#Change type of columns (sample=factor, count=numeric)
df2<-data.frame("sample"=as.factor(df$sample), "type"=df$type, "count"=as.numeric(df$count))

df2<-data.table::setorder(aggregate(.~sample+type, data=df2, FUN=sum),sample)

#Calculate total reads in each sample
#Create df with unique sample names and totalreads vector
totalreads1<-data.frame("sample"=as.factor(unique(df2$sample)))
totalreads<-c()

#Add value for total reads in each sample to the sample_count vector
for (sample in unique(df2$sample)) {
  x1<-which(df2$sample==sample)
  x2<-sum(df2$count[x1[1]:x1[length(x1)]])
  totalreads<-append(totalreads, rep(x2, each=length(x1))) #Each total count added as many times as each sample in represented in df2
}

#Add totalreads to df2
df2<-cbind(df2,totalreads)


#Calculate frequency of each species in the sample
freq<-c()

for (i in 1:nrow(df2)) {
  x<-df2$count[i]/df2$totalreads[i]
  freq<-append(freq,x)
  
  
}


#Add to df2
df_raw<-cbind(df2, freq)


#Find most abundant species across all samples

samples.data = read.table("COI/MetaBarFlow/output/Metadata_MOLS2020_invertebrates_corrected_source.txt",
                        header=TRUE,row.names=1,na.strings="NA")



source_vec<-c()
month_vec<-c()

for (i in 1:nrow(df_raw)) {
  sample<-as.character(df_raw$sample[i])
  idx<-which(row.names(samples.data)==sample)
  source_vec<-append(source_vec, as.character(samples.data$source[idx]))
  month_vec<-append(month_vec, as.character(samples.data$month[idx]))
}

source<-as.factor(source_vec)
month<-as.factor(month_vec)

df_raw<-cbind(df_raw, source, month)

df_gal<-subset(df_raw, df_raw$source=="galloway")
df_exm<-subset(df_raw, df_raw$source=="exmoor")



#Rename genus column to Genus
df_gal<-df_gal %>%
  dplyr::rename(Type=type)

#Change order of sampling time
df_gal<-df_gal %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-sort(unique(df_gal$Type))


df_gal<-df_gal %>%
  dplyr::mutate(Type=factor(Type, levels=levels))

#Adding 21 color option

nb.cols <- 11
mycolorsbase<-met.brewer("Manet",nb.cols,type="discrete")
mycolors<-mycolorsbase[c(2:11)]

#Plotting Galloway
stacked_gal<-ggplot(df_gal, aes(fill=Type, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Relative frequency")

stacked_gal

#Exmoor

#Rename genus column to Genus
df_exm<-df_exm %>%
  dplyr::rename(Type=type)

#Change order of sampling time
df_exm<-df_exm %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-sort(unique(df_exm$Type))


df_exm<-df_exm %>%
  dplyr::mutate(Type=factor(Type, levels=levels))

mycolors<-mycolorsbase[c(1:7,10:11)]

#Plotting Exmoor
stacked_exm<-ggplot(df_exm, aes(fill=Type, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Relative frequency")


ggarrange(stacked_gal,stacked_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothSpecies_arthropods_functional_types_all_samples.pdf", width=14, height=8)

#Aggregate samples by month

gal_month<-aggregate(df_gal, list(Month = df_gal$month, Type = df_gal$Type), FUN=mean)
exm_month<-aggregate(df_exm, list(Month = df_exm$month, Type = df_exm$Type), FUN=mean)

#Remove redundant columns
gal_month<-gal_month[,-c(3:4,6:9)]
exm_month<-exm_month[,-c(3:4,6:9)]

gal_month_20<-gal_month
exm_month_20<-exm_month

#Calculate total reads in each month

jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()
for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {jan<-append(jan, gal_month$count[i])}
  if (gal_month$Month[i]=="February") {feb<-append(feb, gal_month$count[i])}
  if (gal_month$Month[i]=="March") {mar<-append(mar, gal_month$count[i])}
  if (gal_month$Month[i]=="April") {apr<-append(apr, gal_month$count[i])}
  if (gal_month$Month[i]=="May") {may<-append(may, gal_month$count[i])}
  if (gal_month$Month[i]=="June") {jun<-append(jun, gal_month$count[i])}
  if (gal_month$Month[i]=="July") {jul<-append(jul, gal_month$count[i])}
  if (gal_month$Month[i]=="August") {aug<-append(aug, gal_month$count[i])}
  if (gal_month$Month[i]=="September") {sep<-append(sep, gal_month$count[i])}
  if (gal_month$Month[i]=="October") {oct<-append(oct, gal_month$count[i])}
  if (gal_month$Month[i]=="November") {nov<-append(nov, gal_month$count[i])}
  if (gal_month$Month[i]=="December") {dec<-append(dec, gal_month$count[i])}
}
total_each_gal<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(gal_month)))

gal_month<-cbind(gal_month, totalreads)

for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {gal_month$totalreads[i]=total_each_gal[1]}
  if (gal_month$Month[i]=="February") {gal_month$totalreads[i]=total_each_gal[2]}
  if (gal_month$Month[i]=="March") {gal_month$totalreads[i]=total_each_gal[3]}
  if (gal_month$Month[i]=="April") {gal_month$totalreads[i]=total_each_gal[4]}
  if (gal_month$Month[i]=="May") {gal_month$totalreads[i]=total_each_gal[5]}
  if (gal_month$Month[i]=="June") {gal_month$totalreads[i]=total_each_gal[6]}
  if (gal_month$Month[i]=="July") {gal_month$totalreads[i]=total_each_gal[7]}
  if (gal_month$Month[i]=="August") {gal_month$totalreads[i]=total_each_gal[8]}
  if (gal_month$Month[i]=="September") {gal_month$totalreads[i]=total_each_gal[9]}
  if (gal_month$Month[i]=="October") {gal_month$totalreads[i]=total_each_gal[10]}
  if (gal_month$Month[i]=="November") {gal_month$totalreads[i]=total_each_gal[11]}
  if (gal_month$Month[i]=="December") {gal_month$totalreads[i]=total_each_gal[12]}
  }

freq<-c()

for (i in 1:nrow(gal_month)) {
  x<-gal_month$count[i]/gal_month$totalreads[i]
  freq<-append(freq,x)
}

gal_month<-cbind(gal_month, freq)

#And for exmoor ponies


jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {jan<-append(jan, exm_month$count[i])}
  if (exm_month$Month[i]=="February") {feb<-append(feb, exm_month$count[i])}
  if (exm_month$Month[i]=="March") {mar<-append(mar, exm_month$count[i])}
  if (exm_month$Month[i]=="April") {apr<-append(apr, exm_month$count[i])}
  if (exm_month$Month[i]=="May") {may<-append(may, exm_month$count[i])}
  if (exm_month$Month[i]=="June") {jun<-append(jun, exm_month$count[i])}
  if (exm_month$Month[i]=="July") {jul<-append(jul, exm_month$count[i])}
  if (exm_month$Month[i]=="August") {aug<-append(aug, exm_month$count[i])}
  if (exm_month$Month[i]=="September") {sep<-append(sep, exm_month$count[i])}
  if (exm_month$Month[i]=="October") {oct<-append(oct, exm_month$count[i])}
  if (exm_month$Month[i]=="November") {nov<-append(nov, exm_month$count[i])}
  if (exm_month$Month[i]=="December") {dec<-append(dec, exm_month$count[i])}
}
total_each_exm<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(exm_month)))

exm_month<-cbind(exm_month, totalreads)

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {exm_month$totalreads[i]=total_each_exm[1]}
  if (exm_month$Month[i]=="February") {exm_month$totalreads[i]=total_each_exm[2]}
  if (exm_month$Month[i]=="March") {exm_month$totalreads[i]=total_each_exm[3]}
  if (exm_month$Month[i]=="April") {exm_month$totalreads[i]=total_each_exm[4]}
  if (exm_month$Month[i]=="May") {exm_month$totalreads[i]=total_each_exm[5]}
  if (exm_month$Month[i]=="June") {exm_month$totalreads[i]=total_each_exm[6]}
  if (exm_month$Month[i]=="July") {exm_month$totalreads[i]=total_each_exm[7]}
  if (exm_month$Month[i]=="August") {exm_month$totalreads[i]=total_each_exm[8]}
  if (exm_month$Month[i]=="September") {exm_month$totalreads[i]=total_each_exm[9]}
  if (exm_month$Month[i]=="October") {exm_month$totalreads[i]=total_each_exm[10]}
  if (exm_month$Month[i]=="November") {exm_month$totalreads[i]=total_each_exm[11]}
  if (exm_month$Month[i]=="December") {exm_month$totalreads[i]=total_each_exm[12]}
  }

freq<-c()

for (i in 1:nrow(exm_month)) {
  x<-exm_month$count[i]/exm_month$totalreads[i]
  freq<-append(freq,x)
}

exm_month<-cbind(exm_month, freq)

mycolors<-mycolorsbase[c(2:11)]


#Plotting Galloway
stacked_gal_months<-ggplot(gal_month, aes(fill=Type, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Relative frequency")

mycolors<-mycolorsbase[c(1:7,10:11)]

#Plotting Exmoor
stacked_exm_months<-ggplot(exm_month, aes(fill=Type, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Relative frequency")



ggarrange(stacked_gal_months, stacked_exm_months, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothMonthsSpecies_arthropods_functional_types.pdf", width=14, height=6)




```


```{r Find unique species}



#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
df_raw <- readRDS("COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_arthropods")

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_arthropods")

#Create season vec

samples<-dataset@samples[,c("source", "habitat","month")]

season_vec=c()
for (i in 1:nrow(samples)) {
  if (samples$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="December") {season_vec<-append(season_vec,"late")}
}


dataset@samples$season<-as.factor(season_vec)

nsamples<-as.data.frame(table(df_raw$species))
colnames(nsamples)<-c("species","freq")

#Remove species only present in fewer than 5 samples
nsamples<-nsamples[which(nsamples$freq>=5),]



df_gal<-dataset@reads[which(dataset@samples$source=="galloway"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_gal)<-nsamples$species
df_exm<-dataset@reads[which(dataset@samples$source=="exmoor"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_exm)<-nsamples$species
df_open<-dataset@reads[which(dataset@samples$habitat=="open"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_open)<-nsamples$species
df_forest<-dataset@reads[which(dataset@samples$habitat=="forest"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_forest)<-nsamples$species
df_early<-dataset@reads[which(dataset@samples$season=="early"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_early)<-nsamples$species
df_mid<-dataset@reads[which(dataset@samples$season=="mid"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_mid)<-nsamples$species
df_late<-dataset@reads[which(dataset@samples$season=="late"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_late)<-nsamples$species
df_eg<-dataset@reads[which(dataset@samples$season=="early" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_eg)<-nsamples$species
df_ee<-dataset@reads[which(dataset@samples$season=="early" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_ee)<-nsamples$species
df_mg<-dataset@reads[which(dataset@samples$season=="mid" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_mg)<-nsamples$species
df_me<-dataset@reads[which(dataset@samples$season=="mid" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_me)<-nsamples$species
df_lg<-dataset@reads[which(dataset@samples$season=="late" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_lg)<-nsamples$species
df_le<-dataset@reads[which(dataset@samples$season=="late" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_le)<-nsamples$species




df_gal_total<-colSums(df_gal)
df_exm_total<-colSums(df_exm)
df_open_total<-colSums(df_open)
df_forest_total<-colSums(df_forest)

GaEx<-data.frame(rbind(df_gal_total,df_exm_total))
colnames(GaEx)<-colnames(df_gal)


skew<-NULL

for (i in 1:ncol(GaEx)) {
  if (GaEx[,i][1]/GaEx[,i][2]<0.1) {skew<-append(skew, "YES: Exm")}
  else if (GaEx[,i][2]/GaEx[,i][1]<0.1) {skew<-append(skew, "YES: Gal")}
  else  {skew<-append(skew, "NO")}
  
  
}

GaEx<-rbind(GaEx,skew)

Skew.df<-data.frame(t(GaEx))


OF<-data.frame(rbind(df_open_total,df_forest_total))
colnames(OF)<-colnames(df_open)


skew<-NULL

for (i in 1:ncol(OF)) {
  if (OF[,i][1]/OF[,i][2]<0.1) {skew<-append(skew, "YES: Forest")}
  else if (OF[,i][2]/OF[,i][1]<0.1) {skew<-append(skew, "YES: Open")}
  else  {skew<-append(skew, "NO")}
  
  
}

OF<-rbind(OF,skew)

Skew.df<-cbind(Skew.df, data.frame(t(OF)))

colnames(Skew.df)<-c("Galloway","Exmoor","Skewed source","Open","Forest","Skewed habitat")


write.table(Skew.df, file="COI/Local_analysis/output/tables/skew_table_arthropods.txt", sep = "\t")



#Unique species

gal_species<-c()
exm_species<-c()
open_species<-c()
forest_species<-c()
early_species<-c()
mid_species<-c()
late_species<-c()
eg_species<-c()
mg_species<-c()
lg_species<-c()
ee_species<-c()
me_species<-c()
le_species<-c()
for (i in 1:ncol(df_gal)) {
  if (sum(df_gal[,i])>0) {gal_species<-append(gal_species,colnames(df_gal)[i])}
  if (sum(df_exm[,i])>0) {exm_species<-append(exm_species,colnames(df_exm)[i])}
  if (sum(df_open[,i])>0) {open_species<-append(open_species,colnames(df_open)[i])}
  if (sum(df_forest[,i])>0) {forest_species<-append(forest_species,colnames(df_forest)[i])}
  if (sum(df_early[,i])>0) {early_species<-append(early_species,colnames(df_early)[i])}
  if (sum(df_mid[,i])>0) {mid_species<-append(mid_species,colnames(df_mid)[i])}
  if (sum(df_late[,i])>0) {late_species<-append(late_species,colnames(df_late)[i])}
  if (sum(df_eg[,i])>0) {eg_species<-append(eg_species,colnames(df_eg)[i])}
  if (sum(df_mg[,i])>0) {mg_species<-append(mg_species,colnames(df_mg)[i])}
  if (sum(df_lg[,i])>0) {lg_species<-append(lg_species,colnames(df_lg)[i])}
  if (sum(df_ee[,i])>0) {ee_species<-append(ee_species,colnames(df_ee)[i])}
  if (sum(df_me[,i])>0) {me_species<-append(me_species,colnames(df_me)[i])}
  if (sum(df_le[,i])>0) {le_species<-append(le_species,colnames(df_le)[i])}
}
open_uniq<-setdiff(open_species, forest_species)
forest_uniq<-setdiff(forest_species,open_species)


gal_uniq<-setdiff(gal_species, exm_species)
exm_uniq<-setdiff(exm_species,gal_species)

mx<-max(length(open_uniq),length(forest_uniq),length(gal_uniq),length(exm_uniq))


unique<-data.frame("open"=append(open_uniq,rep(0, each=mx-length(open_uniq))),
                   "forest"=append(forest_uniq,rep(0, each=mx-length(forest_uniq))), 
                   "galloway"=append(gal_uniq,rep(0, each=mx-length(gal_uniq))), 
                   "exmoor"=append(exm_uniq,rep(0, each=mx-length(exm_uniq))))

write.csv2(unique, file="COI/Local_analysis/output/tables/unique_arthropods.csv")



#Create Venn diagram


library("ggVennDiagram")

x <- list(
  Galloway = gal_species[which(!grepl("sp.",gal_species,fixed=TRUE))], 
  Exmoor = exm_species[which(!grepl("sp.",exm_species,fixed=TRUE))],
  Open = open_species[which(!grepl("sp.",open_species,fixed=TRUE))],
  Forest = forest_species[which(!grepl("sp.",forest_species,fixed=TRUE))],
  Early = early_species[which(!grepl("sp.",early_species,fixed=TRUE))],
  Mid = mid_species[which(!grepl("sp.",mid_species,fixed=TRUE))],
  Late = late_species[which(!grepl("sp.",late_species,fixed=TRUE))],
  Gal.Early = eg_species[which(!grepl("sp.",eg_species,fixed=TRUE))], 
  Gal.Mid = mg_species[which(!grepl("sp.",mg_species,fixed=TRUE))],
  Gal.Late = lg_species[which(!grepl("sp.",lg_species,fixed=TRUE))],
  Exm.Early = ee_species[which(!grepl("sp.",ee_species,fixed=TRUE))],
  Exm.Mid = me_species[which(!grepl("sp.",me_species,fixed=TRUE))],
  Exm.Late = le_species[which(!grepl("sp.",le_species,fixed=TRUE))]
)


venn1 <- ggVennDiagram(
  x[1:2], label_alpha = 0,
  category.names = c("Galloway","Exmoor"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 20) +
  theme(text=element_text(size=20))

venn1

venn2 <- ggVennDiagram(
  x[3:4], label_alpha = 0,
  category.names = c("Open","Forest"),
  edge_lty = "blank", set_size =8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 30) +
  theme(text=element_text(size=20))

venn2

venn3 <- ggVennDiagram(
  x[5:7], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 10) +
  theme(text = element_text(size=20))

venn3

venn4 <- ggVennDiagram(
  x[8:10], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 10) +
  theme(text = element_text(size=20))

venn4

venn5 <- ggVennDiagram(
  x[11:13], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 8) +
  theme(text = element_text(size=20))

venn5


saveRDS(venn1, file="COI/Local_analysis/output/RDS_files/venn1_arthropods")
saveRDS(venn2, file="COI/Local_analysis/output/RDS_files/venn2_arthropods")
saveRDS(venn3, file="COI/Local_analysis/output/RDS_files/venn3_arthropods")
saveRDS(venn4, file="COI/Local_analysis/output/RDS_files/venn4_arthropods")
saveRDS(venn5, file="COI/Local_analysis/output/RDS_files/venn5_arthropods")



ggarrange(venn1,venn2,venn4,venn5, labels = c("A", "B","C","D","E"), ncol = 4, nrow = 1)
ggsave("COI/Local_analysis/output/plots/venn_diagrams_arthropods.pdf", width=12, height=6)

```

```{r NDMS plots}

#Libraries
library(vegan)
library(dplyr)
library(ggplot2)
library(ggalt)
library(ggpubr)
#library(BiodiversityR)

#Function for inverse normal transformation
inormal <- function(x)
{
  qnorm((rank(x, na.last = "keep") - 0.5) / sum(!is.na(x)))
}

#This step plots CAP and NMDS plots of abundance and presence/absence data
dataset <- readRDS("COI/Local_analysis/output/RDS_files/dataset_final_arthropods")

par(mfrow=c(1,1))

samples<-dataset@samples[,c("source", "habitat","month")]

season_vec=c()
for (i in 1:nrow(samples)) {
  if (samples$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="December") {season_vec<-append(season_vec,"late")}
}
samples<-cbind(samples, "season"=season_vec)

group<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Galloway - EarlyOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - EarlyForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Galloway - MidOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - MidForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Galloway - LateOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - LateForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - EarlyOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - EarlyForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - MidOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - MidForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - LateOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - LateForest")}
}

samples<-cbind(samples,group)


group2<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$habitat[i]=="open") {group2<-append(group2,"Galloway - Open")}
  if (samples$source[i]=="galloway" && samples$habitat[i]=="forest") {group2<-append(group2,"Galloway - Forest")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="open") {group2<-append(group2,"Exmoor - Open")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="forest") {group2<-append(group2,"Exmoor - Forest")}
}


group3<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early") {group3<-append(group3,"Galloway - Early")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid") {group3<-append(group3,"Galloway - Mid")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late") {group3<-append(group3,"Galloway - Late")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early") {group3<-append(group3,"Exmoor - Early")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid") {group3<-append(group3,"Exmoor - Mid")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late") {group3<-append(group3,"Exmoor - Late")}
}




samples<-cbind(samples,group2,group3)

reads<-dataset$reads

#Without outlier
reads<-reads[-which(row.names(reads)=="FEB16"),]
reads<-reads[-which(row.names(reads)=="FEB12"),]
reads<-reads[-which(row.names(reads)=="MAR8"),]
reads<-reads[-which(row.names(reads)=="MAY7"),]

#Evaluate number of dimensions

#mreads<-as.matrix(sqrt(reads))
mreads<-as.matrix(reads) #With or without transformation?
nmds1D = metaMDS(mreads, distance = "bray", k=1)
nmds2D = metaMDS(mreads, distance = "bray", k=2)
nmds3D = metaMDS(mreads, distance = "bray", k=3)
nmds4D = metaMDS(mreads, distance = "bray", k=4)
nmds5D = metaMDS(mreads, distance = "bray", k=5)
nmds20D = metaMDS(mreads, distance = "bray", k=20)

dim<-data.frame("dim"=c(1,2,3,4,5,20),"stress"=c(nmds1D$stress,nmds2D$stress,nmds3D$stress,nmds4D$stress,nmds5D$stress,nmds20D$stress))

plot(dim$dim,dim$stress, main="Stress values in nMDS ordination with increasing numbers of dimensions", cex.main=0.8)
abline(h=0.20, col="red", lty=2)

par(mfrow=c(2,2))
stressplot(nmds1D, main="Stressplot K=1")
stressplot(nmds2D, main="Stressplot K=2")
stressplot(nmds3D, main="Stressplot K=3")
stressplot(nmds4D, main="Stressplot K=4")
stressplot(nmds5D, main="Stressplot K=5")
stressplot(nmds20D, main="Stressplot K=20")


#From stress vs. dimension plot, and stressplots, it seems that 2 dimensions will be appropriate (non-metric fit R2~0.961, stress=0.1975)

reads<-dataset$reads

#Without outlier
reads<-reads[-which(row.names(reads)=="FEB16"),]
reads<-reads[-which(row.names(reads)=="FEB12"),]
reads<-reads[-which(row.names(reads)=="MAR8"),]
reads<-reads[-which(row.names(reads)=="MAY7"),]
samples<-samples[-which(row.names(samples)=="FEB16"),]
samples<-samples[-which(row.names(samples)=="FEB12"),]
samples<-samples[-which(row.names(samples)=="MAR8"),]
samples<-samples[-which(row.names(samples)=="MAY7"),]


#Perform NMDS-plot of reads
mreads<-as.matrix(sqrt(reads))
#mreads<-as.matrix(reads) #With or without transformation?
nmds = metaMDS(mreads, distance = "bray")
nmds.scores = as.data.frame(vegan::scores(nmds))
head(nmds.scores)

nmds.scores$Sample = row.names(samples)
nmds.scores$Source = samples$source
nmds.scores$Habitat = samples$habitat
nmds.scores$Month = samples$month
nmds.scores$Season = samples$season
nmds.scores$Group = samples$group

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("galloway","exmoor","Cattle","Horses")))

nmds.scores$Source[which(nmds.scores$Source=="galloway")]<-"Cattle"
nmds.scores$Source[which(nmds.scores$Source=="exmoor")]<-"Horses"

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("Cattle","Horses")))


gg1<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Source)) +
  scale_color_manual(values=c("darkseagreen4","dodgerblue3")) +
  geom_encircle(aes(fill = Source), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkseagreen4","dodgerblue3")) +
  #annotate("text", x=0, y=1.1, label="All samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label="Stress=0.1937", cex=3) +
  coord_cartesian(xlim=c(-1,1),ylim=c(-1,0.9)) +
  theme_bw()

plot(gg1)


gg2<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Habitat)) +
  scale_color_manual(values=c("darkgreen","gold1","palegreen","darkgoldenrod")) +
  geom_encircle(aes(fill = Habitat), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen","gold1","palegreen","darkgoldenrod")) +
  #annotate("text", x=0, y=1, label="All samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label="Stress=0.1937", cex=3) +
  coord_cartesian(xlim=c(-1,1),ylim=c(-1,0.9)) +
  theme_bw()

plot(gg2)


nmds.scores<-nmds.scores %>%
  dplyr::mutate(Season=factor(Season, levels=c("early","mid","late")))

gg3<-ggplot(nmds.scores[which(nmds.scores$Source=="Cattle"),], aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Season)) +
  scale_color_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  geom_encircle(aes(fill = Season), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  coord_cartesian(xlim=c(-1,1),ylim=c(-1,0.9)) +
  #annotate("text", x=0, y=1.0, label="Galloway samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label="Stress=0.1937", cex=3) +
  theme_bw()

plot(gg3)



gg4<-ggplot(nmds.scores[which(nmds.scores$Source=="Horses"),], aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Season)) +
  scale_color_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  geom_encircle(aes(fill = Season), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  coord_cartesian(xlim=c(-1,1),ylim=c(-1,0.9)) +
  #annotate("text", x=0, y=1, label="Exmoor samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label="Stress=0.1937", cex=3) +
  theme_bw()

plot(gg4)

saveRDS(gg1, file="COI/Local_analysis/output/RDS_files/ggArthroGalExm")
saveRDS(gg2, file="COI/Local_analysis/output/RDS_files/ggArthroOpenForest")
saveRDS(gg3, file="COI/Local_analysis/output/RDS_files/ggArthroGalSeason")
saveRDS(gg4, file="COI/Local_analysis/output/RDS_files/ggArthroExmSeason")

ggarrange(gg1,gg2,gg3,gg4, labels = c("A", "B","C","D"), ncol = 2, nrow = 2)
ggsave("COI/Local_analysis/output/plots/nMDS_COI_arthropods.pdf", width=10, height=8)


#PERMANOVA

#Galloway vs. Exmoor
dist<-vegdist(mreads, method = "bray")

##Test for homogeneity of multivariate variance
#Galloway vs. exmoor
dispersion <- betadisper(dist, group=samples$group)
permutest(dispersion)

#No homogeneity of dispersion between groups, square root transformation applied
#dist.t<-sqrt(dist)
#dispersion <- betadisper(dist.t, group=samples$group)
#permutest(dispersion)




plot(dispersion, hull=FALSE, ellipse=TRUE) ##sd ellipse

perm<-adonis2(dist~source*season*habitat, data=samples, permutations = 999)
perm





#Create RDS with p.values from PERMANOVA

perm.out<-perm

saveRDS(perm.out, file="COI/Local_analysis/output/RDS_files/permanova_output_arthropods")

write.table(perm.out, file="COI/Local_analysis/output/textfiles/permanova_output_COI_arthropods.txt", sep="\t",row.names = TRUE, col.names = TRUE)


```

```{r NDMS plot - summer only}

#Libraries
library(vegan)
library(dplyr)
library(ggplot2)
library(ggalt)
library(ggpubr)
#library(BiodiversityR)

#Function for inverse normal transformation
inormal <- function(x)
{
  qnorm((rank(x, na.last = "keep") - 0.5) / sum(!is.na(x)))
}

#This step plots CAP and NMDS plots of abundance and presence/absence data
dataset <- readRDS("COI/Local_analysis/output/RDS_files/dataset_final_arthropods")

par(mfrow=c(1,1))

samples<-dataset@samples[,c("source", "habitat","month")]

season_vec=c()
for (i in 1:nrow(samples)) {
  if (samples$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="December") {season_vec<-append(season_vec,"late")}
}
samples<-cbind(samples, "season"=season_vec)

group<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Galloway - EarlyOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - EarlyForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Galloway - MidOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - MidForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Galloway - LateOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - LateForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - EarlyOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - EarlyForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - MidOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - MidForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - LateOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - LateForest")}
}

samples<-cbind(samples,group)


group2<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$habitat[i]=="open") {group2<-append(group2,"Galloway - Open")}
  if (samples$source[i]=="galloway" && samples$habitat[i]=="forest") {group2<-append(group2,"Galloway - Forest")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="open") {group2<-append(group2,"Exmoor - Open")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="forest") {group2<-append(group2,"Exmoor - Forest")}
}


group3<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early") {group3<-append(group3,"Galloway - Early")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid") {group3<-append(group3,"Galloway - Mid")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late") {group3<-append(group3,"Galloway - Late")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early") {group3<-append(group3,"Exmoor - Early")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid") {group3<-append(group3,"Exmoor - Mid")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late") {group3<-append(group3,"Exmoor - Late")}
}




samples<-cbind(samples,group2,group3)

reads<-dataset$reads

# Extract summer only
reads <- dataset@reads[which(dataset@samples$season=="summer"),]
samples <- samples[which(dataset@samples$season=="summer"),]


#Evaluate number of dimensions

# mreads<-as.matrix(sqrt(reads))
# #mreads<-as.matrix(reads) #With or without transformation?
# nmds1D = metaMDS(mreads, distance = "bray", k=1)
# nmds2D = metaMDS(mreads, distance = "bray", k=2)
# nmds3D = metaMDS(mreads, distance = "bray", k=3)
# nmds4D = metaMDS(mreads, distance = "bray", k=4)
# nmds5D = metaMDS(mreads, distance = "bray", k=5)
# nmds20D = metaMDS(mreads, distance = "bray", k=20)
# 
# dim<-data.frame("dim"=c(1,2,3,4,5,20),"stress"=c(nmds1D$stress,nmds2D$stress,nmds3D$stress,nmds4D$stress,nmds5D$stress,nmds20D$stress))
# 
# plot(dim$dim,dim$stress, main="Stress values in nMDS ordination with increasing numbers of dimensions", cex.main=0.8)
# abline(h=0.20, col="red", lty=2)
# 
# par(mfrow=c(2,2))
# stressplot(nmds1D, main="Stressplot K=1")
# stressplot(nmds2D, main="Stressplot K=2")
# stressplot(nmds3D, main="Stressplot K=3")
# stressplot(nmds4D, main="Stressplot K=4")
# stressplot(nmds5D, main="Stressplot K=5")
# stressplot(nmds20D, main="Stressplot K=20")


#From stress vs. dimension plot, and stressplots, it seems that 3 dimensions will be appropriate (non-metric fit R2~0.977, stress=0.1523)


#Perform NMDS-plot of reads
mreads<-as.matrix(sqrt(reads))
#mreads<-as.matrix(reads) #With or without transformation?
nmds = metaMDS(mreads, distance = "bray", k=3)
nmds.scores = as.data.frame(vegan::scores(nmds)$sites)
head(nmds.scores)

nmds.scores$Sample = row.names(samples)
nmds.scores$Source = samples$source
nmds.scores$Habitat = samples$habitat
nmds.scores$Month = samples$month
nmds.scores$Season = samples$season
nmds.scores$Group = samples$group

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("galloway","exmoor","Cattle","Horses")))

nmds.scores$Source[which(nmds.scores$Source=="galloway")]<-"Cattle"
nmds.scores$Source[which(nmds.scores$Source=="exmoor")]<-"Horses"

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("Cattle","Horses")))


gg1<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Source)) +
  scale_color_manual(values=c("darkorange","darkred")) +
  geom_encircle(aes(fill = Source), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkorange","darkred")) +
  #annotate("text", x=0, y=1.1, label="All samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label=paste0("3D stress: ",round(nmds$stress,4)), cex=3) +
  coord_cartesian(xlim=c(-1.5,1.2),ylim=c(-1,0.9)) +
  ggtitle("Summer samples only") +
  theme_bw()

plot(gg1)

ggsave(file="COI/Local_analysis/output/plots/Summer_samples_nmds_for_presentation1.png", width = 8, height = 8, dpi=300)

# Extract species scores

nmds.species <- as.data.frame(vegan::scores(nmds)$species)

rownames(nmds.species) <- dataset@motus$final.otu



spec.envfit <- envfit(nmds, mreads, perm = 999)

#Extract significant and most important genera to display


spp.scrs <- as.data.frame(scores(spec.envfit, display = "vectors"))
rownames(spp.scrs) <- dataset@motus$final.otu
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs))


spp.scrs2 <- spp.scrs[which(spec.envfit$vectors$pvals<0.05 & spec.envfit$vectors$r>0.15),]



gg2<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Source), alpha=0.2) +
  scale_color_manual(values=c("darkorange","darkred")) +
  geom_encircle(aes(fill = Source), s_shape = 1, expand = 0,
                alpha = 0.02, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkorange","darkred")) +
  #annotate("text", x=0, y=1.1, label="All samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label=paste0("3D stress: ",round(nmds$stress,4)), cex=3) +
  
  geom_segment(data = spp.scrs2,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "black") +
  geom_text(data = spp.scrs2, aes(x = NMDS1*1.5, y = NMDS2*1.5, label = Species),
            size = 3, position = "jitter") +
  
  coord_cartesian(xlim=c(-1.5,1.2),ylim=c(-1,0.9)) +
  ggtitle("Summer samples only") +
  theme_bw()

plot(gg2)

ggsave(file="COI/Local_analysis/output/plots/Summer_samples_nmds_for_presentation2.png", width = 8, height = 8, dpi=300)

h.pic <- readRDS(file="../RWEU_22_23/COI/SUMMER/CLUSTER1/output/RDS_files/h.pic")
c.pic <- readRDS(file="../RWEU_22_23/COI/SUMMER/CLUSTER1/output/RDS_files/c.pic")

ggpic <- ggplot(nmds.scores) +
  add_phylopic(img=c.pic, x=1, y=1, height=0.05,col="darkorange", fill="darkorange") +
  theme_bw() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid = element_blank())

ggpic

```

```{r NMDS functional types (not used)}


#Libraries
library(vegan)
library(dplyr)
library(ggplot2)
library(ggalt)
library(ggpubr)
#library(BiodiversityR)

#Function for inverse normal transformation
inormal <- function(x)
{
  qnorm((rank(x, na.last = "keep") - 0.5) / sum(!is.na(x)))
}

#This step plots CAP and NMDS plots of abundance and presence/absence data
dataset <- readRDS("COI/Local_analysis/output/RDS_files/dataset_final_arthropods")

par(mfrow=c(1,1))

samples<-dataset@samples[,c("source", "habitat","month")]

season_vec=c()
for (i in 1:nrow(samples)) {
  if (samples$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="December") {season_vec<-append(season_vec,"late")}
}
samples<-cbind(samples, "season"=season_vec)

group<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Galloway - EarlyOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - EarlyForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Galloway - MidOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - MidForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Galloway - LateOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - LateForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - EarlyOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - EarlyForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - MidOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - MidForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - LateOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - LateForest")}
}

samples<-cbind(samples,group)


group2<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$habitat[i]=="open") {group2<-append(group2,"Galloway - Open")}
  if (samples$source[i]=="galloway" && samples$habitat[i]=="forest") {group2<-append(group2,"Galloway - Forest")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="open") {group2<-append(group2,"Exmoor - Open")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="forest") {group2<-append(group2,"Exmoor - Forest")}
}


group3<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early") {group3<-append(group3,"Galloway - Early")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid") {group3<-append(group3,"Galloway - Mid")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late") {group3<-append(group3,"Galloway - Late")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early") {group3<-append(group3,"Exmoor - Early")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid") {group3<-append(group3,"Exmoor - Mid")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late") {group3<-append(group3,"Exmoor - Late")}
}




samples<-cbind(samples,group2,group3)


#Aggregate on functional type

reads<-as.data.frame(dataset$reads)
treads<-as.data.frame(t(reads))
treads$type<-dataset@motus$type
treads_agg<-aggregate(. ~ type, data=treads, FUN=sum)
rownames(treads_agg)<-treads_agg$type
treads_agg<-treads_agg[,-1]
reads<-t(treads_agg)


#Evaluate number of dimensions

mreads<-as.matrix(sqrt(reads))
#mreads<-as.matrix(reads) #With or without transformation?
nmds1D = metaMDS(mreads, distance = "bray", k=1)
nmds2D = metaMDS(mreads, distance = "bray", k=2)
nmds3D = metaMDS(mreads, distance = "bray", k=3)
nmds4D = metaMDS(mreads, distance = "bray", k=4)
nmds5D = metaMDS(mreads, distance = "bray", k=5)


dim<-data.frame("dim"=c(1,2,3,4,5),"stress"=c(nmds1D$stress,nmds2D$stress,nmds3D$stress,nmds4D$stress,nmds5D$stress))

plot(dim$dim,dim$stress, main="Stress values in nMDS ordination with increasing numbers of dimensions", cex.main=0.8)
abline(h=0.20, col="red", lty=2)

par(mfrow=c(2,2))
stressplot(nmds1D, main="Stressplot K=1")
stressplot(nmds2D, main="Stressplot K=2")
stressplot(nmds3D, main="Stressplot K=3")
stressplot(nmds4D, main="Stressplot K=4")
stressplot(nmds5D, main="Stressplot K=5")

#From stress, 2 Dimensions are ok, Stress=0.1892


#Perform NMDS-plot of reads
mreads<-as.matrix(sqrt(reads))
#mreads<-as.matrix(reads) #With or without transformation?
nmds = metaMDS(mreads, distance = "bray")
nmds.scores = as.data.frame(vegan::scores(nmds))
head(nmds.scores)

nmds.scores$Sample = row.names(samples)
nmds.scores$Source = samples$source
nmds.scores$Habitat = samples$habitat
nmds.scores$Month = samples$month
nmds.scores$Season = samples$season
nmds.scores$Group = samples$group

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("galloway","exmoor")))

gg1<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Source)) +
  scale_color_manual(values=c("darkorange","darkred")) +
  geom_encircle(aes(fill = Source), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkorange","darkred")) +
  #annotate("text", x=0, y=1.1, label="All samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=1.6, y=0.8, label="Stress=0.189", cex=3) +
  #coord_cartesian(xlim=c(-1,1),ylim=c(-1,0.9)) +
  theme_bw()

plot(gg1)


gg2<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Habitat)) +
  scale_color_manual(values=c("gold1","darkgreen","palegreen","darkgoldenrod")) +
  geom_encircle(aes(fill = Habitat), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("gold1","darkgreen","palegreen","darkgoldenrod")) +
  #annotate("text", x=0, y=1, label="All samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label="Stress=0.1901", cex=3) +
  #coord_cartesian(xlim=c(-1,1),ylim=c(-1,0.9)) +
  theme_bw()

plot(gg2)


gg3<-ggplot(nmds.scores[which(nmds.scores$Source=="galloway"),], aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Season)) +
  scale_color_manual(values=c("gold2","darkorange3","darkgoldenrod")) +
  geom_encircle(aes(fill = Season), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("gold2","darkorange3","darkgoldenrod")) +
  #coord_cartesian(xlim=c(-1,1),ylim=c(-1,0.9)) +
  #annotate("text", x=0, y=1.0, label="Galloway samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label="Stress=0.1901", cex=3) +
  theme_bw()

plot(gg3)



gg4<-ggplot(nmds.scores[which(nmds.scores$Source=="exmoor"),], aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Season)) +
  scale_color_manual(values=c("lightpink1","red4","red2")) +
  geom_encircle(aes(fill = Season), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("lightpink1","red4","red2")) +
  #coord_cartesian(xlim=c(-1,1),ylim=c(-1,0.9)) +
  #annotate("text", x=0, y=1, label="Exmoor samples - arthropods", cex=3) +
  #annotate("text", x=0, y=0.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=0.6, y=0.8, label="Stress=0.1901", cex=3) +
  theme_bw()

plot(gg4)



```


```{r Model richness}

df<-readRDS("COI/Local_analysis/output/RDS_files/Richness_df_arthropods")

month_vec=c()
for (i in 1:nrow(df)) {
  if (df$month[i]=="January") {month_vec<-append(month_vec,1)} 
  else if (df$month[i]=="February") {month_vec<-append(month_vec,2)} 
  else if (df$month[i]=="March") {month_vec<-append(month_vec,3)}
  else if (df$month[i]=="April") {month_vec<-append(month_vec,4)}
  else if (df$month[i]=="May") {month_vec<-append(month_vec,5)}
  else if (df$month[i]=="June") {month_vec<-append(month_vec,6)}
  else if (df$month[i]=="July") {month_vec<-append(month_vec,7)}
  else if (df$month[i]=="August") {month_vec<-append(month_vec,8)}
  else if (df$month[i]=="September") {month_vec<-append(month_vec,9)}
  else if (df$month[i]=="October") {month_vec<-append(month_vec,10)}
  else if (df$month[i]=="November") {month_vec<-append(month_vec,11)}
  else if (df$month[i]=="December") {month_vec<-append(month_vec,12)}
  
}
season_vec=c()
for (i in 1:nrow(df)) {
  if (df$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (df$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (df$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (df$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (df$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="December") {season_vec<-append(season_vec,"late")}
  
}

df<-cbind(df, "season"=as.factor(season_vec))

levels(df$source)<-droplevels(df$source,"control")

hist(df$Count)

model1.1<-glm(Count~season+source+habitat, family="poisson",data=df)
summary(model1.1)

par(mfrow=c(2,2))
plot(model1.1)

shapiro.test(model1.1[["residuals"]])
hist(model1.1[["residuals"]])

redu1<-glm(Count~source, family="poisson",data=df)

redu2<-glm(Count~season, family="poisson",data=df)

redu3<-glm(Count~habitat, family="poisson",data=df)

redu4<-glm(Count~source+season,family="poisson",data=df)

redu5<-glm(Count~source+habitat, family="poisson",data=df)

redu6<-glm(Count~habitat+season, family="poisson",data=df)

comparison<-anova(model1.1,redu1,redu2,redu3,redu4,redu5,redu6)

library(MASS)
library(spdep)
selection<-MASS::stepAIC(model1.1)
selection

colors = c("red","blue","green")

par(mfrow=c(2,2))
boxplot(Count~source+habitat+season, data=df, col=colors)
boxplot(Count~source, data=df, col=colors)
boxplot(Count~habitat, data=df, col=colors)
boxplot(Count~season+source, data=df, col=colors)

#df_gal<-subset(df, df$source=="galloway")
#df_exm<-subset(df, df$source=="exmoor")


#adding a spatial structure
#Spatial autocorrelation
#See mixed effects model II slides


#Correlograms by spline.correlog

#par(mfrow = c(1, 2), mar = c(5, 5, 2, 0.1))
## Plot correlogram 
#Splcor.SR <- spline.correlog(
#  x = df$lon, y = df$lat, z = df$Count,
#  latlon = T, na.rm = T, npoints = 1000, resamp = 1000, quiet = TRUE
#)
#plot(Splcor.SR, main = "Genera richness", cex = 1.5)
## Plot correlogram of model.3 residuals using the spline.correlog function
#Splcor.model1.1 <- spline.correlog(
#  x = df$lon, y = df$lat, z = residuals(model1.1),
#  latlon = T, na.rm = T, npoints = 1000, resamp = 1000, quiet = TRUE
#)
#plot(Splcor.model1.1, main = "Model1.1 model residuals", cex = 1.5)


#Estimating Moran's I

#m <- knearneigh(as.matrix(df[, c("lon", "lat")]), k = 1, longlat = TRUE)
#n <- knn2nb(m)
#ww <- nb2listw(n, zero.policy = TRUE)
#moran <- moran(df$Count, ww, n = length(ww$neighbours), S0 = Szero(ww))


#Moran.mc <- moran.mc(df$Count, listw = ww, nsim=1000)
#Moran.mc$p.value



## SAR-error model

#m <- knearneigh(as.matrix(df[, c("lon", "lat")]), k = 1, longlat = TRUE)
#n <- knn2nb(m)
#ww <- nb2listw(n, zero.policy = TRUE)
#SAR.Error <- errorsarlm(Count ~ source*month_number, listw = ww, data = df)

#coef(SAR.Error)
#coef(model1.2)

##Spline corellograms

#par(mfrow = c(1, 2), mar = c(5, 5, 2, 0.1))
#Splcor.model1.2 <- spline.correlog(
#  x = df$lon, y = df$lat,
#  z = residuals(model1.2),
#  latlon = TRUE, na.rm = TRUE,
#  npoints = 1000, resamp = 1000,
#  quiet = TRUE
#)
#plot(Splcor.model1.2, main = "Model1.2 model residuals", cex = 1.5)

#Splcor.SAR <- spline.correlog(
#  x = df$lon, y = df$lat,
#  z = residuals(SAR.Error),
#  latlon = TRUE, na.rm = TRUE,
#  npoints = 1000, resamp = 1000,
#  quiet = TRUE
#)
#plot(Splcor.SAR, main = "SAR model residuals", cex = 1.5)


#summary(SAR.Error)

##### RICHNESS #############################################################################

#Test for difference in diet richness between galloway and exmoor in each season
KSo<-kruskal.test(Count~source,data=df)
KSe<-kruskal.test(Count~season,data=df)
KHa<-kruskal.test(Count~habitat,data=df)

RG<-c(mean(df$Count[which(df$source=="galloway")]), std.error(df$Count[which(df$source=="galloway")]))
REx<-c(mean(df$Count[which(df$source=="exmoor")]), std.error(df$Count[which(df$source=="exmoor")]))
RO<-c(mean(df$Count[which(df$habitat=="open")]), std.error(df$Count[which(df$habitat=="open")]))
RF<-c(mean(df$Count[which(df$habitat=="forest")]), std.error(df$Count[which(df$habitat=="forest")]))

## Differences between sources
#Early
EGE<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="early" & df$source=="exmoor")])
# no difference
#Mid
MGE<-wilcox.test(df$Count[which(df$season=="mid" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="exmoor")])
#marginally, but prob. not after corrections
#Late
LGE<-wilcox.test(df$Count[which(df$season=="late" & df$source=="galloway")],df$Count[which(df$season=="late" & df$source=="exmoor")])
#yes, but prob. not after corrections
# MEANS and sd. err
RGE<-c(mean(df$Count[which(df$season=="early" & df$source=="galloway")]), std.error(df$Count[which(df$season=="early" & df$source=="galloway")]))
RGM<-c(mean(df$Count[which(df$season=="mid" & df$source=="galloway")]), std.error(df$Count[which(df$season=="mid" & df$source=="galloway")]))
RGL<-c(mean(df$Count[which(df$season=="late" & df$source=="galloway")]), std.error(df$Count[which(df$season=="late" & df$source=="galloway")]))
REE<-c(mean(df$Count[which(df$season=="early" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="early" & df$source=="exmoor")]))
REM<-c(mean(df$Count[which(df$season=="mid" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="mid" & df$source=="exmoor")]))
REL<-c(mean(df$Count[which(df$season=="late" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="late" & df$source=="exmoor")]))

## Differences between seasons
#Galloway
EMG<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="galloway")])
ELG<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="late" & df$source=="galloway")])
LMG<-wilcox.test(df$Count[which(df$season=="late" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="galloway")])

#Exmoor
EME<-wilcox.test(df$Count[which(df$season=="early" & df$source=="exmoor")],df$Count[which(df$season=="mid" & df$source=="exmoor")])
ELE<-wilcox.test(df$Count[which(df$season=="early" & df$source=="exmoor")],df$Count[which(df$season=="late" & df$source=="exmoor")])
LME<-wilcox.test(df$Count[which(df$season=="late" & df$source=="exmoor")],df$Count[which(df$season=="mid" & df$source=="exmoor")])

#All
EMA<-wilcox.test(df$Count[which(df$season=="early")],df$Count[which(df$season=="mid")])
ELA<-wilcox.test(df$Count[which(df$season=="early")],df$Count[which(df$season=="late")])
LMA<-wilcox.test(df$Count[which(df$season=="late")],df$Count[which(df$season=="mid")])


#Open vs. forest, each source
OFG<-wilcox.test(df$Count[which(df$habitat=="open" & df$source=="galloway")],df$Count[which(df$habitat=="forest" & df$source=="galloway")])
OFE<-wilcox.test(df$Count[which(df$habitat=="open" & df$source=="exmoor")],df$Count[which(df$habitat=="forest" & df$source=="exmoor")])

#Means and sd. err.
RE<-c(mean(df$Count[which(df$season=="early")]), std.error(df$Count[which(df$season=="early")]))
RM<-c(mean(df$Count[which(df$season=="mid")]), std.error(df$Count[which(df$season=="mid")]))
RL<-c(mean(df$Count[which(df$season=="late")]), std.error(df$Count[which(df$season=="late")]))

RGO<-c(mean(df$Count[which(df$habitat=="open" & df$source=="galloway")]), std.error(df$Count[which(df$habitat=="open" & df$source=="galloway")]))
RGF<-c(mean(df$Count[which(df$habitat=="forest" & df$source=="galloway")]), std.error(df$Count[which(df$habitat=="forest" & df$source=="galloway")]))
REO<-c(mean(df$Count[which(df$habitat=="open" & df$source=="exmoor")]), std.error(df$Count[which(df$habitat=="open" & df$source=="exmoor")]))
REF<-c(mean(df$Count[which(df$habitat=="forest" & df$source=="exmoor")]), std.error(df$Count[which(df$habitat=="forest" & df$source=="exmoor")]))

pvals<-data.frame(c(KSo$p.value,KSe$p.value,KHa$p.value,EGE$p.value,MGE$p.value,LGE$p.value,EMG$p.value,ELG$p.value,LMG$p.value,EME$p.value,ELE$p.value,LME$p.value,EMA$p.value,ELA$p.value,LMA$p.value,OFG$p.value,OFE$p.value))
rownames(pvals)<-c("KSo","KSe","KHa","EGE","MGE","LGE","EMG","ELG","LMG","EME","ELE","LME","EMA","ELA","LMA","OFG","OFE")
colnames(pvals)<-"p.value"

holm<-p.adjust(pvals$p.value, method="holm")
pvals<-cbind(pvals,"corrected"=holm)


significant<-c()
for (i in 1:nrow(pvals)) {
  if (pvals$corrected[i]<0.01) {significant<-append(significant, "yes")}
  else if (pvals$corrected[i]<0.05 && pvals$corrected[i]>0.01) {significant<-append(significant, "marginally")}
  else {significant<-append(significant, "no")}
}
pvals<-cbind(pvals, significant)

saveRDS(pvals, "COI/Local_analysis/output/RDS_files/pvals_difference_arthropods")
write.table(pvals,"COI/Local_analysis/output/tables/pvals_difference_arthropods.txt",sep="\t",row.names=TRUE)

means<-c("mean"=c(),"StERR"=c())
means<-rbind(means,RGE,RGM,RGL,REE,REM,REL,RE,RM,RL,RG,REx,RO,RF,RGO,RGF,REO,REF)
colnames(means)<-c("mean","StErr")

saveRDS(means, "COI/Local_analysis/output/RDS_files/means_groups_arthropods")
write.table(means,"COI/Local_analysis/output/tables/means_groups_arthropods.txt",sep="\t",row.names=TRUE)



```


# Try of mvabund and trait GLM with all identifications

```{r Trait glm - first part with running model on cluster}


library(mvabund)
library(dplyr)

### RUNS ON CLUSTER DUE TO MEMORY ISSUES ON LOCAL MACHINE ##############################################################
#
dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final")
#
envs<-data.frame("source"=dataset@samples$source, "season"=dataset@samples$season, "habitat"=dataset@samples$habitat, "month"=dataset@samples$month)
#
envs<-envs %>%
  dplyr::mutate(season=factor(season, levels=c("Early","Mid","Late")))
#
#
envs$season[which(envs$month=="January")]<-"Early"
envs$season[which(envs$month=="February")]<-"Early"
envs$season[which(envs$month=="March")]<-"Early"
envs$season[which(envs$month=="April")]<-"Early"
envs$season[which(envs$month=="May")]<-"Mid"
envs$season[which(envs$month=="June")]<-"Mid"
envs$season[which(envs$month=="July")]<-"Mid"
envs$season[which(envs$month=="August")]<-"Mid"
envs$season[which(envs$month=="September")]<-"Late"
envs$season[which(envs$month=="October")]<-"Late"
envs$season[which(envs$month=="November")]<-"Late"
envs$season[which(envs$month=="December")]<-"Late"
#
traits<-data.frame("order"=dataset@motus$order_name, "dung"=dataset@motus$dung.associated, "type"=dataset@motus$type)
#
traits<-traits %>%
  dplyr::mutate(order=factor(order))
#
traits<-traits %>%
  dplyr::mutate(dung=factor(dung))
#
traits<-traits %>%
  dplyr::mutate(type=factor(type))
#
#
#
abund<-dataset@reads
colnames(abund)<-dataset@motus$final.otu
rownames(abund)<-seq(1:nrow(abund))
abund<-as.data.frame(abund)
abund<-lapply(abund, as.integer)
abund<-as.data.frame(abund)

#
df_list<-list("abund"=abund,"env"=envs, "traits"=traits)

##### Trial with reduced dataset

df_list2<-df_list
df_list2$abund<-df_list2$abund[c(1:30),c(1:41)]
df_list2$env<-df_list2$env[c(1:30),c(1:3)]
df_list2$traits<-df_list2$traits[c(1:41),]



#
## TRAIT glm
#
#
ft=traitglm(df_list2$abund,df_list2$env,df_list2$traits,method="manyglm")

data("antTraits")

ant_ft=traitglm(antTraits$abund,antTraits$env,antTraits$traits,method="manyglm")
#
####################################################################################################################

ft<-readRDS("COI/Local_analysis/input/traitglm_output")

ft$fourth #print fourth corner terms
# for a pretty picture of fourth corner coefficients, uncomment the following lines:
# library(lattice)
# a = max( abs(ft$fourth.corner) )
# colort = colorRampPalette(c("blue","white","red"))
# plot.4th = levelplot(t(as.matrix(ft$fourth.corner)), xlab="Environmental Variables",
# ylab="Species traits", col.regions=colort(100), at=seq(-a, a, length=100),
# scales = list( x= list(rot = 45)))
# print(plot.4th)
plot(ft) # for a Dunn-smyth residual plot
qqnorm(residuals(ft)); abline(c(0,1),col="red") # for a normal quantile plot.
# predict to the first five sites
predict(ft,newR=antTraits$env[1:5,])
# refit using LASSO and less variables, including row effects and only two interaction terms:
ft1=traitglm(antTraits$abund,antTraits$env[,3:4],antTraits$traits[,c(1,3)],
             formula=~Shrub.cover:Femur.length+Shrub.cover:Pilosity,composition=TRUE,method="glm1path")
ft1$fourth #notice LASSO penalty has one interaction to zero


```

# Try of gllvm package

```{r GLLVM - example data}


library(gllvm)
library(dplyr)

## Load a dataset from the mvabund package
library(mvabund)
data(antTraits)
y <- as.matrix(antTraits$abund)
X <- as.matrix(antTraits$env)
TR <- antTraits$traits
# Fit model with environmental covariates Bare.ground and Shrub.cover
fit <- gllvm(y, X, formula = ~ Bare.ground + Shrub.cover,
            family = poisson())
ordiplot(fit)
coefplot(fit)

## Example 1: Fit model with two unconstrained latent variables
# Using variational approximation:
fitv0 <- gllvm(y, family = "negative.binomial", method = "VA")
ordiplot(fitv0)
plot(fitv0, mfrow = c(2,2))
summary(fitv0)
confint(fitv0)

## Example 1a: Fit model with two constrained latent variables and with 
# quadratic response model
# We scale and centre the  predictors to improve convergence
fity1 <- gllvm(y, X = scale(X), family = "negative.binomial", 
              num.lv.c=2, method="VA")
ordiplot(fity1, biplot = TRUE)

# Using Laplace approximation: (this line may take about 30 sec to run)
fitl0 <- gllvm(y, family = "negative.binomial", method = "LA")
ordiplot(fitl0)

## Example 2: gllvm with environmental variables
# Fit model with two latent variables and all environmental covariates,
fitvX <- gllvm(formula = y ~ X, family = "negative.binomial")
ordiplot(fitvX, biplot = TRUE)
coefplot(fitvX)
# Fit model with environmental covariates Bare.ground and Shrub.cover
fitvX2 <- gllvm(y, X, formula = ~ Bare.ground + Shrub.cover,
 family = "negative.binomial")
ordiplot(fitvX2)
coefplot(fitvX2)
# Use 5 initial runs and pick the best one
fitvX_5 <- gllvm(y, X, formula = ~ Bare.ground + Shrub.cover,
 family = "negative.binomial", control.start=list(n.init = 5, jitter.var = 0.1))
ordiplot(fitvX_5)
coefplot(fitvX_5)

## Example 3: Data in long format
# Reshape data to long format:
datalong <- reshape(data.frame(cbind(y,X)), direction = "long",
                   varying = colnames(y), v.names = "y")
head(datalong)
fitvLong <- gllvm(data = datalong, formula = y ~ Bare.ground + Shrub.cover,
               family = "negative.binomial")
ordiplot(fitvLong)
coefplot(fitvLong)

## Example 4: Fourth corner model
# Fit fourth corner model with two latent variables
fitF1 <- gllvm(y = y, X = X, TR = TR, family = "negative.binomial")
coefplot(fitF1)
# Fourth corner can be plotted also with next lines
fourth = fitF1$fourth.corner
library(lattice)
a = max( abs(fourth) )
colort = colorRampPalette(c("navyblue","white","darkgreen"))
plot.4th = levelplot(t(as.matrix(fourth)), xlab = "Environmental Variables",
              ylab = "Species traits", col.regions = colort(100),
              at = seq( -a, a, length = 100), scales = list( x = list(rot = 45)))
print(plot.4th)

# Specify model using formula
fitF2 <- gllvm(y = y, X = X, TR = TR,
 formula = ~ Bare.ground + Canopy.cover * (Pilosity + Webers.length),
 family = "negative.binomial")
ordiplot(fitF2)
coefplot(fitF2)

## Include species specific random slopes to the fourth corner model
fitF3 <- gllvm(y = y, X = X, TR = TR,
 formula = ~ Bare.ground + Canopy.cover * (Pilosity + Webers.length),
 family = "negative.binomial", randomX = ~ Bare.ground + Canopy.cover, 
 control.start = list(n.init = 3))
ordiplot(fitF3)
coefplot(fitF3)

```


```{r Extract all dung associated}

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final")



m=dataset
reads = m@reads
samples = m@samples
motus = m@motus

##Extract all dung associated
dung.idx<-which(m@motus$dung.associated=="yes") 

dung.idx.nema<-which(m@motus$`best_identity:ncbi`>=95 & m@motus$phylum_name=="Nematoda")

dung.idx<-sort(append(dung.idx, dung.idx.nema))




motus<-motus[dung.idx,]
reads<-reads[,dung.idx]
idx.include<-which(rowSums(reads)>0)
reads<-reads[rowSums(reads)>0,]
samples<-samples[idx.include,]

samples<-samples[,-1]
samples<-samples[,-c(26:29)]


m@reads <- reads
m@samples <- samples
m@motus <- motus

dataset = m

total_dung_ass<-sum(reads)

par(mfrow=c(1,2))

mean_sample<-mean(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))
hist(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]), #CHANGE Stream_water
     breaks=50,xlab="Reads",main="Read counts")
sem_sample<-std.error(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))
sd_sample<-sd(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))

hist(log(rowSums(dataset@reads[dataset@samples$samples.DungSamples,])), #CHANGE Stream_water
     breaks=50,xlab="Reads",main="Read counts")


saveRDS(dataset, file="COI/Local_analysis/output/RDS_files/dataset_final_all_dung")

```

```{r Generating richness list for each order}

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_all_dung")


#Generating input df


#Create temporary df with read counts in each sample from metabarcoding file
df_tmp<-data.frame(dataset@reads)
colnames(df_tmp)<-dataset@motus$final.otu
order_list<-dataset@motus$order_name
class_list<-dataset@motus$class_name
phylum_list<-dataset@motus$phylum_name


#Create temporary df to build file with the columns (sample, species, count, totalreads, freq)
df<-data.frame("sample"=c(),"phylum"=c() ,"class"=c(),"order"=c(),"species"=c(),"count"=c())
df<-rbind(df, c(1,1,1,1,1,1))
colnames(df)<-c("sample","phylum","class","order","species", "count")


#Add row to the dataframe for each sample/species combination
for (i in 1:nrow(df_tmp)) {
  for (j in 1:ncol(df_tmp)) {
   if (df_tmp[i,j]!=0) 
     {df<-rbind(df, c(row.names(df_tmp)[i],phylum_list[j],class_list[j],order_list[j],colnames(df_tmp)[j],df_tmp[i,j]))
     } 
  }
}

#Subtract the first row which was only used to keep correct format
df<-df[-1,]

#Change type of columns (sample=factor, count=numeric)
df2<-data.frame("sample"=as.factor(df$sample),"phylum"=df$phylum,"class"=df$class,"order"=df$order, "species"=df$species, "count"=as.numeric(df$count))

##Change unidentified orders to "class unknown order"

## Change order names for higher level classifications

new_orders<-NULL

for (i in 1:length(df2$order)) {
  if(grepl("seq", df2$order[i])==TRUE) {
    new_orders<-append(new_orders, paste(df2$class[i], "unknown order", sep=" "))
  }
  else {
    new_orders<-append(new_orders, df2$order[i])
  }
  }

new_orders2<-NULL

for (i in 1:length(new_orders)) {
  if(grepl("seq", new_orders[i])==TRUE) {
    new_orders2<-append(new_orders2, paste(df2$phylum[i], "unknown order", sep=" "))
  }
  else {
    new_orders2<-append(new_orders2, new_orders[i])
  }
  }

df2$order<-new_orders2


#Calculate total reads in each sample
#Create df with unique sample names and totalreads vector
totalreads1<-data.frame("sample"=as.factor(unique(df2$sample)))
totalreads<-c()

#Add value for total reads in each sample to the sample_count vector
for (sample in unique(df2$sample)) {
  x1<-which(df2$sample==sample)
  x2<-sum(df2$count[x1[1]:x1[length(x1)]])
  totalreads<-append(totalreads, rep(x2, each=length(x1))) #Each total count added as many times as each sample in represented in df2
}

#Add totalreads to df2
df2<-cbind(df2,totalreads)


#Calculate frequency of each species in the sample
freq<-c()

for (i in 1:nrow(df2)) {
  x<-df2$count[i]/df2$totalreads[i]
  freq<-append(freq,x)
  
  
}


#Add to df2
df_raw<-cbind(df2, freq)

#Richness for each order
Samples<-unique(df_raw$sample)
Richness<-list()



for (i in 1:length(Samples)) {
  for (j in unique(df_raw$order[which(df_raw$sample==Samples[i])])) {
    print(paste(i,j, sep="-"))
    df<-as.data.frame(Samples[i])
    colnames(df)<-c("Samples")
    df$"order"<-j
    Count<-sum(df_raw$count[df_raw$sample==Samples[i] & df_raw$order==j] !=0)
    df<-cbind(df, Count)
    Richness<-rbind(Richness, df)
  }
}



Richness<-Richness %>%
  dplyr::mutate(order=factor(order))  

#Re-organize to site-order matrix, with richness of each order as abundance data



Rich2<-matrix(nrow=1,ncol=length(unique(Richness$order)))
Rich2<-as.data.frame(Rich2)
colnames(Rich2)<-unique(Richness$order)

for (i in unique(Richness$Samples)) {
  s<-NULL
  for (j in colnames(Rich2)) {if (sum(which(Richness$Samples==i & Richness$order==j))>0) {s<-append(s, Richness$Count[which(Richness$Samples==i & Richness$order==j)])}
                              else {s<-append(s,0)}
    
  }
  Rich2<-rbind(Rich2,s)
}

#remove first row, which was only used to generate df
Rich2<-Rich2[-1,]
#Set rownames to samplenames
rownames(Rich2)<-unique(Richness$Samples)

#save as RDS
saveRDS(Rich2,file="COI/Local_analysis/output/RDS_files/richness_each_order")

```


# Dung-associated coleoptera


```{r Extract dung associated coleoptera}

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final")



m=dataset
reads = m@reads
samples = m@samples
motus = m@motus

##Extract all nematode hits
dung.idx<-which(m@motus$order_name=="Coleoptera" & m@motus$dung.associated=="yes")

motus<-motus[dung.idx,]
reads<-reads[,dung.idx]
idx.include<-which(rowSums(reads)>0)
reads<-reads[rowSums(reads)>0,]
samples<-samples[idx.include,]

samples<-samples[,-1]
samples<-samples[,-c(26:29)]


m@reads <- reads
m@samples <- samples
m@motus <- motus

dataset = m

total_dung_ass_coleoptera<-sum(reads)

par(mfrow=c(1,2))

mean_sample<-mean(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))
hist(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]), #CHANGE Stream_water
     breaks=50,xlab="Reads",main="Read counts")
sem_sample<-std.error(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))

hist(log(rowSums(dataset@reads[dataset@samples$samples.DungSamples,])), #CHANGE Stream_water
     breaks=50,xlab="Reads",main="Read counts")


saveRDS(dataset, file="COI/Local_analysis/output/RDS_files/dataset_final_coleoptera")

```

```{r Generating input df and create species list with reads}

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_coleoptera")


#Generating input df


#Create temporary df with read counts in each sample from metabarcoding file
df_tmp<-data.frame(dataset@reads)
colnames(df_tmp)<-dataset@motus$final.otu



#Create temporary df to build file with the columns (sample, species, count, totalreads, freq)
df<-data.frame("sample"=c(), "species"=c(),"count"=c())
df<-rbind(df, c(1,1,1))
colnames(df)<-c("sample", "species", "count")


#Add row to the dataframe for each sample/species combination
for (i in 1:nrow(df_tmp)) {
  for (j in 1:ncol(df_tmp)) {
   if (df_tmp[i,j]!=0) 
     {df<-rbind(df, c(row.names(df_tmp)[i],colnames(df_tmp)[j],df_tmp[i,j]))
     } 
  }
}

#Subtract the first row which was only used to keep correct format
df<-df[-1,]

#Change type of columns (sample=factor, count=numeric)
df2<-data.frame("sample"=as.factor(df$sample), "species"=df$species, "count"=as.numeric(df$count))

#Calculate total reads in each sample
#Create df with unique sample names and totalreads vector
totalreads1<-data.frame("sample"=as.factor(unique(df2$sample)))
totalreads<-c()

#Add value for total reads in each sample to the sample_count vector
for (sample in unique(df2$sample)) {
  x1<-which(df2$sample==sample)
  x2<-sum(df2$count[x1[1]:x1[length(x1)]])
  totalreads<-append(totalreads, rep(x2, each=length(x1))) #Each total count added as many times as each sample in represented in df2
}

#Add totalreads to df2
df2<-cbind(df2,totalreads)


#Calculate frequency of each species in the sample
freq<-c()

for (i in 1:nrow(df2)) {
  x<-df2$count[i]/df2$totalreads[i]
  freq<-append(freq,x)
  
  
}


#Add to df2
df2<-cbind(df2, freq)

#Save as RDS

saveRDS(df2, file="COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_coleoptera")



#Generate df with ID and reads

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_coleoptera")

reads<-as.data.frame(dataset@reads)

reads<-t(reads)
otu<-as.character(dataset@motus$final.otu)
kingdom<-as.character(dataset@motus$kingdom_name)
phylum<-as.character(dataset@motus$phylum_name)
class<-as.character(dataset@motus$class_name)
order<-as.character(dataset@motus$order_name)
family<-as.character(dataset@motus$family_name)
genus<-as.character(dataset@motus$genus_name)
species<-as.character(dataset@motus$species_name)
dung<-as.character(dataset@motus$dung.associated)
type<-as.character(dataset@motus$type)
row.names(reads)<-otu

total<-rowSums(reads)

df<-as.data.frame(cbind(reads,total))
df<-as.data.frame(cbind(df,kingdom,phylum,class,order,family,genus))
df<-df[order(df$total, decreasing=TRUE),]

#Save as RDS

saveRDS(df, file="COI/Local_analysis/output/RDS_files/df_species_reads_coleoptera")

#Export list
write.csv2(df,"COI/Local_analysis/output/tables/MOLS2020_COI_coleoptera_ASVs_with_reads.csv", row.names=TRUE)



#Aggregate on genera
df_genera<-aggregate(. ~ genus, data=df[,c(1:140)], FUN=sum)


saveRDS(df_genera, file="COI/Local_analysis/output/RDS_files/df_genera_reads_coleoptera")

#Aggregate on family
df_family<-aggregate(. ~ family, data=df[,c(1:140)], FUN=sum)


saveRDS(df_family, file="COI/Local_analysis/output/RDS_files/df_family_reads_coleoptera")



```

```{r Richness plot and stacked barplot ASVs/species}

#Plotting the richness of sampling time as well as stacked barplot of all sampling times


#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)
library(MetBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
df_raw <- readRDS("COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_coleoptera")

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_coleoptera")


#Remove unidentified ASVs from list for richness calculations - sets count to 0
df_raw2<-df_raw
df_raw2$count[which(grepl("sp.",df_raw$species, fixed=TRUE))]<-0




Samples<-unique(df_raw2$sample)
Richness<-list()

for (i in 1:length(Samples)){
  df<-as.data.frame(Samples[i])
  colnames(df)<-c("Samples")
  Count<-sum(df_raw2$count[df_raw2$sample==Samples[i]] !=0)
  df<-cbind(df, Count)
  Richness<-rbind(Richness,df)
}

Richness<-Richness %>%
  dplyr::mutate(Samples=factor(Samples))  




#Mean richness pr. month - Galloway

Richness<-cbind(Richness, "source"=dataset@samples$source, "month"=dataset@samples$month, "habitat"=dataset@samples$habitat, "lat"=dataset@samples$lat, "lon"=dataset@samples$lon)

Richness<-Richness[order(Richness$month),]

saveRDS(Richness, file="COI/Local_analysis/output/RDS_files/Richness_df_coleoptera")

Richness_gal<-subset(Richness, Richness$source=="galloway")
Richness_exm<-subset(Richness, Richness$source=="exmoor")

#Calculate std error

Gal_agg<-aggregate( . ~ month, data=Richness_gal, std.error)
Exm_agg<-aggregate( . ~ month, data=Richness_exm, std.error)



se_gal<-c(rep(Gal_agg$Count[1], each=7),
          rep(Gal_agg$Count[2], each=9),
          rep(Gal_agg$Count[3], each=1),
          rep(Gal_agg$Count[4], each=2),
          rep(Gal_agg$Count[5], each=5),
          rep(Gal_agg$Count[6], each=10),
          rep(Gal_agg$Count[7], each=7),
          rep(Gal_agg$Count[8], each=7),
          rep(Gal_agg$Count[9], each=5),
          rep(Gal_agg$Count[10], each=5),
          rep(Gal_agg$Count[11], each=10),
          rep(Gal_agg$Count[12], each=10))

se_exm<-c(rep(Exm_agg$Count[1], each=11),
          rep(Exm_agg$Count[2], each=8),
          rep(Exm_agg$Count[3], each=7),
          rep(Exm_agg$Count[4], each=6),
          rep(Exm_agg$Count[5], each=8),
          rep(Exm_agg$Count[6], each=10),
          rep(Exm_agg$Count[7], each=7),
          rep(Exm_agg$Count[8], each=6),
          rep(Exm_agg$Count[9], each=14),
          rep(Exm_agg$Count[10], each=10),
          rep(Exm_agg$Count[11], each=9),
          rep(Exm_agg$Count[12], each=10))

Richness_gal<-cbind(Richness_gal, se_gal)
Richness_exm<-cbind(Richness_exm, se_exm)

Richness_gal[is.na(Richness_gal)]=0
Richness_exm[is.na(Richness_exm)]=0



#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Subtracting the december sample which cannot be used due to lack of replication
Richness_gal<-Richness_gal[-which(Richness_gal$month=="December"),]

#Plotting species richness over time
#Galloway
Species_Richness_gal<-ggplot(Richness_gal, aes(x=factor(month, level=level_order), y=Count, group=1)) +
  geom_point(stat="summary", fun=mean, col="darkorange") +
  geom_errorbar(data=Richness_gal[which(Richness_gal$month!="January" & Richness_gal$month!="February" & Richness_gal$month!="November"),],stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_gal, ymax=Count+se_gal), width=0.5, col="darkorange") +
  #geom_errorbar(stat="summary", data=Richness_gal$Count[which(Richness_gal$month!="December")], aes(x=factor(Richness_gal$month[-which(Richness_gal$month=="December")], level=level_order), ymin=Richness_gal$Count-0.5, ymax=Richness_gal$Count+0.5), width=0.5, fun="mean_se") +
  scale_y_continuous(breaks=c(seq(0, 10, by = 1))) +
  stat_summary(fun=mean, geom="line", col="darkorange") +
  ggtitle("Species richness in cowpats") +
  theme_bw() +
  #coord_cartesian(ylim=c(1,36)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) +
  xlab("Month") +
  ylab("Number of dung-associated coleopteran species")

Species_Richness_gal

#Set level order for plots
#level_order <- c("January","February","April", "June", "August","December") 

level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Exmoor
Species_Richness_exm<-ggplot(Richness_exm, aes(x=factor(month, level=level_order), y=Count, group=1)) + 
  geom_point(stat="summary", fun=mean, col="darkred") +
  geom_errorbar(data=Richness_exm[which(Richness_exm$month!="November"),],stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_exm, ymax=Count+se_exm), width=0.5, col="darkred") +
  #geom_point(stat="identity") +
  scale_y_continuous(breaks=c(seq(0, 6, by = 1))) +
  stat_summary(fun=mean, geom="line", col="darkred") +
  ggtitle("Species richness in horse dung") +
  theme_bw() +
  #coord_cartesian(ylim=c(1,36)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) +
  xlab("Month") +
  ylab("Number of dung-associated coleopteran species")

Species_Richness_exm

level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

dummy<-data.frame("Count"=c(rep(0,each=12)),"month"=level_order)

#Both
Species_Richness<-ggplot(dummy, aes(x=factor(month, level=level_order), y=Count, group=1)) + 
  geom_vline(xintercept="April",colour="white", linetype=2)+
  geom_vline(xintercept=4.5,colour="darkgrey", linetype=2)+
  geom_vline(xintercept=8.5,colour="darkgrey", linetype=2)+
  geom_point(data=Richness_exm, stat="summary", fun=mean, colour="dodgerblue3") +
  geom_errorbar(data=Richness_exm[which(Richness_exm$month!="November"),],stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_exm, ymax=Count+se_exm), width=0.5, col="dodgerblue3") +
  geom_point(data=Richness_gal, stat="summary", fun=mean, colour="darkseagreen4") +
  geom_errorbar(data=Richness_gal[which(Richness_gal$month!="January" & Richness_gal$month!="February" & Richness_gal$month!="November"),],stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_gal, ymax=Count+se_gal), width=0.5, col="darkseagreen4") +
  scale_y_continuous(breaks=c(seq(0,40, by=1))) +
  stat_summary(data=Richness_exm, fun=mean, geom="line", colour="dodgerblue3") +
  stat_summary(data=Richness_gal, fun=mean, geom="line", colour="darkseagreen4") +
  #ggtitle("Species richness - dung associated coleopterans") +
  annotate("text", x=2.5, y=8.5, label="Early season", cex=3.5) +
  annotate("text", x=6.5, y=8.5, label ="Mid season", cex=3.5) +
  annotate("text", x=10.5, y=8.5, label="Late season", cex=3.5) +
  annotate("text", x=2.5, y=8.0, label=" ns.", cex=3.5) +
  annotate("text", x=6.5, y=8.0, label=" ns.", cex=3.5) +
  annotate("text", x=10.5, y=8.0, label=" ns.", cex=3.5) +
  theme_bw() +
  #coord_cartesian(ylim=c(1,40)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=14, hjust = 0.5, face="italic"),axis.text.x = element_text(vjust=0.5,angle = 75, size=14),axis.text.y = element_text(size=12), axis.title.y = element_text(size=14)) +
  xlab("Month") +
  ylab("Species richness")

Species_Richness

ggarrange(Species_Richness, ncol = 1, nrow = 1)
ggsave("COI/Local_analysis/output/plots/SpeciesRichnessBothOneFig_coleoptera.pdf", width=10, height=6)


saveRDS(Species_Richness, file="COI/Local_analysis/output/RDS_files/Species_Richness_coleoptera")

ggarrange(Species_Richness_gal, Species_Richness_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/SpeciesRichnessBoth_coleoptera.pdf", width=14, height=8)

RichnessBoth<-ggarrange(Species_Richness_gal, Species_Richness_exm, labels = c("A", "B"), ncol = 1, nrow = 2)

saveRDS(RichnessBoth, file="COI/Local_analysis/output/RDS_files/RichnessBoth_coleoptera")


#Find most abundant species across all samples

samples.data = read.table("COI/MetaBarFlow/output/Metadata_MOLS2020_invertebrates_corrected_source.txt",
                        header=TRUE,row.names=1,na.strings="NA")



source_vec<-c()
month_vec<-c()

for (i in 1:nrow(df_raw)) {
  sample<-as.character(df_raw$sample[i])
  idx<-which(row.names(samples.data)==sample)
  source_vec<-append(source_vec, as.character(samples.data$source[idx]))
  month_vec<-append(month_vec, as.character(samples.data$month[idx]))
}

source<-as.factor(source_vec)
month<-as.factor(month_vec)

df_raw<-cbind(df_raw, source, month)

df_gal<-subset(df_raw, df_raw$source=="galloway")
df_exm<-subset(df_raw, df_raw$source=="exmoor")

#Galloway
Species<-unique(df_gal$species)
abun<-list()

for (i in 1:length(Species)){
  df<-as.data.frame(Species[i])
  colnames(df)<-c("Species")
  Count<-sum(df_gal$count[df_gal$species==Species[i]])
  df<-cbind(df, Count)
  abun<-rbind(abun, df)
}

abundance<-abun[order(abun$Count),c(1,2)]

#Create vector of 20 most abundant species/ASVs
high_20_gal<-as.character(abundance$Species[(nrow(abundance)-14):(nrow(abundance))])

#Add "Other" as level in the df_raw$species vector
levels(df_gal$species) <- c(levels(df_gal$species),"Other")

#Check if species is in the 20 most abundant - if not, change species to "Other"
for (i in 1:nrow(df_gal)) {
  x<-as.character(df_gal$species[i])
  vec<-grepl(as.character(x), high_20_gal, fixed=TRUE)
  if (sum(vec)==0) {df_gal$species[i]="Other"     }
}


#Rename genus column to Genus
df_gal<-df_gal %>%
  dplyr::rename(Species=species)

#Change order of sampling time
df_gal<-df_gal %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-append(sort(high_20_gal),"Other")


df_gal<-df_gal %>%
  dplyr::mutate(Species=factor(Species, levels=levels))

#Adding 21 color option
nb.cols <- 20
#mycolorsbase<-met.brewer("Redon",nb.cols,type="continuous")
#mycolors <- colorRampPalette(brewer.pal(8, "Pastel2"))(nb.cols)
mycolorsbase <-c("darkolivegreen3","chocolate","brown2","darkolivegreen1","darkseagreen4","brown4","burlywood4","darkolivegreen","burlywood3","darkseagreen1","cornflowerblue","bisque4","chocolate1","yellow","darkorange4","burlywood1","brown","darkred","cyan","burlywood2","chartreuse3","darkkhaki","cadetblue4","goldenrod2","lightpink1","hotpink2","palegreen", "darkblue","darkmagenta","yellowgreen","magenta2","seagreen","mintcream","coral1")
#mycolors<-c('#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4', '#469990', '#dcbeff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#a9a9a9', '#000000')
mycolors<-mycolorsbase[c(3:11,13,15,17:19,22)]
mycolors<-append(mycolors,"black")

#Plotting Galloway
stacked_gal<-ggplot(df_gal, aes(fill=Species, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Proportion of reads")

stacked_gal

#Exmoor
Species<-unique(df_exm$species)
abun<-list()

for (i in 1:length(Species)){
  df<-as.data.frame(Species[i])
  colnames(df)<-c("Species")
  Count<-sum(df_exm$count[df_exm$species==Species[i]])
  df<-cbind(df, Count)
  abun<-rbind(abun, df)
}

abundance<-abun[order(abun$Count),c(1,2)]

#Create vector of 20 most abundant species/ASVs
high_20_exm<-as.character(abundance$Species[(nrow(abundance)-14):(nrow(abundance))])

#Add "Other" as level in the df_raw$species vector
levels(df_exm$species) <- c(levels(df_exm$species),"Other")

#Check if species is in the 20 most abundant - if not, change species to "Other"
for (i in 1:nrow(df_exm)) {
  x<-as.character(df_exm$species[i])
  vec<-grepl(as.character(x), high_20_exm, fixed=TRUE)
  if (sum(vec)==0) {df_exm$species[i]="Other"     }
}


#Rename genus column to Genus
df_exm<-df_exm %>%
  dplyr::rename(Species=species)

#Change order of sampling time
df_exm<-df_exm %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-append(sort(high_20_exm),"Other")


df_exm<-df_exm %>%
  dplyr::mutate(Species=factor(Species, levels=levels))

mycolors<-mycolorsbase[c(1:4,7,9:12,14,16,18:21)]
mycolors<-append(mycolors,"black")

#Plotting Exmoor
stacked_exm<-ggplot(df_exm, aes(fill=Species, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Proportion of reads")


stacked_exm

write.csv(cbind(sort(high_20_exm),sort(high_20_gal)), file="COI/Local_analysis/output/tables/high-15_dung_coleoptera.csv")


ggarrange(stacked_gal,stacked_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothSpecies_coleoptera.pdf", width=18, height=10)


StackedBoth<-ggarrange(stacked_gal,stacked_exm, labels = c("A", "B"), ncol = 1, nrow = 2)

saveRDS(StackedBoth, file="COI/Local_analysis/output/RDS_files/StackedBothSpecies_coleoptera")

#ggsave("Stacked_barplot_all_time.pdf",width=15,height=8.5)

#Aggregate samples by month

gal_month<-aggregate(df_gal, list(Month = df_gal$month, Species = df_gal$Species), FUN=mean)
exm_month<-aggregate(df_exm, list(Month = df_exm$month, Species = df_exm$Species), FUN=mean)

#Remove redundant columns
gal_month<-gal_month[,-c(3:4,6:9)]
exm_month<-exm_month[,-c(3:4,6:9)]

gal_month_20<-gal_month
exm_month_20<-exm_month

#Calculate total reads in each month

jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()
for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {jan<-append(jan, gal_month$count[i])}
  if (gal_month$Month[i]=="February") {feb<-append(feb, gal_month$count[i])}
  if (gal_month$Month[i]=="March") {mar<-append(mar, gal_month$count[i])}
  if (gal_month$Month[i]=="April") {apr<-append(apr, gal_month$count[i])}
  if (gal_month$Month[i]=="May") {may<-append(may, gal_month$count[i])}
  if (gal_month$Month[i]=="June") {jun<-append(jun, gal_month$count[i])}
  if (gal_month$Month[i]=="July") {jul<-append(jul, gal_month$count[i])}
  if (gal_month$Month[i]=="August") {aug<-append(aug, gal_month$count[i])}
  if (gal_month$Month[i]=="September") {sep<-append(sep, gal_month$count[i])}
  if (gal_month$Month[i]=="October") {oct<-append(oct, gal_month$count[i])}
  if (gal_month$Month[i]=="November") {nov<-append(nov, gal_month$count[i])}
  if (gal_month$Month[i]=="December") {dec<-append(dec, gal_month$count[i])}
}
total_each_gal<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(gal_month)))

gal_month<-cbind(gal_month, totalreads)

for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {gal_month$totalreads[i]=total_each_gal[1]}
  if (gal_month$Month[i]=="February") {gal_month$totalreads[i]=total_each_gal[2]}
  if (gal_month$Month[i]=="March") {gal_month$totalreads[i]=total_each_gal[3]}
  if (gal_month$Month[i]=="April") {gal_month$totalreads[i]=total_each_gal[4]}
  if (gal_month$Month[i]=="May") {gal_month$totalreads[i]=total_each_gal[5]}
  if (gal_month$Month[i]=="June") {gal_month$totalreads[i]=total_each_gal[6]}
  if (gal_month$Month[i]=="July") {gal_month$totalreads[i]=total_each_gal[7]}
  if (gal_month$Month[i]=="August") {gal_month$totalreads[i]=total_each_gal[8]}
  if (gal_month$Month[i]=="September") {gal_month$totalreads[i]=total_each_gal[9]}
  if (gal_month$Month[i]=="October") {gal_month$totalreads[i]=total_each_gal[10]}
  if (gal_month$Month[i]=="November") {gal_month$totalreads[i]=total_each_gal[11]}
  if (gal_month$Month[i]=="December") {gal_month$totalreads[i]=total_each_gal[12]}
  }

freq<-c()

for (i in 1:nrow(gal_month)) {
  x<-gal_month$count[i]/gal_month$totalreads[i]
  freq<-append(freq,x)
}

gal_month<-cbind(gal_month, freq)

#And for exmoor ponies


jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {jan<-append(jan, exm_month$count[i])}
  if (exm_month$Month[i]=="February") {feb<-append(feb, exm_month$count[i])}
  if (exm_month$Month[i]=="March") {mar<-append(mar, exm_month$count[i])}
  if (exm_month$Month[i]=="April") {apr<-append(apr, exm_month$count[i])}
  if (exm_month$Month[i]=="May") {may<-append(may, exm_month$count[i])}
  if (exm_month$Month[i]=="June") {jun<-append(jun, exm_month$count[i])}
  if (exm_month$Month[i]=="July") {jul<-append(jul, exm_month$count[i])}
  if (exm_month$Month[i]=="August") {aug<-append(aug, exm_month$count[i])}
  if (exm_month$Month[i]=="September") {sep<-append(sep, exm_month$count[i])}
  if (exm_month$Month[i]=="October") {oct<-append(oct, exm_month$count[i])}
  if (exm_month$Month[i]=="November") {nov<-append(nov, exm_month$count[i])}
  if (exm_month$Month[i]=="December") {dec<-append(dec, exm_month$count[i])}
}
total_each_exm<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(exm_month)))

exm_month<-cbind(exm_month, totalreads)

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {exm_month$totalreads[i]=total_each_exm[1]}
  if (exm_month$Month[i]=="February") {exm_month$totalreads[i]=total_each_exm[2]}
  if (exm_month$Month[i]=="March") {exm_month$totalreads[i]=total_each_exm[3]}
  if (exm_month$Month[i]=="April") {exm_month$totalreads[i]=total_each_exm[4]}
  if (exm_month$Month[i]=="May") {exm_month$totalreads[i]=total_each_exm[5]}
  if (exm_month$Month[i]=="June") {exm_month$totalreads[i]=total_each_exm[6]}
  if (exm_month$Month[i]=="July") {exm_month$totalreads[i]=total_each_exm[7]}
  if (exm_month$Month[i]=="August") {exm_month$totalreads[i]=total_each_exm[8]}
  if (exm_month$Month[i]=="September") {exm_month$totalreads[i]=total_each_exm[9]}
  if (exm_month$Month[i]=="October") {exm_month$totalreads[i]=total_each_exm[10]}
  if (exm_month$Month[i]=="November") {exm_month$totalreads[i]=total_each_exm[11]}
  if (exm_month$Month[i]=="December") {exm_month$totalreads[i]=total_each_exm[12]}
  }

freq<-c()

for (i in 1:nrow(exm_month)) {
  x<-exm_month$count[i]/exm_month$totalreads[i]
  freq<-append(freq,x)
}

exm_month<-cbind(exm_month, freq)

mycolors<-mycolorsbase[c(3:11,13,15,17:19,22)]
mycolors<-append(mycolors,"black")


#Plotting Galloway
stacked_gal_months<-ggplot(gal_month, aes(fill=Species, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Proportion of reads")

stacked_gal_months

mycolors<-mycolorsbase[c(1:4,7,9:12,14,16,18:21)]
mycolors<-append(mycolors,"black")

#Plotting Exmoor
stacked_exm_months<-ggplot(exm_month, aes(fill=Species, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Proportion of reads")

stacked_exm_months

saveRDS(stacked_gal_months, file="COI/Local_analysis/output/RDS_files/stacked_gal_months_coleoptera")
saveRDS(stacked_exm_months, file="COI/Local_analysis/output/RDS_files/stacked_exm_months_coleoptera")


ggarrange(stacked_gal_months, stacked_exm_months, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothMonthsSpecies_coleoptera.pdf", width=14, height=8)


StackedBothMonths<-ggarrange(stacked_gal_months, stacked_exm_months, labels = c("A", "B"), ncol = 1, nrow = 2)

saveRDS(StackedBothMonths, file="COI/Local_analysis/output/RDS_files/StackedBothMonthsSpecies_coleoptera")



```


```{r Stacked barplots functional groups}

#Plotting the richness of sampling time as well as stacked barplot of all sampling times


#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)
library(MetBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_coleoptera")


#Generating input df


#Create temporary df with read counts in each sample from metabarcoding file
df_tmp<-data.frame(dataset@reads)
colnames(df_tmp)<-dataset@motus$type



#Create temporary df to build file with the columns (sample, species, count, totalreads, freq)
df<-data.frame("sample"=c(), "type"=c(),"count"=c())
df<-rbind(df, c(1,1,1))
colnames(df)<-c("sample", "type", "count")


#Add row to the dataframe for each sample/type combination
for (i in 1:nrow(df_tmp)) {
  for (j in 1:ncol(df_tmp)) {
   if (df_tmp[i,j]!=0) 
     {df<-rbind(df, c(row.names(df_tmp)[i],colnames(df_tmp)[j],df_tmp[i,j]))
     } 
  }
}

#Subtract the first row which was only used to keep correct format
df<-df[-1,]

#Change type of columns (sample=factor, count=numeric)
df2<-data.frame("sample"=as.factor(df$sample), "type"=df$type, "count"=as.numeric(df$count))

df2<-data.table::setorder(aggregate(.~sample+type, data=df2, FUN=sum),sample)

#Calculate total reads in each sample
#Create df with unique sample names and totalreads vector
totalreads1<-data.frame("sample"=as.factor(unique(df2$sample)))
totalreads<-c()

#Add value for total reads in each sample to the sample_count vector
for (sample in unique(df2$sample)) {
  x1<-which(df2$sample==sample)
  x2<-sum(df2$count[x1[1]:x1[length(x1)]])
  totalreads<-append(totalreads, rep(x2, each=length(x1))) #Each total count added as many times as each sample in represented in df2
}

#Add totalreads to df2
df2<-cbind(df2,totalreads)


#Calculate frequency of each species in the sample
freq<-c()

for (i in 1:nrow(df2)) {
  x<-df2$count[i]/df2$totalreads[i]
  freq<-append(freq,x)
  
  
}


#Add to df2
df_raw<-cbind(df2, freq)


#Find most abundant species across all samples

samples.data = read.table("COI/MetaBarFlow/output/Metadata_MOLS2020_invertebrates_corrected_source.txt",
                        header=TRUE,row.names=1,na.strings="NA")



source_vec<-c()
month_vec<-c()

for (i in 1:nrow(df_raw)) {
  sample<-as.character(df_raw$sample[i])
  idx<-which(row.names(samples.data)==sample)
  source_vec<-append(source_vec, as.character(samples.data$source[idx]))
  month_vec<-append(month_vec, as.character(samples.data$month[idx]))
}

source<-as.factor(source_vec)
month<-as.factor(month_vec)

df_raw<-cbind(df_raw, source, month)

df_gal<-subset(df_raw, df_raw$source=="galloway")
df_exm<-subset(df_raw, df_raw$source=="exmoor")



#Rename genus column to Genus
df_gal<-df_gal %>%
  dplyr::rename(Type=type)

#Change order of sampling time
df_gal<-df_gal %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-sort(unique(df_gal$Type))


df_gal<-df_gal %>%
  dplyr::mutate(Type=factor(Type, levels=levels))

#Adding 21 color option

nb.cols <- 3
mycolorsbase<-met.brewer("Degas",nb.cols,type="discrete")
mycolors<-mycolorsbase[c(1:10)]

#Plotting Galloway
stacked_gal<-ggplot(df_gal, aes(fill=Type, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Relative frequency")

stacked_gal

#Exmoor

#Rename genus column to Genus
df_exm<-df_exm %>%
  dplyr::rename(Type=type)

#Change order of sampling time
df_exm<-df_exm %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-sort(unique(df_exm$Type))


df_exm<-df_exm %>%
  dplyr::mutate(Type=factor(Type, levels=levels))

#mycolors<-mycolorsbase[c(1:6,9:10)]

#Plotting Exmoor
stacked_exm<-ggplot(df_exm, aes(fill=Type, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Relative frequency")

stacked_exm

ggarrange(stacked_gal,stacked_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothSpecies_coleoptera_functional_types_all_samples.pdf", width=14, height=8)

#Aggregate samples by month

gal_month<-aggregate(df_gal, list(Month = df_gal$month, Type = df_gal$Type), FUN=mean)
exm_month<-aggregate(df_exm, list(Month = df_exm$month, Type = df_exm$Type), FUN=mean)

#Remove redundant columns
gal_month<-gal_month[,-c(3:4,6:9)]
exm_month<-exm_month[,-c(3:4,6:9)]

gal_month_20<-gal_month
exm_month_20<-exm_month

#Calculate total reads in each month

jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()
for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {jan<-append(jan, gal_month$count[i])}
  if (gal_month$Month[i]=="February") {feb<-append(feb, gal_month$count[i])}
  if (gal_month$Month[i]=="March") {mar<-append(mar, gal_month$count[i])}
  if (gal_month$Month[i]=="April") {apr<-append(apr, gal_month$count[i])}
  if (gal_month$Month[i]=="May") {may<-append(may, gal_month$count[i])}
  if (gal_month$Month[i]=="June") {jun<-append(jun, gal_month$count[i])}
  if (gal_month$Month[i]=="July") {jul<-append(jul, gal_month$count[i])}
  if (gal_month$Month[i]=="August") {aug<-append(aug, gal_month$count[i])}
  if (gal_month$Month[i]=="September") {sep<-append(sep, gal_month$count[i])}
  if (gal_month$Month[i]=="October") {oct<-append(oct, gal_month$count[i])}
  if (gal_month$Month[i]=="November") {nov<-append(nov, gal_month$count[i])}
  if (gal_month$Month[i]=="December") {dec<-append(dec, gal_month$count[i])}
}
total_each_gal<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(gal_month)))

gal_month<-cbind(gal_month, totalreads)

for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {gal_month$totalreads[i]=total_each_gal[1]}
  if (gal_month$Month[i]=="February") {gal_month$totalreads[i]=total_each_gal[2]}
  if (gal_month$Month[i]=="March") {gal_month$totalreads[i]=total_each_gal[3]}
  if (gal_month$Month[i]=="April") {gal_month$totalreads[i]=total_each_gal[4]}
  if (gal_month$Month[i]=="May") {gal_month$totalreads[i]=total_each_gal[5]}
  if (gal_month$Month[i]=="June") {gal_month$totalreads[i]=total_each_gal[6]}
  if (gal_month$Month[i]=="July") {gal_month$totalreads[i]=total_each_gal[7]}
  if (gal_month$Month[i]=="August") {gal_month$totalreads[i]=total_each_gal[8]}
  if (gal_month$Month[i]=="September") {gal_month$totalreads[i]=total_each_gal[9]}
  if (gal_month$Month[i]=="October") {gal_month$totalreads[i]=total_each_gal[10]}
  if (gal_month$Month[i]=="November") {gal_month$totalreads[i]=total_each_gal[11]}
  if (gal_month$Month[i]=="December") {gal_month$totalreads[i]=total_each_gal[12]}
  }

freq<-c()

for (i in 1:nrow(gal_month)) {
  x<-gal_month$count[i]/gal_month$totalreads[i]
  freq<-append(freq,x)
}

gal_month<-cbind(gal_month, freq)

#And for exmoor ponies


jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {jan<-append(jan, exm_month$count[i])}
  if (exm_month$Month[i]=="February") {feb<-append(feb, exm_month$count[i])}
  if (exm_month$Month[i]=="March") {mar<-append(mar, exm_month$count[i])}
  if (exm_month$Month[i]=="April") {apr<-append(apr, exm_month$count[i])}
  if (exm_month$Month[i]=="May") {may<-append(may, exm_month$count[i])}
  if (exm_month$Month[i]=="June") {jun<-append(jun, exm_month$count[i])}
  if (exm_month$Month[i]=="July") {jul<-append(jul, exm_month$count[i])}
  if (exm_month$Month[i]=="August") {aug<-append(aug, exm_month$count[i])}
  if (exm_month$Month[i]=="September") {sep<-append(sep, exm_month$count[i])}
  if (exm_month$Month[i]=="October") {oct<-append(oct, exm_month$count[i])}
  if (exm_month$Month[i]=="November") {nov<-append(nov, exm_month$count[i])}
  if (exm_month$Month[i]=="December") {dec<-append(dec, exm_month$count[i])}
}
total_each_exm<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(exm_month)))

exm_month<-cbind(exm_month, totalreads)

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {exm_month$totalreads[i]=total_each_exm[1]}
  if (exm_month$Month[i]=="February") {exm_month$totalreads[i]=total_each_exm[2]}
  if (exm_month$Month[i]=="March") {exm_month$totalreads[i]=total_each_exm[3]}
  if (exm_month$Month[i]=="April") {exm_month$totalreads[i]=total_each_exm[4]}
  if (exm_month$Month[i]=="May") {exm_month$totalreads[i]=total_each_exm[5]}
  if (exm_month$Month[i]=="June") {exm_month$totalreads[i]=total_each_exm[6]}
  if (exm_month$Month[i]=="July") {exm_month$totalreads[i]=total_each_exm[7]}
  if (exm_month$Month[i]=="August") {exm_month$totalreads[i]=total_each_exm[8]}
  if (exm_month$Month[i]=="September") {exm_month$totalreads[i]=total_each_exm[9]}
  if (exm_month$Month[i]=="October") {exm_month$totalreads[i]=total_each_exm[10]}
  if (exm_month$Month[i]=="November") {exm_month$totalreads[i]=total_each_exm[11]}
  if (exm_month$Month[i]=="December") {exm_month$totalreads[i]=total_each_exm[12]}
  }

freq<-c()

for (i in 1:nrow(exm_month)) {
  x<-exm_month$count[i]/exm_month$totalreads[i]
  freq<-append(freq,x)
}

exm_month<-cbind(exm_month, freq)



#Plotting Galloway
stacked_gal_months<-ggplot(gal_month, aes(fill=Type, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Relative frequency")



#Plotting Exmoor
stacked_exm_months<-ggplot(exm_month, aes(fill=Type, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Relative frequency")

saveRDS(stacked_gal_months, file="COI/Local_analysis/output/RDS_files/stacked_gal_months_coleoptera_func")
saveRDS(stacked_exm_months, file="COI/Local_analysis/output/RDS_files/stacked_exm_months_coleoptera_func")



ggarrange(stacked_gal_months, stacked_exm_months, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothMonthsSpecies_coleoptera_functional_types.pdf", width=14, height=8)




```


```{r Find unique species}



#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
df_raw <- readRDS("COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_coleoptera")

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_coleoptera")

#Create season vec

samples<-dataset@samples[,c("source", "habitat","month")]

season_vec=c()
for (i in 1:nrow(samples)) {
  if (samples$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="December") {season_vec<-append(season_vec,"late")}
}


dataset@samples$season<-as.factor(season_vec)

nsamples<-as.data.frame(table(df_raw$species))
colnames(nsamples)<-c("species","freq")

#Remove species only present in fewer than 5 samples
nsamples<-nsamples[which(nsamples$freq>=5),]




df_gal<-dataset@reads[which(dataset@samples$source=="galloway"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_gal)<-nsamples$species
df_exm<-dataset@reads[which(dataset@samples$source=="exmoor"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_exm)<-nsamples$species
df_open<-dataset@reads[which(dataset@samples$habitat=="open"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_open)<-nsamples$species
df_forest<-dataset@reads[which(dataset@samples$habitat=="forest"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_forest)<-nsamples$species
df_early<-dataset@reads[which(dataset@samples$season=="early"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_early)<-nsamples$species
df_mid<-dataset@reads[which(dataset@samples$season=="mid"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_mid)<-nsamples$species
df_late<-dataset@reads[which(dataset@samples$season=="late"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_late)<-nsamples$species
df_eg<-dataset@reads[which(dataset@samples$season=="early" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_eg)<-nsamples$species
df_ee<-dataset@reads[which(dataset@samples$season=="early" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_ee)<-nsamples$species
df_mg<-dataset@reads[which(dataset@samples$season=="mid" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_mg)<-nsamples$species
df_me<-dataset@reads[which(dataset@samples$season=="mid" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_me)<-nsamples$species
df_lg<-dataset@reads[which(dataset@samples$season=="late" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_lg)<-nsamples$species
df_le<-dataset@reads[which(dataset@samples$season=="late" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_le)<-nsamples$species




df_gal_total<-colSums(df_gal)
df_exm_total<-colSums(df_exm)
df_open_total<-colSums(df_open)
df_forest_total<-colSums(df_forest)

GaEx<-data.frame(rbind(df_gal_total,df_exm_total))
colnames(GaEx)<-colnames(df_gal)


skew<-NULL

for (i in 1:ncol(GaEx)) {
  if (GaEx[,i][1]/GaEx[,i][2]<0.1) {skew<-append(skew, "YES: Exm")}
  else if (GaEx[,i][2]/GaEx[,i][1]<0.1) {skew<-append(skew, "YES: Gal")}
  else  {skew<-append(skew, "NO")}
  
  
}

GaEx<-rbind(GaEx,skew)

Skew.df<-data.frame(t(GaEx))


OF<-data.frame(rbind(df_open_total,df_forest_total))
colnames(OF)<-colnames(df_open)


skew<-NULL

for (i in 1:ncol(OF)) {
  if (OF[,i][1]/OF[,i][2]<0.1) {skew<-append(skew, "YES: Forest")}
  else if (OF[,i][2]/OF[,i][1]<0.1) {skew<-append(skew, "YES: Open")}
  else  {skew<-append(skew, "NO")}
  
  
}

OF<-rbind(OF,skew)

Skew.df<-cbind(Skew.df, data.frame(t(OF)))

colnames(Skew.df)<-c("Galloway","Exmoor","Skewed source","Open","Forest","Skewed habitat")


write.table(Skew.df, file="COI/Local_analysis/output/tables/skew_table_coleoptera.txt", sep = "\t")



#Unique species

gal_species<-c()
exm_species<-c()
open_species<-c()
forest_species<-c()
early_species<-c()
mid_species<-c()
late_species<-c()
eg_species<-c()
mg_species<-c()
lg_species<-c()
ee_species<-c()
me_species<-c()
le_species<-c()
for (i in 1:ncol(df_gal)) {
  if (sum(df_gal[,i])>0) {gal_species<-append(gal_species,colnames(df_gal)[i])}
  if (sum(df_exm[,i])>0) {exm_species<-append(exm_species,colnames(df_exm)[i])}
  if (sum(df_open[,i])>0) {open_species<-append(open_species,colnames(df_open)[i])}
  if (sum(df_forest[,i])>0) {forest_species<-append(forest_species,colnames(df_forest)[i])}
  if (sum(df_early[,i])>0) {early_species<-append(early_species,colnames(df_early)[i])}
  if (sum(df_mid[,i])>0) {mid_species<-append(mid_species,colnames(df_mid)[i])}
  if (sum(df_late[,i])>0) {late_species<-append(late_species,colnames(df_late)[i])}
  if (sum(df_eg[,i])>0) {eg_species<-append(eg_species,colnames(df_eg)[i])}
  if (sum(df_mg[,i])>0) {mg_species<-append(mg_species,colnames(df_mg)[i])}
  if (sum(df_lg[,i])>0) {lg_species<-append(lg_species,colnames(df_lg)[i])}
  if (sum(df_ee[,i])>0) {ee_species<-append(ee_species,colnames(df_ee)[i])}
  if (sum(df_me[,i])>0) {me_species<-append(me_species,colnames(df_me)[i])}
  if (sum(df_le[,i])>0) {le_species<-append(le_species,colnames(df_le)[i])}
}
open_uniq<-setdiff(open_species, forest_species)
forest_uniq<-setdiff(forest_species,open_species)


gal_uniq<-setdiff(gal_species, exm_species)
exm_uniq<-setdiff(exm_species,gal_species)

mx<-max(length(open_uniq),length(forest_uniq),length(gal_uniq),length(exm_uniq))


unique<-data.frame("open"=append(open_uniq,rep(0, each=mx-length(open_uniq))),
                   "forest"=append(forest_uniq,rep(0, each=mx-length(forest_uniq))), 
                   "galloway"=append(gal_uniq,rep(0, each=mx-length(gal_uniq))), 
                   "exmoor"=append(exm_uniq,rep(0, each=mx-length(exm_uniq))))

write.csv2(unique, file="COI/Local_analysis/output/tables/unique_coleoptera.csv")



#Create Venn diagram


library("ggVennDiagram")

x <- list(
  Galloway = gal_species[which(!grepl("sp.",gal_species,fixed=TRUE))], 
  Exmoor = exm_species[which(!grepl("sp.",exm_species,fixed=TRUE))],
  Open = open_species[which(!grepl("sp.",open_species,fixed=TRUE))],
  Forest = forest_species[which(!grepl("sp.",forest_species,fixed=TRUE))],
  Early = early_species[which(!grepl("sp.",early_species,fixed=TRUE))],
  Mid = mid_species[which(!grepl("sp.",mid_species,fixed=TRUE))],
  Late = late_species[which(!grepl("sp.",late_species,fixed=TRUE))],
  Gal.Early = eg_species[which(!grepl("sp.",eg_species,fixed=TRUE))], 
  Gal.Mid = mg_species[which(!grepl("sp.",mg_species,fixed=TRUE))],
  Gal.Late = lg_species[which(!grepl("sp.",lg_species,fixed=TRUE))],
  Exm.Early = ee_species[which(!grepl("sp.",ee_species,fixed=TRUE))],
  Exm.Mid = me_species[which(!grepl("sp.",me_species,fixed=TRUE))],
  Exm.Late = le_species[which(!grepl("sp.",le_species,fixed=TRUE))]
)


venn1 <- ggVennDiagram(
  x[1:2], label_alpha = 0,
  category.names = c("Galloway","Exmoor"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 12) +
  theme(text = element_text(size=20))

venn1

venn2 <- ggVennDiagram(
  x[3:4], label_alpha = 0,
  category.names = c("Open","Forest"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 12) +
  theme(text = element_text(size=20))

venn2

venn3 <- ggVennDiagram(
  x[5:7], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 4) +
  theme(text = element_text(size=20))

venn3

venn4 <- ggVennDiagram(
  x[8:10], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 4) +
  theme(text = element_text(size=20))

venn4

venn5 <- ggVennDiagram(
  x[11:13], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 5) +
  theme(text = element_text(size=20))

venn5

saveRDS(venn1, file="COI/Local_analysis/output/RDS_files/venn1_coleoptera")
saveRDS(venn2, file="COI/Local_analysis/output/RDS_files/venn2_coleoptera")
saveRDS(venn3, file="COI/Local_analysis/output/RDS_files/venn3_coleoptera")
saveRDS(venn4, file="COI/Local_analysis/output/RDS_files/venn4_coleoptera")
saveRDS(venn5, file="COI/Local_analysis/output/RDS_files/venn5_coleoptera")


ggarrange(venn1,venn2,venn4,venn5, labels = c("A", "B","C","D","E"), ncol = 4, nrow = 1)
ggsave("COI/Local_analysis/output/plots/venn_diagrams_coleoptera.pdf", width=12, height=6)



```

```{r NDMS plots}

#Libraries
library(vegan)
library(dplyr)
library(ggplot2)
library(ggalt)
library(ggpubr)
#library(BiodiversityR)

#Function for inverse normal transformation
inormal <- function(x)
{
  qnorm((rank(x, na.last = "keep") - 0.5) / sum(!is.na(x)))
}

#This step plots CAP and NMDS plots of abundance and presence/absence data
dataset <- readRDS("COI/Local_analysis/output/RDS_files/dataset_final_coleoptera")

par(mfrow=c(1,1))

samples<-dataset@samples[,c("source", "habitat","month")]

season_vec=c()
for (i in 1:nrow(samples)) {
  if (samples$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="December") {season_vec<-append(season_vec,"late")}
}
samples<-cbind(samples, "season"=season_vec)

group<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Galloway - EarlyOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - EarlyForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Galloway - MidOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - MidForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Galloway - LateOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - LateForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - EarlyOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - EarlyForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - MidOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - MidForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - LateOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - LateForest")}
}

samples<-cbind(samples,group)


group2<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$habitat[i]=="open") {group2<-append(group2,"Galloway - Open")}
  if (samples$source[i]=="galloway" && samples$habitat[i]=="forest") {group2<-append(group2,"Galloway - Forest")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="open") {group2<-append(group2,"Exmoor - Open")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="forest") {group2<-append(group2,"Exmoor - Forest")}
}


group3<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early") {group3<-append(group3,"Galloway - Early")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid") {group3<-append(group3,"Galloway - Mid")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late") {group3<-append(group3,"Galloway - Late")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early") {group3<-append(group3,"Exmoor - Early")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid") {group3<-append(group3,"Exmoor - Mid")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late") {group3<-append(group3,"Exmoor - Late")}
}




samples<-cbind(samples,group2,group3)

reads<-dataset$reads

#Without outlier
#reads<-reads[-which(row.names(reads)=="FEB16"),]
#reads<-reads[-which(row.names(reads)=="MAR8"),]
#reads<-reads[-which(row.names(reads)=="MAY7"),]

#Evaluate number of dimensions

#mreads<-as.matrix(sqrt(reads))
mreads<-as.matrix(reads) #With or without transformation?
nmds1D = metaMDS(mreads, distance = "bray", k=1)
nmds2D = metaMDS(mreads, distance = "bray", k=2)
nmds3D = metaMDS(mreads, distance = "bray", k=3)
nmds4D = metaMDS(mreads, distance = "bray", k=4)
nmds5D = metaMDS(mreads, distance = "bray", k=5)
nmds20D = metaMDS(mreads, distance = "bray", k=20)

dim<-data.frame("dim"=c(1,2,3,4,5,20),"stress"=c(nmds1D$stress,nmds2D$stress,nmds3D$stress,nmds4D$stress,nmds5D$stress,nmds20D$stress))

plot(dim$dim,dim$stress, main="Stress values in nMDS ordination with increasing numbers of dimensions", cex.main=0.8)
abline(h=0.20, col="red", lty=2)

par(mfrow=c(2,2))
stressplot(nmds1D, main="Stressplot K=1")
stressplot(nmds2D, main="Stressplot K=2")
stressplot(nmds3D, main="Stressplot K=3")
stressplot(nmds4D, main="Stressplot K=4")
stressplot(nmds5D, main="Stressplot K=5")
stressplot(nmds20D, main="Stressplot K=20")


#From stress vs. dimension plot, and stressplots, it seems that 2 dimensions will be appropriate 

reads<-dataset$reads

#Without outlier
#reads<-reads[-which(row.names(reads)=="FEB16"),]
#reads<-reads[-which(row.names(reads)=="MAR8"),]
#reads<-reads[-which(row.names(reads)=="MAY7"),]
#samples<-samples[-which(row.names(samples)=="FEB16"),]
#samples<-samples[-which(row.names(samples)=="MAR8"),]
#samples<-samples[-which(row.names(samples)=="MAY7"),]


#Perform NMDS-plot of reads
mreads<-as.matrix(sqrt(reads))
#mreads<-as.matrix(reads) #With or without transformation?
nmds = metaMDS(mreads, distance = "bray")
nmds.scores = as.data.frame(vegan::scores(nmds))
head(nmds.scores)

nmds.scores$Sample = row.names(samples)
nmds.scores$Source = samples$source
nmds.scores$Habitat = samples$habitat
nmds.scores$Month = samples$month
nmds.scores$Season = samples$season
nmds.scores$Group = samples$group

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("galloway","exmoor","Cattle","Horses")))

nmds.scores$Source[which(nmds.scores$Source=="galloway")]<-"Cattle"
nmds.scores$Source[which(nmds.scores$Source=="exmoor")]<-"Horses"

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("Cattle","Horses")))





gg1<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Source)) +
  scale_color_manual(values=c("darkseagreen4","dodgerblue3")) +
  geom_encircle(aes(fill = Source), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkseagreen4","dodgerblue3")) +
  #annotate("text", x=-0.7, y=3.3, label="All samples - coleoptera", cex=3) +
  #annotate("text", x=-0.7, y=3.1, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=-1.5, y=3.5, label="Stress=0.09119", cex=3) +
  coord_cartesian(xlim=c(-2.8,3.6),ylim=c(-2,4)) +
  theme_bw()

plot(gg1)


  
gg2<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Habitat)) +
  scale_color_manual(values=c("darkgreen","gold1","palegreen","darkgoldenrod")) +
  geom_encircle(aes(fill = Habitat), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen","gold1","palegreen","darkgoldenrod")) +
  #annotate("text", x=0, y=3.3, label="All samples - coleoptera", cex=3) +
  #annotate("text", x=0, y=3.1, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=-1.5, y=3.5, label="Stress=0.09119", cex=3) +
  coord_cartesian(xlim=c(-2.8,3.6),ylim=c(-2,4)) +
  theme_bw()

plot(gg2)

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Season=factor(Season, levels=c("early","mid","late")))



gg3<-ggplot(nmds.scores[which(nmds.scores$Source=="Cattle"),], aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Season)) +
  scale_color_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  geom_encircle(aes(fill = Season), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  #annotate("text", x=-0.7, y=3.5, label="Galloway samples - coleoptera", cex=3) +
  #annotate("text", x=-0.7, y=3.3, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=-1.5, y=3.5, label="Stress=0.09119", cex=3) +
  coord_cartesian(xlim=c(-2.8,3.6),ylim=c(-2,4)) +
  theme_bw()

plot(gg3)


gg4<-ggplot(nmds.scores[which(nmds.scores$Source=="Horses"),], aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Season)) +
  scale_color_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  geom_encircle(aes(fill = Season), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  #annotate("text", x=1.5, y=2.8, label="Exmoor samples - coleoptera", cex=3) +
  #annotate("text", x=1.5, y=2.6, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=-1.5, y=3.5, label="Stress=0.09117", cex=3) +
  coord_cartesian(xlim=c(-2.8,3.6),ylim=c(-2,4)) +
  theme_bw()

plot(gg4)


saveRDS(gg1, file="COI/Local_analysis/output/RDS_files/ggColeoGalExm")
saveRDS(gg2, file="COI/Local_analysis/output/RDS_files/ggColeOpenForest")
saveRDS(gg3, file="COI/Local_analysis/output/RDS_files/ggColeGalSeason")
saveRDS(gg4, file="COI/Local_analysis/output/RDS_files/ggColeExmSeason")

ggarrange(gg1,gg2,gg3,gg4, labels = c("A", "B","C","D"), ncol = 2, nrow = 2)
ggsave("COI/Local_analysis/output/plots/nMDS_COI_coleoptera.pdf", width=10, height=8)



#PERMANOVA

#Galloway vs. Exmoor
dist<-vegdist(mreads, method = "bray")

##Test for homogeneity of multivariate variance
#Galloway vs. exmoor
dispersion <- betadisper(dist, group=samples$group)
permutest(dispersion)

#No homogeneity of dispersion between groups, square root transformation applied
#dist.t<-sqrt(dist)
#dispersion <- betadisper(dist.t, group=samples$group)
#permutest(dispersion)




plot(dispersion, hull=FALSE, ellipse=TRUE) ##sd ellipse

perm<-adonis2(dist~source*season*habitat, data=samples, permutations = 999)
perm





#Create RDS with p.values from PERMANOVA

perm.out<-perm

saveRDS(perm.out, file="COI/Local_analysis/output/RDS_files/permanova_output_coleoptera")

write.table(perm.out, file="COI/Local_analysis/output/textfiles/permanova_output_COI_coleoptera.txt", sep="\t",row.names = TRUE, col.names = TRUE)


```

```{r Model richness}

df<-readRDS("COI/Local_analysis/output/RDS_files/Richness_df_coleoptera")

month_vec=c()
for (i in 1:nrow(df)) {
  if (df$month[i]=="January") {month_vec<-append(month_vec,1)} 
  else if (df$month[i]=="February") {month_vec<-append(month_vec,2)} 
  else if (df$month[i]=="March") {month_vec<-append(month_vec,3)}
  else if (df$month[i]=="April") {month_vec<-append(month_vec,4)}
  else if (df$month[i]=="May") {month_vec<-append(month_vec,5)}
  else if (df$month[i]=="June") {month_vec<-append(month_vec,6)}
  else if (df$month[i]=="July") {month_vec<-append(month_vec,7)}
  else if (df$month[i]=="August") {month_vec<-append(month_vec,8)}
  else if (df$month[i]=="September") {month_vec<-append(month_vec,9)}
  else if (df$month[i]=="October") {month_vec<-append(month_vec,10)}
  else if (df$month[i]=="November") {month_vec<-append(month_vec,11)}
  else if (df$month[i]=="December") {month_vec<-append(month_vec,12)}
  
}
season_vec=c()
for (i in 1:nrow(df)) {
  if (df$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (df$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (df$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (df$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (df$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="December") {season_vec<-append(season_vec,"late")}
  
}

df<-cbind(df, "season"=as.factor(season_vec))

levels(df$source)<-droplevels(df$source,"control")

hist(df$Count)

model1.1<-glm(Count~season*source*habitat, family="poisson",data=df)
summary(model1.1)

par(mfrow=c(2,2))
plot(model1.1)


redu1<-glm(Count~source, family="poisson",data=df)

redu2<-glm(Count~season, family="poisson",data=df)

redu3<-glm(Count~habitat, family="poisson",data=df)

redu4<-glm(Count~source+season,family="poisson",data=df)

redu5<-glm(Count~source+habitat, family="poisson",data=df)

redu6<-glm(Count~habitat+season, family="poisson",data=df)

comparison<-anova(model1.1,redu1,redu2,redu3,redu4,redu5,redu6)

library(MASS)
library(spdep)
selection<-MASS::stepAIC(model1.1)
selection

colors = c("red","blue","green")

par(mfrow=c(2,2))
boxplot(Count~source+habitat+season, data=df, col=colors)
boxplot(Count~source, data=df, col=colors)
boxplot(Count~habitat, data=df, col=colors)
boxplot(Count~season+source, data=df, col=colors)

#df_gal<-subset(df, df$source=="galloway")
#df_exm<-subset(df, df$source=="exmoor")


#adding a spatial structure
#Spatial autocorrelation
#See mixed effects model II slides


#Correlograms by spline.correlog

#par(mfrow = c(1, 2), mar = c(5, 5, 2, 0.1))
## Plot correlogram 
#Splcor.SR <- spline.correlog(
#  x = df$lon, y = df$lat, z = df$Count,
#  latlon = T, na.rm = T, npoints = 1000, resamp = 1000, quiet = TRUE
#)
#plot(Splcor.SR, main = "Genera richness", cex = 1.5)
## Plot correlogram of model.3 residuals using the spline.correlog function
#Splcor.model1.1 <- spline.correlog(
#  x = df$lon, y = df$lat, z = residuals(model1.1),
#  latlon = T, na.rm = T, npoints = 1000, resamp = 1000, quiet = TRUE
#)
#plot(Splcor.model1.1, main = "Model1.1 model residuals", cex = 1.5)


#Estimating Moran's I

#m <- knearneigh(as.matrix(df[, c("lon", "lat")]), k = 1, longlat = TRUE)
#n <- knn2nb(m)
#ww <- nb2listw(n, zero.policy = TRUE)
#moran <- moran(df$Count, ww, n = length(ww$neighbours), S0 = Szero(ww))


#Moran.mc <- moran.mc(df$Count, listw = ww, nsim=1000)
#Moran.mc$p.value



## SAR-error model

#m <- knearneigh(as.matrix(df[, c("lon", "lat")]), k = 1, longlat = TRUE)
#n <- knn2nb(m)
#ww <- nb2listw(n, zero.policy = TRUE)
#SAR.Error <- errorsarlm(Count ~ source*month_number, listw = ww, data = df)

#coef(SAR.Error)
#coef(model1.2)

##Spline corellograms

#par(mfrow = c(1, 2), mar = c(5, 5, 2, 0.1))
#Splcor.model1.2 <- spline.correlog(
#  x = df$lon, y = df$lat,
#  z = residuals(model1.2),
#  latlon = TRUE, na.rm = TRUE,
#  npoints = 1000, resamp = 1000,
#  quiet = TRUE
#)
#plot(Splcor.model1.2, main = "Model1.2 model residuals", cex = 1.5)

#Splcor.SAR <- spline.correlog(
#  x = df$lon, y = df$lat,
#  z = residuals(SAR.Error),
#  latlon = TRUE, na.rm = TRUE,
#  npoints = 1000, resamp = 1000,
#  quiet = TRUE
#)
#plot(Splcor.SAR, main = "SAR model residuals", cex = 1.5)


#summary(SAR.Error)

##### DIET RICHNESS #############################################################################

#Test for difference in diet richness between galloway and exmoor in each season
t1<-kruskal.test(Count~source,data=df)
t2<-kruskal.test(Count~season,data=df)
t3<-kruskal.test(Count~habitat,data=df)

RG<-c(mean(df$Count[which(df$source=="galloway")]), std.error(df$Count[which(df$source=="galloway")]))
REx<-c(mean(df$Count[which(df$source=="exmoor")]), std.error(df$Count[which(df$source=="exmoor")]))
RO<-c(mean(df$Count[which(df$habitat=="open")]), std.error(df$Count[which(df$habitat=="open")]))
RF<-c(mean(df$Count[which(df$habitat=="forest")]), std.error(df$Count[which(df$habitat=="forest")]))

## Differences between sources
#Early
t4<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="early" & df$source=="exmoor")])
# no difference
#Mid
t5<-wilcox.test(df$Count[which(df$season=="mid" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="exmoor")])
#marginally, but prob. not after corrections
#Late
t6<-wilcox.test(df$Count[which(df$season=="late" & df$source=="galloway")],df$Count[which(df$season=="late" & df$source=="exmoor")])
#yes, but prob. not after corrections
# MEANS and sd. err
RGE<-c(mean(df$Count[which(df$season=="early" & df$source=="galloway")]), std.error(df$Count[which(df$season=="early" & df$source=="galloway")]))
RGM<-c(mean(df$Count[which(df$season=="mid" & df$source=="galloway")]), std.error(df$Count[which(df$season=="mid" & df$source=="galloway")]))
RGL<-c(mean(df$Count[which(df$season=="late" & df$source=="galloway")]), std.error(df$Count[which(df$season=="late" & df$source=="galloway")]))
REE<-c(mean(df$Count[which(df$season=="early" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="early" & df$source=="exmoor")]))
REM<-c(mean(df$Count[which(df$season=="mid" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="mid" & df$source=="exmoor")]))
REL<-c(mean(df$Count[which(df$season=="late" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="late" & df$source=="exmoor")]))

## Differences between seasons
#Galloway
t7<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="galloway")])
t8<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="late" & df$source=="galloway")])
t9<-wilcox.test(df$Count[which(df$season=="late" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="galloway")])

#Exmoor
t10<-wilcox.test(df$Count[which(df$season=="early" & df$source=="exmoor")],df$Count[which(df$season=="mid" & df$source=="exmoor")])
t11<-wilcox.test(df$Count[which(df$season=="early" & df$source=="exmoor")],df$Count[which(df$season=="late" & df$source=="exmoor")])
t12<-wilcox.test(df$Count[which(df$season=="late" & df$source=="exmoor")],df$Count[which(df$season=="mid" & df$source=="exmoor")])

#All
t13<-wilcox.test(df$Count[which(df$season=="early")],df$Count[which(df$season=="mid")])
t14<-wilcox.test(df$Count[which(df$season=="early")],df$Count[which(df$season=="late")])
t15<-wilcox.test(df$Count[which(df$season=="late")],df$Count[which(df$season=="mid")])


#Open vs. forest, each source
t16<-wilcox.test(df$Count[which(df$habitat=="open" & df$source=="galloway")],df$Count[which(df$habitat=="forest" & df$source=="galloway")])
t17<-wilcox.test(df$Count[which(df$habitat=="open" & df$source=="exmoor")],df$Count[which(df$habitat=="forest" & df$source=="exmoor")])

#Means and sd. err.
RE<-c(mean(df$Count[which(df$season=="early")]), std.error(df$Count[which(df$season=="early")]))
RM<-c(mean(df$Count[which(df$season=="mid")]), std.error(df$Count[which(df$season=="mid")]))
RL<-c(mean(df$Count[which(df$season=="late")]), std.error(df$Count[which(df$season=="late")]))

RGO<-c(mean(df$Count[which(df$habitat=="open" & df$source=="galloway")]), std.error(df$Count[which(df$habitat=="open" & df$source=="galloway")]))
RGF<-c(mean(df$Count[which(df$habitat=="forest" & df$source=="galloway")]), std.error(df$Count[which(df$habitat=="forest" & df$source=="galloway")]))
REO<-c(mean(df$Count[which(df$habitat=="open" & df$source=="exmoor")]), std.error(df$Count[which(df$habitat=="open" & df$source=="exmoor")]))
REF<-c(mean(df$Count[which(df$habitat=="forest" & df$source=="exmoor")]), std.error(df$Count[which(df$habitat=="forest" & df$source=="exmoor")]))

pvals<-data.frame(c(t1$p.value,t2$p.value,t3$p.value,t4$p.value,t5$p.value,t6$p.value,t7$p.value,t8$p.value,t9$p.value,t10$p.value,t11$p.value,t12$p.value,t13$p.value,t14$p.value,t15$p.value,t16$p.value,t17$p.value))
rownames(pvals)<-c("t1","t2","t3","t4","t5","t6","t7","t8","t9","t10","t11","t12","t13","t14","t15","t16","t17")
colnames(pvals)<-"p.value"

holm<-p.adjust(pvals$p.value, method="holm")
pvals<-cbind(pvals,"corrected"=holm)


significant<-c()
for (i in 1:nrow(pvals)) {
  if (pvals$corrected[i]<0.01) {significant<-append(significant, "yes")}
  else if (pvals$corrected[i]<0.05 && pvals$corrected[i]>0.01) {significant<-append(significant, "marginally")}
  else {significant<-append(significant, "no")}
}
pvals<-cbind(pvals, significant)

saveRDS(pvals, "COI/Local_analysis/output/RDS_files/pvals_difference_coleoptera")
write.table(pvals,"COI/Local_analysis/output/tables/pvals_difference_coleoptera.txt",sep="\t",row.names=TRUE)

means<-c("mean"=c(),"StERR"=c())
means<-rbind(means,RGE,RGM,RGL,REE,REM,REL,RE,RM,RL,RG,REx,RO,RF,RGO,RGF,REO,REF)
colnames(means)<-c("mean","StErr")

saveRDS(means, "COI/Local_analysis/output/RDS_files/means_groups_coleoptera")
write.table(means,"COI/Local_analysis/output/tables/means_groups_coleoptera.txt",sep="\t",row.names=TRUE)



```

# Dung-associated diptera


```{r Extract dung associated diptera}

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final")



m=dataset
reads = m@reads
samples = m@samples
motus = m@motus

##Extract all nematode hits
dung.idx<-which(m@motus$order_name=="Diptera" & m@motus$dung.associated=="yes")

motus<-motus[dung.idx,]
reads<-reads[,dung.idx]
idx.include<-which(rowSums(reads)>0)
reads<-reads[rowSums(reads)>0,]
samples<-samples[idx.include,]

samples<-samples[,-1]
samples<-samples[,-c(26:29)]


m@reads <- reads
m@samples <- samples
m@motus <- motus

dataset = m

total_dung_ass_diptera<-sum(reads)

par(mfrow=c(1,2))

mean_sample<-mean(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))
hist(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]), #CHANGE Stream_water
     breaks=50,xlab="Reads",main="Read counts")
sem_sample<-std.error(rowSums(dataset@reads[dataset@samples$samples.DungSamples,]))

hist(log(rowSums(dataset@reads[dataset@samples$samples.DungSamples,])), #CHANGE Stream_water
     breaks=50,xlab="Reads",main="Read counts")


saveRDS(dataset, file="COI/Local_analysis/output/RDS_files/dataset_final_diptera")

```

```{r Generating input df and create species list with reads}

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_diptera")


#Generating input df


#Create temporary df with read counts in each sample from metabarcoding file
df_tmp<-data.frame(dataset@reads)
colnames(df_tmp)<-dataset@motus$final.otu



#Create temporary df to build file with the columns (sample, species, count, totalreads, freq)
df<-data.frame("sample"=c(), "species"=c(),"count"=c())
df<-rbind(df, c(1,1,1))
colnames(df)<-c("sample", "species", "count")


#Add row to the dataframe for each sample/species combination
for (i in 1:nrow(df_tmp)) {
  for (j in 1:ncol(df_tmp)) {
   if (df_tmp[i,j]!=0) 
     {df<-rbind(df, c(row.names(df_tmp)[i],colnames(df_tmp)[j],df_tmp[i,j]))
     } 
  }
}

#Subtract the first row which was only used to keep correct format
df<-df[-1,]

#Change type of columns (sample=factor, count=numeric)
df2<-data.frame("sample"=as.factor(df$sample), "species"=df$species, "count"=as.numeric(df$count))

#Calculate total reads in each sample
#Create df with unique sample names and totalreads vector
totalreads1<-data.frame("sample"=as.factor(unique(df2$sample)))
totalreads<-c()

#Add value for total reads in each sample to the sample_count vector
for (sample in unique(df2$sample)) {
  x1<-which(df2$sample==sample)
  x2<-sum(df2$count[x1[1]:x1[length(x1)]])
  totalreads<-append(totalreads, rep(x2, each=length(x1))) #Each total count added as many times as each sample in represented in df2
}

#Add totalreads to df2
df2<-cbind(df2,totalreads)


#Calculate frequency of each species in the sample
freq<-c()

for (i in 1:nrow(df2)) {
  x<-df2$count[i]/df2$totalreads[i]
  freq<-append(freq,x)
  
  
}


#Add to df2
df2<-cbind(df2, freq)

#Save as RDS

saveRDS(df2, file="COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_diptera")



#Generate df with ID and reads

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_diptera")

reads<-as.data.frame(dataset@reads)

reads<-t(reads)
otu<-as.character(dataset@motus$final.otu)
kingdom<-as.character(dataset@motus$kingdom_name)
phylum<-as.character(dataset@motus$phylum_name)
class<-as.character(dataset@motus$class_name)
order<-as.character(dataset@motus$order_name)
family<-as.character(dataset@motus$family_name)
genus<-as.character(dataset@motus$genus_name)
species<-as.character(dataset@motus$species_name)
dung<-as.character(dataset@motus$dung.associated)
type<-as.character(dataset@motus$type)
row.names(reads)<-otu

total<-rowSums(reads)

df<-as.data.frame(cbind(reads,total))
df<-as.data.frame(cbind(df,kingdom,phylum,class,order,family,genus))
df<-df[order(df$total, decreasing=TRUE),]

#Save as RDS

saveRDS(df, file="COI/Local_analysis/output/RDS_files/df_species_reads_diptera")

#Export list
write.csv2(df,"COI/Local_analysis/output/tables/MOLS2020_COI_diptera_ASVs_with_reads.csv", row.names=TRUE)



#Aggregate on genera
df_genera<-aggregate(. ~ genus, data=df[,c(1:140)], FUN=sum)


saveRDS(df_genera, file="COI/Local_analysis/output/RDS_files/df_genera_reads_diptera")

#Aggregate on family
df_family<-aggregate(. ~ family, data=df[,c(1:140)], FUN=sum)


saveRDS(df_family, file="COI/Local_analysis/output/RDS_files/df_family_reads_diptera")



```

```{r Richness plot and stacked barplot ASVs/species}

#Plotting the richness of sampling time as well as stacked barplot of all sampling times


#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)
library(MetBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
df_raw <- readRDS("COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_diptera")

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_diptera")


#Remove unidentified ASVs from list for richness calculations - sets count to 0
df_raw2<-df_raw
df_raw2$count[which(grepl("Diptera",df_raw$species, fixed=TRUE))]<-0




Samples<-unique(df_raw2$sample)
Richness<-list()

for (i in 1:length(Samples)){
  df<-as.data.frame(Samples[i])
  colnames(df)<-c("Samples")
  Count<-sum(df_raw2$count[df_raw2$sample==Samples[i]] !=0)
  df<-cbind(df, Count)
  Richness<-rbind(Richness, df)
}

Richness<-Richness %>%
  dplyr::mutate(Samples=factor(Samples))  




#Mean richness pr. month - Galloway

Richness<-cbind(Richness, "source"=dataset@samples$source, "month"=dataset@samples$month, "habitat"=dataset@samples$habitat, "lat"=dataset@samples$lat, "lon"=dataset@samples$lon)

Richness<-Richness[order(Richness$month),]

saveRDS(Richness, file="COI/Local_analysis/output/RDS_files/Richness_df_diptera")

Richness_gal<-subset(Richness, Richness$source=="galloway")
Richness_exm<-subset(Richness, Richness$source=="exmoor")

#Calculate std error

Gal_agg<-aggregate( . ~ month, data=Richness_gal, std.error)
Exm_agg<-aggregate( . ~ month, data=Richness_exm, std.error)


se_gal<-c(rep(Gal_agg$Count[1], each=7),
          rep(Gal_agg$Count[2], each=9),
          rep(Gal_agg$Count[3], each=10),
          rep(Gal_agg$Count[4], each=4),
          rep(Gal_agg$Count[5], each=5),
          rep(Gal_agg$Count[6], each=10),
          rep(Gal_agg$Count[7], each=9),
          rep(Gal_agg$Count[8], each=9),
          rep(Gal_agg$Count[9], each=5),
          rep(Gal_agg$Count[10], each=9),
          rep(Gal_agg$Count[11], each=10),
          rep(Gal_agg$Count[12], each=10))

se_exm<-c(rep(Exm_agg$Count[1], each=6),
          rep(Exm_agg$Count[2], each=9),
          rep(Exm_agg$Count[3], each=9),
          rep(Exm_agg$Count[4], each=8),
          rep(Exm_agg$Count[5], each=5),
          rep(Exm_agg$Count[6], each=10),
          rep(Exm_agg$Count[7], each=9),
          rep(Exm_agg$Count[8], each=4),
          rep(Exm_agg$Count[9], each=14),
          rep(Exm_agg$Count[10], each=7),
          rep(Exm_agg$Count[11], each=8),
          rep(Exm_agg$Count[12], each=8))

Richness_gal<-cbind(Richness_gal, se_gal)
Richness_exm<-cbind(Richness_exm, se_exm)

Richness_gal[is.na(Richness_gal)]=0
Richness_exm[is.na(Richness_exm)]=0



#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Plotting species richness over time
#Galloway
Species_Richness_gal<-ggplot(Richness_gal, aes(x=factor(month, level=level_order), y=Count, group=1)) +
  geom_point(stat="summary", fun=mean, col="darkorange") +
  geom_errorbar(data=Richness_gal[which(Richness_gal$month!="January" & Richness_gal$month!="February"),],stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_gal, ymax=Count+se_gal), width=0.5, col="darkorange") +
  scale_y_continuous(breaks=c(seq(0, 36, by = 2))) +
  stat_summary(fun=mean, geom="line", col="darkorange") +
  ggtitle("Species richness in cowpats") +
  theme_bw() +
  #coord_cartesian(ylim=c(1,36)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) +
  xlab("Month") +
  ylab("Number of dung-associated dipteran species")

Species_Richness_gal

#Set level order for plots
#level_order <- c("January","February","April", "June", "August","December") 

level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Exmoor
Species_Richness_exm<-ggplot(Richness_exm, aes(x=factor(month, level=level_order), y=Count, group=1)) + 
  geom_point(stat="summary", fun=mean, col="darkred") +
  geom_errorbar(data=Richness_exm[which(Richness_exm$month!="April"),],stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_exm, ymax=Count+se_exm), width=0.5, col="darkred") +
  scale_y_continuous(breaks=c(seq(0, 36, by = 2))) +
  stat_summary(fun=mean, geom="line", col="darkred") +
  ggtitle("Species richness in horse dung") +
  theme_bw() +
  #coord_cartesian(ylim=c(1,36)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(hjust = 0.5)) +
  xlab("Month") +
  ylab("Number of dung-associated dipteran species")

Species_Richness_exm

level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

dummy<-data.frame("Count"=c(rep(0,each=12)),"month"=level_order)

#Both
Species_Richness<-ggplot(dummy, aes(x=factor(month, level=level_order), y=Count, group=1)) + 
  geom_vline(xintercept="April",colour="white", linetype=2)+
  geom_vline(xintercept=4.5,colour="darkgrey", linetype=2)+
  geom_vline(xintercept=8.5,colour="darkgrey", linetype=2)+
  geom_point(data=Richness_exm, stat="summary", fun=mean, colour="dodgerblue3") +
  geom_errorbar(data=Richness_exm[which(Richness_exm$month!="April"),],stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_exm, ymax=Count+se_exm), width=0.5, col="dodgerblue3") +
  geom_point(data=Richness_gal, stat="summary", fun=mean, colour="darkseagreen4") +
  geom_errorbar(data=Richness_gal[which(Richness_gal$month!="January" & Richness_gal$month!="February"),],stat="summary", aes(x=factor(month, level=level_order), ymin=Count-se_gal, ymax=Count+se_gal), width=0.5, col="darkseagreen4") +
  scale_y_continuous(breaks=c(seq(0,16, by=1))) +
  stat_summary(data=Richness_exm, fun=mean, geom="line", colour="dodgerblue3") +
  stat_summary(data=Richness_gal, fun=mean, geom="line", colour="darkseagreen4") +
  #ggtitle("Species richness - dung associated dipterans") +
  annotate("text", x=2.5, y=13.5, label="Early season", cex=3.5) +
  annotate("text", x=6.5, y=13.5, label ="Mid season", cex=3.5) +
  annotate("text", x=10.5, y=13.5, label="Late season", cex=3.5) +
  annotate("text", x=2.5, y=12.8, label=" ns.", cex=3.5) +
  annotate("text", x=6.5, y=12.8, label=" ( *** )", cex=3.5) +
  annotate("text", x=10.5, y=12.8, label=" ( *** )", cex=3.5) +
  theme_bw() +
  #coord_cartesian(ylim=c(1,40)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=14, hjust = 0.5, face="italic"),axis.text.x = element_text(vjust=0.5,angle = 75, size=14),axis.text.y = element_text(size=12), axis.title.y = element_text(size=14)) +
  xlab("Month") +
  ylab("Species richness")

Species_Richness

ggarrange(Species_Richness, ncol = 1, nrow = 1)
ggsave("COI/Local_analysis/output/plots/SpeciesRichnessBothOneFig_diptera.pdf", width=10, height=6)


saveRDS(Species_Richness, file="COI/Local_analysis/output/RDS_files/Species_Richness_diptera")

ggarrange(Species_Richness_gal, Species_Richness_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/SpeciesRichnessBoth_diptera.pdf", width=14, height=8)

RichnessBoth<-ggarrange(Species_Richness_gal, Species_Richness_exm, labels = c("A", "B"), ncol = 1, nrow = 2)

saveRDS(RichnessBoth, file="COI/Local_analysis/output/RDS_files/RichnessBoth_diptera")


#Find most abundant species across all samples

samples.data = read.table("COI/MetaBarFlow/output/Metadata_MOLS2020_invertebrates_corrected_source.txt",
                        header=TRUE,row.names=1,na.strings="NA")



source_vec<-c()
month_vec<-c()

for (i in 1:nrow(df_raw)) {
  sample<-as.character(df_raw$sample[i])
  idx<-which(row.names(samples.data)==sample)
  source_vec<-append(source_vec, as.character(samples.data$source[idx]))
  month_vec<-append(month_vec, as.character(samples.data$month[idx]))
}

source<-as.factor(source_vec)
month<-as.factor(month_vec)

df_raw<-cbind(df_raw, source, month)

df_gal<-subset(df_raw, df_raw$source=="galloway")
df_exm<-subset(df_raw, df_raw$source=="exmoor")

#Galloway
Species<-unique(df_gal$species)
abun<-list()

for (i in 1:length(Species)){
  df<-as.data.frame(Species[i])
  colnames(df)<-c("Species")
  Count<-sum(df_gal$count[df_gal$species==Species[i]])
  df<-cbind(df, Count)
  abun<-rbind(abun, df)
}

abundance<-abun[order(abun$Count),c(1,2)]

#Create vector of 20 most abundant species/ASVs
high_20_gal<-as.character(abundance$Species[(nrow(abundance)-14):(nrow(abundance))])

#Add "Other" as level in the df_raw$species vector
levels(df_gal$species) <- c(levels(df_gal$species),"Other")

#Check if species is in the 20 most abundant - if not, change species to "Other"
for (i in 1:nrow(df_gal)) {
  x<-as.character(df_gal$species[i])
  vec<-grepl(as.character(x), high_20_gal, fixed=TRUE)
  if (sum(vec)==0) {df_gal$species[i]="Other"     }
}


#Rename genus column to Genus
df_gal<-df_gal %>%
  dplyr::rename(Species=species)

#Change order of sampling time
df_gal<-df_gal %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-append(sort(high_20_gal),"Other")


df_gal<-df_gal %>%
  dplyr::mutate(Species=factor(Species, levels=levels))

#Adding 21 color option
nb.cols <- 27
#mycolorsbase<-c('#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4', '#469990', '#dcbeff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#a9a9a9', '#000000')
mycolorsbase <-c("darkolivegreen3","chocolate","brown2","darkolivegreen1","darkseagreen4","brown4","burlywood4","darkolivegreen","burlywood3","darkseagreen1","cornflowerblue","bisque4","chocolate1","yellow","darkorange4","burlywood1","brown","darkred","cyan","burlywood2","chartreuse3","darkkhaki","cadetblue4","goldenrod2","lightpink1","hotpink2","palegreen", "darkblue","darkmagenta","yellowgreen","magenta2","seagreen","mintcream","coral1","#aaffc3")
mycolors<-mycolorsbase[c(5:6,10:12,15:16,18:22,25:27)]
mycolors<-append(mycolors,"black")

#Plotting Galloway
stacked_gal<-ggplot(df_gal, aes(fill=Species, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Proportion of reads")

stacked_gal

#Exmoor
Species<-unique(df_exm$species)
abun<-list()

for (i in 1:length(Species)){
  df<-as.data.frame(Species[i])
  colnames(df)<-c("Species")
  Count<-sum(df_exm$count[df_exm$species==Species[i]])
  df<-cbind(df, Count)
  abun<-rbind(abun, df)
}

abundance<-abun[order(abun$Count),c(1,2)]

#Create vector of 20 most abundant species/ASVs
high_20_exm<-as.character(abundance$Species[(nrow(abundance)-14):(nrow(abundance))])

#Add "Other" as level in the df_raw$species vector
levels(df_exm$species) <- c(levels(df_exm$species),"Other")

#Check if species is in the 20 most abundant - if not, change species to "Other"
for (i in 1:nrow(df_exm)) {
  x<-as.character(df_exm$species[i])
  vec<-grepl(as.character(x), high_20_exm, fixed=TRUE)
  if (sum(vec)==0) {df_exm$species[i]="Other"     }
}


#Rename genus column to Genus
df_exm<-df_exm %>%
  dplyr::rename(Species=species)

#Change order of sampling time
df_exm<-df_exm %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-append(sort(high_20_exm),"Other")


df_exm<-df_exm %>%
  dplyr::mutate(Species=factor(Species, levels=levels))

mycolors<-mycolorsbase[c(1:9,13:14,17,23:24,28)]
mycolors<-append(mycolors,"black")

#Plotting Exmoor
stacked_exm<-ggplot(df_exm, aes(fill=Species, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Proportion of reads")

write.csv(cbind(sort(high_20_exm),sort(high_20_gal)), file="COI/Local_analysis/output/tables/high-15_dung_diptera.csv")


ggarrange(stacked_gal,stacked_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothSpecies_diptera.pdf", width=14, height=8)



StackedBoth<-ggarrange(stacked_gal,stacked_exm, labels = c("C", "D"), ncol = 1, nrow = 2)

saveRDS(StackedBoth, file="COI/Local_analysis/output/RDS_files/StackedBothSpecies_diptera")

#ggsave("Stacked_barplot_all_time.pdf",width=15,height=8.5)

#Aggregate samples by month

gal_month<-aggregate(df_gal, list(Month = df_gal$month, Species = df_gal$Species), FUN=mean)
exm_month<-aggregate(df_exm, list(Month = df_exm$month, Species = df_exm$Species), FUN=mean)

#Remove redundant columns
gal_month<-gal_month[,-c(3:4,6:9)]
exm_month<-exm_month[,-c(3:4,6:9)]

gal_month_20<-gal_month
exm_month_20<-exm_month

#Calculate total reads in each month

jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()
for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {jan<-append(jan, gal_month$count[i])}
  if (gal_month$Month[i]=="February") {feb<-append(feb, gal_month$count[i])}
  if (gal_month$Month[i]=="March") {mar<-append(mar, gal_month$count[i])}
  if (gal_month$Month[i]=="April") {apr<-append(apr, gal_month$count[i])}
  if (gal_month$Month[i]=="May") {may<-append(may, gal_month$count[i])}
  if (gal_month$Month[i]=="June") {jun<-append(jun, gal_month$count[i])}
  if (gal_month$Month[i]=="July") {jul<-append(jul, gal_month$count[i])}
  if (gal_month$Month[i]=="August") {aug<-append(aug, gal_month$count[i])}
  if (gal_month$Month[i]=="September") {sep<-append(sep, gal_month$count[i])}
  if (gal_month$Month[i]=="October") {oct<-append(oct, gal_month$count[i])}
  if (gal_month$Month[i]=="November") {nov<-append(nov, gal_month$count[i])}
  if (gal_month$Month[i]=="December") {dec<-append(dec, gal_month$count[i])}
}
total_each_gal<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(gal_month)))

gal_month<-cbind(gal_month, totalreads)

for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {gal_month$totalreads[i]=total_each_gal[1]}
  if (gal_month$Month[i]=="February") {gal_month$totalreads[i]=total_each_gal[2]}
  if (gal_month$Month[i]=="March") {gal_month$totalreads[i]=total_each_gal[3]}
  if (gal_month$Month[i]=="April") {gal_month$totalreads[i]=total_each_gal[4]}
  if (gal_month$Month[i]=="May") {gal_month$totalreads[i]=total_each_gal[5]}
  if (gal_month$Month[i]=="June") {gal_month$totalreads[i]=total_each_gal[6]}
  if (gal_month$Month[i]=="July") {gal_month$totalreads[i]=total_each_gal[7]}
  if (gal_month$Month[i]=="August") {gal_month$totalreads[i]=total_each_gal[8]}
  if (gal_month$Month[i]=="September") {gal_month$totalreads[i]=total_each_gal[9]}
  if (gal_month$Month[i]=="October") {gal_month$totalreads[i]=total_each_gal[10]}
  if (gal_month$Month[i]=="November") {gal_month$totalreads[i]=total_each_gal[11]}
  if (gal_month$Month[i]=="December") {gal_month$totalreads[i]=total_each_gal[12]}
  }

freq<-c()

for (i in 1:nrow(gal_month)) {
  x<-gal_month$count[i]/gal_month$totalreads[i]
  freq<-append(freq,x)
}

gal_month<-cbind(gal_month, freq)

#And for exmoor ponies


jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {jan<-append(jan, exm_month$count[i])}
  if (exm_month$Month[i]=="February") {feb<-append(feb, exm_month$count[i])}
  if (exm_month$Month[i]=="March") {mar<-append(mar, exm_month$count[i])}
  if (exm_month$Month[i]=="April") {apr<-append(apr, exm_month$count[i])}
  if (exm_month$Month[i]=="May") {may<-append(may, exm_month$count[i])}
  if (exm_month$Month[i]=="June") {jun<-append(jun, exm_month$count[i])}
  if (exm_month$Month[i]=="July") {jul<-append(jul, exm_month$count[i])}
  if (exm_month$Month[i]=="August") {aug<-append(aug, exm_month$count[i])}
  if (exm_month$Month[i]=="September") {sep<-append(sep, exm_month$count[i])}
  if (exm_month$Month[i]=="October") {oct<-append(oct, exm_month$count[i])}
  if (exm_month$Month[i]=="November") {nov<-append(nov, exm_month$count[i])}
  if (exm_month$Month[i]=="December") {dec<-append(dec, exm_month$count[i])}
}
total_each_exm<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(exm_month)))

exm_month<-cbind(exm_month, totalreads)

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {exm_month$totalreads[i]=total_each_exm[1]}
  if (exm_month$Month[i]=="February") {exm_month$totalreads[i]=total_each_exm[2]}
  if (exm_month$Month[i]=="March") {exm_month$totalreads[i]=total_each_exm[3]}
  if (exm_month$Month[i]=="April") {exm_month$totalreads[i]=total_each_exm[4]}
  if (exm_month$Month[i]=="May") {exm_month$totalreads[i]=total_each_exm[5]}
  if (exm_month$Month[i]=="June") {exm_month$totalreads[i]=total_each_exm[6]}
  if (exm_month$Month[i]=="July") {exm_month$totalreads[i]=total_each_exm[7]}
  if (exm_month$Month[i]=="August") {exm_month$totalreads[i]=total_each_exm[8]}
  if (exm_month$Month[i]=="September") {exm_month$totalreads[i]=total_each_exm[9]}
  if (exm_month$Month[i]=="October") {exm_month$totalreads[i]=total_each_exm[10]}
  if (exm_month$Month[i]=="November") {exm_month$totalreads[i]=total_each_exm[11]}
  if (exm_month$Month[i]=="December") {exm_month$totalreads[i]=total_each_exm[12]}
  }

freq<-c()

for (i in 1:nrow(exm_month)) {
  x<-exm_month$count[i]/exm_month$totalreads[i]
  freq<-append(freq,x)
}

exm_month<-cbind(exm_month, freq)

mycolors<-mycolorsbase[c(5:6,10:12,15:16,18:22,25:27)]
mycolors<-append(mycolors,"black")


#Plotting Galloway
stacked_gal_months<-ggplot(gal_month, aes(fill=Species, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Proportion of reads")

mycolors<-mycolorsbase[c(1:9,13:14,17,23:24,28)]
mycolors<-append(mycolors,"black")

#Plotting Exmoor
stacked_exm_months<-ggplot(exm_month, aes(fill=Species, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Proportion of reads")

saveRDS(stacked_gal_months, file="COI/Local_analysis/output/RDS_files/stacked_gal_months_diptera")
saveRDS(stacked_exm_months, file="COI/Local_analysis/output/RDS_files/stacked_exm_months_diptera")


ggarrange(stacked_gal_months, stacked_exm_months, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothMonthsSpecies_diptera.pdf", width=14, height=8)


StackedBothMonths<-ggarrange(stacked_gal_months, stacked_exm_months, labels = c("C", "D"), ncol = 1, nrow = 2)

saveRDS(StackedBothMonths, file="COI/Local_analysis/output/RDS_files/StackedBothMonthsSpecies_diptera")



```


```{r Stacked barplots functional groups}

#Plotting the richness of sampling time as well as stacked barplot of all sampling times


#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)
library(MetBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_diptera")


#Generating input df


#Create temporary df with read counts in each sample from metabarcoding file
df_tmp<-data.frame(dataset@reads)
colnames(df_tmp)<-dataset@motus$type



#Create temporary df to build file with the columns (sample, species, count, totalreads, freq)
df<-data.frame("sample"=c(), "type"=c(),"count"=c())
df<-rbind(df, c(1,1,1))
colnames(df)<-c("sample", "type", "count")


#Add row to the dataframe for each sample/type combination
for (i in 1:nrow(df_tmp)) {
  for (j in 1:ncol(df_tmp)) {
   if (df_tmp[i,j]!=0) 
     {df<-rbind(df, c(row.names(df_tmp)[i],colnames(df_tmp)[j],df_tmp[i,j]))
     } 
  }
}

#Subtract the first row which was only used to keep correct format
df<-df[-1,]

#Change type of columns (sample=factor, count=numeric)
df2<-data.frame("sample"=as.factor(df$sample), "type"=df$type, "count"=as.numeric(df$count))

df2<-data.table::setorder(aggregate(.~sample+type, data=df2, FUN=sum),sample)

#Calculate total reads in each sample
#Create df with unique sample names and totalreads vector
totalreads1<-data.frame("sample"=as.factor(unique(df2$sample)))
totalreads<-c()

#Add value for total reads in each sample to the sample_count vector
for (sample in unique(df2$sample)) {
  x1<-which(df2$sample==sample)
  x2<-sum(df2$count[x1[1]:x1[length(x1)]])
  totalreads<-append(totalreads, rep(x2, each=length(x1))) #Each total count added as many times as each sample in represented in df2
}

#Add totalreads to df2
df2<-cbind(df2,totalreads)


#Calculate frequency of each species in the sample
freq<-c()

for (i in 1:nrow(df2)) {
  x<-df2$count[i]/df2$totalreads[i]
  freq<-append(freq,x)
  
  
}


#Add to df2
df_raw<-cbind(df2, freq)


#Find most abundant species across all samples

samples.data = read.table("COI/MetaBarFlow/output/Metadata_MOLS2020_invertebrates_corrected_source.txt",
                        header=TRUE,row.names=1,na.strings="NA")



source_vec<-c()
month_vec<-c()

for (i in 1:nrow(df_raw)) {
  sample<-as.character(df_raw$sample[i])
  idx<-which(row.names(samples.data)==sample)
  source_vec<-append(source_vec, as.character(samples.data$source[idx]))
  month_vec<-append(month_vec, as.character(samples.data$month[idx]))
}

source<-as.factor(source_vec)
month<-as.factor(month_vec)

df_raw<-cbind(df_raw, source, month)

df_gal<-subset(df_raw, df_raw$source=="galloway")
df_exm<-subset(df_raw, df_raw$source=="exmoor")



#Rename genus column to Genus
df_gal<-df_gal %>%
  dplyr::rename(Type=type)

#Change order of sampling time
df_gal<-df_gal %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-sort(unique(df_gal$Type))


df_gal<-df_gal %>%
  dplyr::mutate(Type=factor(Type, levels=levels))

#Adding 21 color option

nb.cols <- 3
mycolorsbase<-met.brewer("Degas",nb.cols,type="discrete")
mycolors<-mycolorsbase[c(1:10)]

#Plotting Galloway
stacked_gal<-ggplot(df_gal, aes(fill=Type, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Relative frequency")

stacked_gal

#Exmoor

#Rename genus column to Genus
df_exm<-df_exm %>%
  dplyr::rename(Type=type)

#Change order of sampling time
df_exm<-df_exm %>%
  dplyr::mutate(sample=factor(sample, levels=c(  "JAN1","JAN2","JAN3","JAN4","JAN5","JAN6","JAN7","JAN8","JAN9","JAN10","JAN11","JAN12","JAN13","JAN14","JAN15","JAN16","JAN17","JAN18","JAN19","JAN20","FEB1","FEB2","FEB3","FEB4","FEB5","FEB6","FEB7","FEB8","FEB9","FEB10","FEB11","FEB12","FEB13","FEB14","FEB15","FEB16","FEB17","FEB18","FEB19","FEB20","MAR1","MAR2","MAR3","MAR4","MAR5","MAR6","MAR7","MAR8","MAR9","MAR10","MAR11","MAR12","MAR13","MAR14","MAR15","MAR16","MAR17","MAR18","MAR19","MAR20","APR1","APR2","APR3","APR4","APR5","APR6","APR7","APR8","APR9","APR10","APR11","APR12","APR13","APR14","APR15","APR16","APR17","APR18","APR19","APR20","MAY1","MAY2","MAY3","MAY4","MAY5","MAY6","MAY7","MAY8","MAY9","MAY10","MAY11","MAY12","MAY13","MAY14","MAY15","MAY16","MAY17","MAY18","MAY19","MAY20","JUN1","JUN2","JUN3","JUN4","JUN5","JUN6","JUN7","JUN8","JUN9","JUN10","JUN11","JUN12","JUN13","JUN14","JUN15","JUN16","JUN17","JUN18","JUN19","JUN20","JUL1","JUL2","JUL3","JUL4","JUL5","JUL6","JUL7","JUL8","JUL9","JUL10","JUL11","JUL12","JUL13","JUL14","JUL15","JUL16","JUL17","JUL18","JUL19","JUL20","AUG1","AUG2","AUG3","AUG4","AUG5","AUG6","AUG7","AUG8","AUG9","AUG10","AUG11","AUG12","AUG13","AUG14","AUG15","AUG16","AUG17","AUG18","AUG19","AUG20","SEP1","SEP2","SEP3","SEP4","SEP5","SEP6","SEP7","SEP8","SEP9","SEP10","SEP11","SEP12","SEP13","SEP14","SEP15","SEP16","SEP17","SEP18","SEP19","SEP20","OCT1","OCT2","OCT3","OCT4","OCT5","OCT6","OCT7","OCT8","OCT9","OCT10","OCT11","OCT12","OCT13","OCT14","OCT15","OCT16","OCT17","OCT18","OCT19","OCT20","NOV1","NOV2","NOV3","NOV4","NOV5","NOV6","NOV7","NOV8","NOV9","NOV10","NOV11","NOV12","NOV13","NOV14","NOV15","NOV16","NOV17","NOV18","NOV19","NOV20","DEC1","DEC2","DEC3","DEC4","DEC5","DEC6","DEC7","DEC8","DEC9","DEC10","DEC11","DEC12","DEC13","DEC14","DEC15","DEC16","DEC17","DEC18","DEC19","DEC20"
)))

levels<-sort(unique(df_exm$Type))


df_exm<-df_exm %>%
  dplyr::mutate(Type=factor(Type, levels=levels))

#mycolors<-mycolorsbase[c(1:6,9:10)]

#Plotting Exmoor
stacked_exm<-ggplot(df_exm, aes(fill=Type, y=freq, x=sample)) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Sample") +
  ylab("Relative frequency")

stacked_exm

ggarrange(stacked_gal,stacked_exm, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothSpecies_diptera_functional_types_all_samples.pdf", width=14, height=8)

#Aggregate samples by month

gal_month<-aggregate(df_gal, list(Month = df_gal$month, Type = df_gal$Type), FUN=mean)
exm_month<-aggregate(df_exm, list(Month = df_exm$month, Type = df_exm$Type), FUN=mean)

#Remove redundant columns
gal_month<-gal_month[,-c(3:4,6:9)]
exm_month<-exm_month[,-c(3:4,6:9)]

gal_month_20<-gal_month
exm_month_20<-exm_month

#Calculate total reads in each month

jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()
for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {jan<-append(jan, gal_month$count[i])}
  if (gal_month$Month[i]=="February") {feb<-append(feb, gal_month$count[i])}
  if (gal_month$Month[i]=="March") {mar<-append(mar, gal_month$count[i])}
  if (gal_month$Month[i]=="April") {apr<-append(apr, gal_month$count[i])}
  if (gal_month$Month[i]=="May") {may<-append(may, gal_month$count[i])}
  if (gal_month$Month[i]=="June") {jun<-append(jun, gal_month$count[i])}
  if (gal_month$Month[i]=="July") {jul<-append(jul, gal_month$count[i])}
  if (gal_month$Month[i]=="August") {aug<-append(aug, gal_month$count[i])}
  if (gal_month$Month[i]=="September") {sep<-append(sep, gal_month$count[i])}
  if (gal_month$Month[i]=="October") {oct<-append(oct, gal_month$count[i])}
  if (gal_month$Month[i]=="November") {nov<-append(nov, gal_month$count[i])}
  if (gal_month$Month[i]=="December") {dec<-append(dec, gal_month$count[i])}
}
total_each_gal<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(gal_month)))

gal_month<-cbind(gal_month, totalreads)

for (i in 1:nrow(gal_month)) {
  if (gal_month$Month[i]=="January") {gal_month$totalreads[i]=total_each_gal[1]}
  if (gal_month$Month[i]=="February") {gal_month$totalreads[i]=total_each_gal[2]}
  if (gal_month$Month[i]=="March") {gal_month$totalreads[i]=total_each_gal[3]}
  if (gal_month$Month[i]=="April") {gal_month$totalreads[i]=total_each_gal[4]}
  if (gal_month$Month[i]=="May") {gal_month$totalreads[i]=total_each_gal[5]}
  if (gal_month$Month[i]=="June") {gal_month$totalreads[i]=total_each_gal[6]}
  if (gal_month$Month[i]=="July") {gal_month$totalreads[i]=total_each_gal[7]}
  if (gal_month$Month[i]=="August") {gal_month$totalreads[i]=total_each_gal[8]}
  if (gal_month$Month[i]=="September") {gal_month$totalreads[i]=total_each_gal[9]}
  if (gal_month$Month[i]=="October") {gal_month$totalreads[i]=total_each_gal[10]}
  if (gal_month$Month[i]=="November") {gal_month$totalreads[i]=total_each_gal[11]}
  if (gal_month$Month[i]=="December") {gal_month$totalreads[i]=total_each_gal[12]}
  }

freq<-c()

for (i in 1:nrow(gal_month)) {
  x<-gal_month$count[i]/gal_month$totalreads[i]
  freq<-append(freq,x)
}

gal_month<-cbind(gal_month, freq)

#And for exmoor ponies


jan<-c()
feb<-c()
mar<-c()
apr<-c()
may<-c()
jun<-c()
jul<-c()
aug<-c()
sep<-c()
oct<-c()
nov<-c()
dec<-c()

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {jan<-append(jan, exm_month$count[i])}
  if (exm_month$Month[i]=="February") {feb<-append(feb, exm_month$count[i])}
  if (exm_month$Month[i]=="March") {mar<-append(mar, exm_month$count[i])}
  if (exm_month$Month[i]=="April") {apr<-append(apr, exm_month$count[i])}
  if (exm_month$Month[i]=="May") {may<-append(may, exm_month$count[i])}
  if (exm_month$Month[i]=="June") {jun<-append(jun, exm_month$count[i])}
  if (exm_month$Month[i]=="July") {jul<-append(jul, exm_month$count[i])}
  if (exm_month$Month[i]=="August") {aug<-append(aug, exm_month$count[i])}
  if (exm_month$Month[i]=="September") {sep<-append(sep, exm_month$count[i])}
  if (exm_month$Month[i]=="October") {oct<-append(oct, exm_month$count[i])}
  if (exm_month$Month[i]=="November") {nov<-append(nov, exm_month$count[i])}
  if (exm_month$Month[i]=="December") {dec<-append(dec, exm_month$count[i])}
}
total_each_exm<-sapply(list(jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec), FUN=sum)

totalreads<-c(rep(1, each=nrow(exm_month)))

exm_month<-cbind(exm_month, totalreads)

for (i in 1:nrow(exm_month)) {
  if (exm_month$Month[i]=="January") {exm_month$totalreads[i]=total_each_exm[1]}
  if (exm_month$Month[i]=="February") {exm_month$totalreads[i]=total_each_exm[2]}
  if (exm_month$Month[i]=="March") {exm_month$totalreads[i]=total_each_exm[3]}
  if (exm_month$Month[i]=="April") {exm_month$totalreads[i]=total_each_exm[4]}
  if (exm_month$Month[i]=="May") {exm_month$totalreads[i]=total_each_exm[5]}
  if (exm_month$Month[i]=="June") {exm_month$totalreads[i]=total_each_exm[6]}
  if (exm_month$Month[i]=="July") {exm_month$totalreads[i]=total_each_exm[7]}
  if (exm_month$Month[i]=="August") {exm_month$totalreads[i]=total_each_exm[8]}
  if (exm_month$Month[i]=="September") {exm_month$totalreads[i]=total_each_exm[9]}
  if (exm_month$Month[i]=="October") {exm_month$totalreads[i]=total_each_exm[10]}
  if (exm_month$Month[i]=="November") {exm_month$totalreads[i]=total_each_exm[11]}
  if (exm_month$Month[i]=="December") {exm_month$totalreads[i]=total_each_exm[12]}
  }

freq<-c()

for (i in 1:nrow(exm_month)) {
  x<-exm_month$count[i]/exm_month$totalreads[i]
  freq<-append(freq,x)
}

exm_month<-cbind(exm_month, freq)



#Plotting Galloway
stacked_gal_months<-ggplot(gal_month, aes(fill=Type, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Relative frequency")



#Plotting Exmoor
stacked_exm_months<-ggplot(exm_month, aes(fill=Type, y=freq, x=factor(Month, level=level_order))) +
  guides(fill=guide_legend(ncol=1)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = mycolors) +
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 0.5),legend.text = element_text(colour="black", size = 10, face = "italic")) +
  xlab("Month") +
  ylab("Relative frequency")


saveRDS(stacked_gal_months, file="COI/Local_analysis/output/RDS_files/stacked_gal_months_diptera_func")
saveRDS(stacked_exm_months, file="COI/Local_analysis/output/RDS_files/stacked_exm_months_diptera_func")



ggarrange(stacked_gal_months, stacked_exm_months, labels = c("A", "B"), ncol = 1, nrow = 2)
ggsave("COI/Local_analysis/output/plots/StackedBothMonthsSpecies_diptera_functional_types.pdf", width=14, height=8)




```


```{r Find unique species}



#Loading libraries
library(tidyverse)
library(ROBITools)
library(ROBITaxonomy)
library(ggpubr)
library(dplyr)
library(ggplot2)
library(ggsci)
library(RColorBrewer)

#Set level order for plots
level_order <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December") 

#Load data
df_raw <- readRDS("COI/Local_analysis/output/RDS_files/df_for_plots_and_analysis_diptera")

dataset<-readRDS("COI/Local_analysis/output/RDS_files/dataset_final_diptera")


#Create season vec

samples<-dataset@samples[,c("source", "habitat","month")]

season_vec=c()
for (i in 1:nrow(samples)) {
  if (samples$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="December") {season_vec<-append(season_vec,"late")}
}


dataset@samples$season<-as.factor(season_vec)

nsamples<-as.data.frame(table(df_raw$species))
colnames(nsamples)<-c("species","freq")

#Remove species only present in fewer than 5 samples
nsamples<-nsamples[which(nsamples$freq>=5),]




df_gal<-dataset@reads[which(dataset@samples$source=="galloway"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_gal)<-nsamples$species
df_exm<-dataset@reads[which(dataset@samples$source=="exmoor"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_exm)<-nsamples$species
df_open<-dataset@reads[which(dataset@samples$habitat=="open"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_open)<-nsamples$species
df_forest<-dataset@reads[which(dataset@samples$habitat=="forest"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_forest)<-nsamples$species
df_early<-dataset@reads[which(dataset@samples$season=="early"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_early)<-nsamples$species
df_mid<-dataset@reads[which(dataset@samples$season=="mid"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_mid)<-nsamples$species
df_late<-dataset@reads[which(dataset@samples$season=="late"),which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_late)<-nsamples$species
df_eg<-dataset@reads[which(dataset@samples$season=="early" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_eg)<-nsamples$species
df_ee<-dataset@reads[which(dataset@samples$season=="early" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_ee)<-nsamples$species
df_mg<-dataset@reads[which(dataset@samples$season=="mid" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_mg)<-nsamples$species
df_me<-dataset@reads[which(dataset@samples$season=="mid" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_me)<-nsamples$species
df_lg<-dataset@reads[which(dataset@samples$season=="late" & dataset@samples$source=="galloway"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_lg)<-nsamples$species
df_le<-dataset@reads[which(dataset@samples$season=="late" & dataset@samples$source=="exmoor"), which(dataset@motus$final.otu %in% nsamples$species)]
colnames(df_le)<-nsamples$species




df_gal_total<-colSums(df_gal)
df_exm_total<-colSums(df_exm)
df_open_total<-colSums(df_open)
df_forest_total<-colSums(df_forest)

GaEx<-data.frame(rbind(df_gal_total,df_exm_total))
colnames(GaEx)<-colnames(df_gal)


skew<-NULL

for (i in 1:ncol(GaEx)) {
  if (GaEx[,i][1]/GaEx[,i][2]<0.1) {skew<-append(skew, "YES: Exm")}
  else if (GaEx[,i][2]/GaEx[,i][1]<0.1) {skew<-append(skew, "YES: Gal")}
  else  {skew<-append(skew, "NO")}
  
  
}

GaEx<-rbind(GaEx,skew)

Skew.df<-data.frame(t(GaEx))


OF<-data.frame(rbind(df_open_total,df_forest_total))
colnames(OF)<-colnames(df_open)


skew<-NULL

for (i in 1:ncol(OF)) {
  if (OF[,i][1]/OF[,i][2]<0.1) {skew<-append(skew, "YES: Forest")}
  else if (OF[,i][2]/OF[,i][1]<0.1) {skew<-append(skew, "YES: Open")}
  else  {skew<-append(skew, "NO")}
  
  
}

OF<-rbind(OF,skew)

Skew.df<-cbind(Skew.df, data.frame(t(OF)))

colnames(Skew.df)<-c("Galloway","Exmoor","Skewed source","Open","Forest","Skewed habitat")


write.table(Skew.df, file="COI/Local_analysis/output/tables/skew_table_diptera.txt", sep = "\t")



#Unique species

gal_species<-c()
exm_species<-c()
open_species<-c()
forest_species<-c()
early_species<-c()
mid_species<-c()
late_species<-c()
eg_species<-c()
mg_species<-c()
lg_species<-c()
ee_species<-c()
me_species<-c()
le_species<-c()
for (i in 1:ncol(df_gal)) {
  if (sum(df_gal[,i])>0) {gal_species<-append(gal_species,colnames(df_gal)[i])}
  if (sum(df_exm[,i])>0) {exm_species<-append(exm_species,colnames(df_exm)[i])}
  if (sum(df_open[,i])>0) {open_species<-append(open_species,colnames(df_open)[i])}
  if (sum(df_forest[,i])>0) {forest_species<-append(forest_species,colnames(df_forest)[i])}
  if (sum(df_early[,i])>0) {early_species<-append(early_species,colnames(df_early)[i])}
  if (sum(df_mid[,i])>0) {mid_species<-append(mid_species,colnames(df_mid)[i])}
  if (sum(df_late[,i])>0) {late_species<-append(late_species,colnames(df_late)[i])}
  if (sum(df_eg[,i])>0) {eg_species<-append(eg_species,colnames(df_eg)[i])}
  if (sum(df_mg[,i])>0) {mg_species<-append(mg_species,colnames(df_mg)[i])}
  if (sum(df_lg[,i])>0) {lg_species<-append(lg_species,colnames(df_lg)[i])}
  if (sum(df_ee[,i])>0) {ee_species<-append(ee_species,colnames(df_ee)[i])}
  if (sum(df_me[,i])>0) {me_species<-append(me_species,colnames(df_me)[i])}
  if (sum(df_le[,i])>0) {le_species<-append(le_species,colnames(df_le)[i])}
}
open_uniq<-setdiff(open_species, forest_species)
forest_uniq<-setdiff(forest_species,open_species)


gal_uniq<-setdiff(gal_species, exm_species)
exm_uniq<-setdiff(exm_species,gal_species)

mx<-max(length(open_uniq),length(forest_uniq),length(gal_uniq),length(exm_uniq))


unique<-data.frame("open"=append(open_uniq,rep(0, each=mx-length(open_uniq))),
                   "forest"=append(forest_uniq,rep(0, each=mx-length(forest_uniq))), 
                   "galloway"=append(gal_uniq,rep(0, each=mx-length(gal_uniq))), 
                   "exmoor"=append(exm_uniq,rep(0, each=mx-length(exm_uniq))))

write.csv2(unique, file="COI/Local_analysis/output/tables/unique_diptera.csv")



#Create Venn diagram


library("ggVennDiagram")

x <- list(
  Galloway = gal_species[which(!grepl("sp.",gal_species,fixed=TRUE))], 
  Exmoor = exm_species[which(!grepl("sp.",exm_species,fixed=TRUE))],
  Open = open_species[which(!grepl("sp.",open_species,fixed=TRUE))],
  Forest = forest_species[which(!grepl("sp.",forest_species,fixed=TRUE))],
  Early = early_species[which(!grepl("sp.",early_species,fixed=TRUE))],
  Mid = mid_species[which(!grepl("sp.",mid_species,fixed=TRUE))],
  Late = late_species[which(!grepl("sp.",late_species,fixed=TRUE))],
  Gal.Early = eg_species[which(!grepl("sp.",eg_species,fixed=TRUE))], 
  Gal.Mid = mg_species[which(!grepl("sp.",mg_species,fixed=TRUE))],
  Gal.Late = lg_species[which(!grepl("sp.",lg_species,fixed=TRUE))],
  Exm.Early = ee_species[which(!grepl("sp.",ee_species,fixed=TRUE))],
  Exm.Mid = me_species[which(!grepl("sp.",me_species,fixed=TRUE))],
  Exm.Late = le_species[which(!grepl("sp.",le_species,fixed=TRUE))]
)


venn1 <- ggVennDiagram(
  x[1:2], label_alpha = 0,
  category.names = c("Galloway","Exmoor"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 7) +
  theme(text = element_text(size=20))

venn1

venn2 <- ggVennDiagram(
  x[3:4], label_alpha = 0,
  category.names = c("Open","Forest"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 10) +
  theme(text = element_text(size=20))

venn2

venn3 <- ggVennDiagram(
  x[5:7], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 5) +
  theme(text = element_text(size=20))

venn3

venn4 <- ggVennDiagram(
  x[8:10], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 5) +
  theme(text = element_text(size=20))

venn4

venn5 <- ggVennDiagram(
  x[11:13], label_alpha = 0,
  category.names = c("Early","Mid","Late"),
  edge_lty = "blank", set_size = 8) +
  ggplot2::scale_fill_gradient2(low="#f2f5f0",high = "#2e60a6", mid="#29AF7FFF", midpoint = 3) +
  theme(text = element_text(size=20))

venn5

saveRDS(venn1, file="COI/Local_analysis/output/RDS_files/venn1_diptera")
saveRDS(venn2, file="COI/Local_analysis/output/RDS_files/venn2_diptera")
saveRDS(venn3, file="COI/Local_analysis/output/RDS_files/venn3_diptera")
saveRDS(venn4, file="COI/Local_analysis/output/RDS_files/venn4_diptera")
saveRDS(venn5, file="COI/Local_analysis/output/RDS_files/venn5_diptera")

ggarrange(venn1,venn2,venn4,venn5, labels = c("A", "B","C","D","E"), ncol = 4, nrow = 1)
ggsave("COI/Local_analysis/output/plots/venn_diagrams_diptera.pdf", width=12, height=6)



```

```{r NDMS plots}

#Libraries
library(vegan)
library(dplyr)
library(ggplot2)
library(ggalt)
library(ggpubr)
#library(BiodiversityR)

#Function for inverse normal transformation
inormal <- function(x)
{
  qnorm((rank(x, na.last = "keep") - 0.5) / sum(!is.na(x)))
}

#This step plots CAP and NMDS plots of abundance and presence/absence data
dataset <- readRDS("COI/Local_analysis/output/RDS_files/dataset_final_diptera")

par(mfrow=c(1,1))

samples<-dataset@samples[,c("source", "habitat","month")]

season_vec=c()
for (i in 1:nrow(samples)) {
  if (samples$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (samples$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (samples$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (samples$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (samples$month[i]=="December") {season_vec<-append(season_vec,"late")}
}
samples<-cbind(samples, "season"=season_vec)

group<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Galloway - EarlyOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - EarlyForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Galloway - MidOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - MidForest")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Galloway - LateOpen")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Galloway - LateForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - EarlyOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - EarlyForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - MidOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - MidForest")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="open") {group<-append(group,"Exmoor - LateOpen")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late" && samples$habitat[i]=="forest") {group<-append(group,"Exmoor - LateForest")}
}

samples<-cbind(samples,group)


group2<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$habitat[i]=="open") {group2<-append(group2,"Galloway - Open")}
  if (samples$source[i]=="galloway" && samples$habitat[i]=="forest") {group2<-append(group2,"Galloway - Forest")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="open") {group2<-append(group2,"Exmoor - Open")}
  if (samples$source[i]=="exmoor" && samples$habitat[i]=="forest") {group2<-append(group2,"Exmoor - Forest")}
}


group3<-c()
for (i in 1:nrow(samples)) {
  if (samples$source[i]=="galloway" && samples$season[i]=="early") {group3<-append(group3,"Galloway - Early")}
  if (samples$source[i]=="galloway" && samples$season[i]=="mid") {group3<-append(group3,"Galloway - Mid")}
  if (samples$source[i]=="galloway" && samples$season[i]=="late") {group3<-append(group3,"Galloway - Late")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="early") {group3<-append(group3,"Exmoor - Early")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="mid") {group3<-append(group3,"Exmoor - Mid")}
  if (samples$source[i]=="exmoor" && samples$season[i]=="late") {group3<-append(group3,"Exmoor - Late")}
}



samples<-cbind(samples,group2,group3)

reads<-dataset$reads

#Without outlier
reads<-reads[-which(row.names(reads)=="APR5"),]
reads<-reads[-which(row.names(reads)=="APR6"),]
reads<-reads[-which(row.names(reads)=="MAY8"),]
reads<-reads[-which(row.names(reads)=="SEP10"),]
reads<-reads[-which(row.names(reads)=="AUG20"),]

#Evaluate number of dimensions

#mreads<-as.matrix(sqrt(reads))
mreads<-as.matrix(reads) #With or without transformation?
nmds1D = metaMDS(mreads, distance = "bray", k=1)
nmds2D = metaMDS(mreads, distance = "bray", k=2)
nmds3D = metaMDS(mreads, distance = "bray", k=3)
nmds4D = metaMDS(mreads, distance = "bray", k=4)
nmds5D = metaMDS(mreads, distance = "bray", k=5)
nmds20D = metaMDS(mreads, distance = "bray", k=20)

dim<-data.frame("dim"=c(1,2,3,4,5,20),"stress"=c(nmds1D$stress,nmds2D$stress,nmds3D$stress,nmds4D$stress,nmds5D$stress,nmds20D$stress))

plot(dim$dim,dim$stress, main="Stress values in nMDS ordination with increasing numbers of dimensions", cex.main=0.8)
abline(h=0.20, col="red", lty=2)

par(mfrow=c(2,2))
stressplot(nmds1D, main="Stressplot K=1")
stressplot(nmds2D, main="Stressplot K=2")
stressplot(nmds3D, main="Stressplot K=3")
stressplot(nmds4D, main="Stressplot K=4")
stressplot(nmds5D, main="Stressplot K=5")
stressplot(nmds20D, main="Stressplot K=20")


#From stress vs. dimension plot, and stressplots, it seems that 2 dimensions will be appropriate 

reads<-dataset$reads

#Without outlier
reads<-reads[-which(row.names(reads)=="APR5"),]
reads<-reads[-which(row.names(reads)=="APR6"),]
reads<-reads[-which(row.names(reads)=="MAY8"),]
reads<-reads[-which(row.names(reads)=="SEP10"),]
reads<-reads[-which(row.names(reads)=="AUG20"),]
samples<-samples[-which(row.names(samples)=="APR5"),]
samples<-samples[-which(row.names(samples)=="APR6"),]
samples<-samples[-which(row.names(samples)=="MAY8"),]
samples<-samples[-which(row.names(samples)=="SEP10"),]
samples<-samples[-which(row.names(samples)=="AUG20"),]


#Perform NMDS-plot of reads
mreads<-as.matrix(sqrt(reads))
#mreads<-as.matrix(reads) #With or without transformation?
nmds = metaMDS(mreads, distance = "bray")
nmds.scores = as.data.frame(vegan::scores(nmds))
head(nmds.scores)

nmds.scores$Sample = row.names(samples)
nmds.scores$Source = samples$source
nmds.scores$Habitat = samples$habitat
nmds.scores$Month = samples$month
nmds.scores$Season = samples$season
nmds.scores$Group = samples$group

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("galloway","exmoor","Cattle","Horses")))

nmds.scores$Source[which(nmds.scores$Source=="galloway")]<-"Cattle"
nmds.scores$Source[which(nmds.scores$Source=="exmoor")]<-"Horses"

nmds.scores<-nmds.scores %>%
  dplyr::mutate(Source=factor(Source, levels=c("Cattle","Horses")))




gg1<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Source)) +
  scale_color_manual(values=c("darkseagreen4","dodgerblue3")) +
  geom_encircle(aes(fill = Source), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkseagreen4","dodgerblue3")) +
  #annotate("text", x=-1, y=2.8, label="All samples - diptera", cex=3) +
  #annotate("text", x=-1, y=2.6, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=2, y=2.5, label="Stress=0.09481", cex=3) +
  coord_cartesian(xlim=c(-3.5,3.2),ylim=c(-2.5,3.2)) +
  theme_bw()

plot(gg1)

gg2<-ggplot(nmds.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Habitat)) +
  scale_color_manual(values=c("darkgreen","gold1","palegreen","darkgoldenrod")) +
  geom_encircle(aes(fill = Habitat), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen","gold1","palegreen","darkgoldenrod")) +
  #annotate("text", x=0, y=2.9, label="All samples - diptera", cex=3) +
  #annotate("text", x=0, y=2.7, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=2, y=2.5, label="Stress=0.09481", cex=3) +
  coord_cartesian(xlim=c(-3.5,3.2),ylim=c(-2.5,3.2)) +
  theme_bw()

plot(gg2)


nmds.scores<-nmds.scores %>%
  dplyr::mutate(Season=factor(Season, levels=c("early","mid","late")))


gg3<-ggplot(nmds.scores[which(nmds.scores$Source=="Cattle"),], aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Season)) +
  scale_color_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  geom_encircle(aes(fill = Season), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  #annotate("text", x=-1, y=-2.5, label="Galloway samples - diptera", cex=3) +
  #annotate("text", x=-1, y=-2.7, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=2, y=2.5, label="Stress=0.09481", cex=3) +
  coord_cartesian(xlim=c(-3.5,3.2),ylim=c(-2.5,3.2)) +
  theme_bw()

plot(gg3)


gg4<-ggplot(nmds.scores[which(nmds.scores$Source=="Horses"),], aes(x = NMDS1, y = NMDS2)) + 
  geom_point(size = 3, aes(colour = Season)) +
  scale_color_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  geom_encircle(aes(fill = Season), s_shape = 1, expand = 0,
                alpha = 0.2, color = "black", show.legend = FALSE) +
  scale_fill_manual(values=c("#4fe7c7","#fb7264","#83370d")) +
  #annotate("text", x=1.5, y=2.1, label="Exmoor samples - diptera", cex=3) +
  #annotate("text", x=1.5, y=1.9, label="(Squareroot - transformed read counts)", cex=3) +
  annotate("text", x=2, y=2.5, label="Stress=0.09481", cex=3) +
  coord_cartesian(xlim=c(-3.5,3.2),ylim=c(-2.5,3.2)) +
  theme_bw()

plot(gg4)

saveRDS(gg1, file="COI/Local_analysis/output/RDS_files/ggDipGalExm")
saveRDS(gg2, file="COI/Local_analysis/output/RDS_files/ggDipOpenForest")
saveRDS(gg3, file="COI/Local_analysis/output/RDS_files/ggDipGalSeason")
saveRDS(gg4, file="COI/Local_analysis/output/RDS_files/ggDipExmSeason")

ggarrange(gg1,gg2,gg3,gg4, labels = c("A", "B","C","D"), ncol = 2, nrow = 2)
ggsave("COI/Local_analysis/output/plots/nMDS_COI_diptera.pdf", width=10, height=8)





#PERMANOVA

#Galloway vs. Exmoor
dist<-vegdist(mreads, method = "bray")

##Test for homogeneity of multivariate variance
#Galloway vs. exmoor
dispersion <- betadisper(dist, group=samples$group)
permutest(dispersion)

#No homogeneity of dispersion between groups, square root transformation applied
#dist.t<-sqrt(dist)
#dispersion <- betadisper(dist.t, group=samples$group)
#permutest(dispersion)




plot(dispersion, hull=FALSE, ellipse=TRUE) ##sd ellipse

perm<-adonis2(dist~source*season*habitat, data=samples, permutations = 999)
perm





#Create RDS with p.values from PERMANOVA

perm.out<-perm

saveRDS(perm.out, file="COI/Local_analysis/output/RDS_files/permanova_output_diptera")

write.table(perm.out, file="COI/Local_analysis/output/textfiles/permanova_output_COI_diptera.txt", sep="\t",row.names = TRUE, col.names = TRUE)


```

```{r Model richness}

df<-readRDS("COI/Local_analysis/output/RDS_files/Richness_df_diptera")

month_vec=c()
for (i in 1:nrow(df)) {
  if (df$month[i]=="January") {month_vec<-append(month_vec,1)} 
  else if (df$month[i]=="February") {month_vec<-append(month_vec,2)} 
  else if (df$month[i]=="March") {month_vec<-append(month_vec,3)}
  else if (df$month[i]=="April") {month_vec<-append(month_vec,4)}
  else if (df$month[i]=="May") {month_vec<-append(month_vec,5)}
  else if (df$month[i]=="June") {month_vec<-append(month_vec,6)}
  else if (df$month[i]=="July") {month_vec<-append(month_vec,7)}
  else if (df$month[i]=="August") {month_vec<-append(month_vec,8)}
  else if (df$month[i]=="September") {month_vec<-append(month_vec,9)}
  else if (df$month[i]=="October") {month_vec<-append(month_vec,10)}
  else if (df$month[i]=="November") {month_vec<-append(month_vec,11)}
  else if (df$month[i]=="December") {month_vec<-append(month_vec,12)}
  
}
season_vec=c()
for (i in 1:nrow(df)) {
  if (df$month[i]=="January") {season_vec<-append(season_vec,"early")} 
  else if (df$month[i]=="February") {season_vec<-append(season_vec,"early")} 
  else if (df$month[i]=="March") {season_vec<-append(season_vec,"early")}
  else if (df$month[i]=="April") {season_vec<-append(season_vec,"early")}
  else if (df$month[i]=="May") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="June") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="July") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="August") {season_vec<-append(season_vec,"mid")}
  else if (df$month[i]=="September") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="October") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="November") {season_vec<-append(season_vec,"late")}
  else if (df$month[i]=="December") {season_vec<-append(season_vec,"late")}
  
}

df<-cbind(df, "season"=as.factor(season_vec))

df$source<-droplevels(df$source,"control")

hist(df$Count)

model1.1<-glm(Count~season*source*habitat, family="poisson",data=df)
summary(model1.1)

par(mfrow=c(2,2))
plot(model1.1)


redu1<-glm(Count~source, family="poisson",data=df)

redu2<-glm(Count~season, family="poisson",data=df)

redu3<-glm(Count~habitat, family="poisson",data=df)

redu4<-glm(Count~source+season,family="poisson",data=df)

redu5<-glm(Count~source+habitat, family="poisson",data=df)

redu6<-glm(Count~habitat+season, family="poisson",data=df)

comparison<-anova(model1.1,redu1,redu2,redu3,redu4,redu5,redu6)

library(MASS)
library(spdep)
selection<-MASS::stepAIC(model1.1)
selection

colors = c("red","blue","green")

par(mfrow=c(2,2))
boxplot(Count~source+habitat+season, data=df, col=colors)
boxplot(Count~source, data=df, col=colors)
boxplot(Count~habitat, data=df, col=colors)
boxplot(Count~season+source, data=df, col=colors)

#df_gal<-subset(df, df$source=="galloway")
#df_exm<-subset(df, df$source=="exmoor")


#adding a spatial structure
#Spatial autocorrelation
#See mixed effects model II slides


#Correlograms by spline.correlog

#par(mfrow = c(1, 2), mar = c(5, 5, 2, 0.1))
## Plot correlogram 
#Splcor.SR <- spline.correlog(
#  x = df$lon, y = df$lat, z = df$Count,
#  latlon = T, na.rm = T, npoints = 1000, resamp = 1000, quiet = TRUE
#)
#plot(Splcor.SR, main = "Genera richness", cex = 1.5)
## Plot correlogram of model.3 residuals using the spline.correlog function
#Splcor.model1.1 <- spline.correlog(
#  x = df$lon, y = df$lat, z = residuals(model1.1),
#  latlon = T, na.rm = T, npoints = 1000, resamp = 1000, quiet = TRUE
#)
#plot(Splcor.model1.1, main = "Model1.1 model residuals", cex = 1.5)


#Estimating Moran's I

#m <- knearneigh(as.matrix(df[, c("lon", "lat")]), k = 1, longlat = TRUE)
#n <- knn2nb(m)
#ww <- nb2listw(n, zero.policy = TRUE)
#moran <- moran(df$Count, ww, n = length(ww$neighbours), S0 = Szero(ww))


#Moran.mc <- moran.mc(df$Count, listw = ww, nsim=1000)
#Moran.mc$p.value



## SAR-error model

#m <- knearneigh(as.matrix(df[, c("lon", "lat")]), k = 1, longlat = TRUE)
#n <- knn2nb(m)
#ww <- nb2listw(n, zero.policy = TRUE)
#SAR.Error <- errorsarlm(Count ~ source*month_number, listw = ww, data = df)

#coef(SAR.Error)
#coef(model1.2)

##Spline corellograms

#par(mfrow = c(1, 2), mar = c(5, 5, 2, 0.1))
#Splcor.model1.2 <- spline.correlog(
#  x = df$lon, y = df$lat,
#  z = residuals(model1.2),
#  latlon = TRUE, na.rm = TRUE,
#  npoints = 1000, resamp = 1000,
#  quiet = TRUE
#)
#plot(Splcor.model1.2, main = "Model1.2 model residuals", cex = 1.5)

#Splcor.SAR <- spline.correlog(
#  x = df$lon, y = df$lat,
#  z = residuals(SAR.Error),
#  latlon = TRUE, na.rm = TRUE,
#  npoints = 1000, resamp = 1000,
#  quiet = TRUE
#)
#plot(Splcor.SAR, main = "SAR model residuals", cex = 1.5)


#summary(SAR.Error)

##### DIET RICHNESS #############################################################################

#Test for difference in diet richness between galloway and exmoor in each season
t1<-kruskal.test(Count~source,data=df)
t2<-kruskal.test(Count~season,data=df)
t3<-kruskal.test(Count~habitat,data=df)

RG<-c(mean(df$Count[which(df$source=="galloway")]), std.error(df$Count[which(df$source=="galloway")]))
REx<-c(mean(df$Count[which(df$source=="exmoor")]), std.error(df$Count[which(df$source=="exmoor")]))
RO<-c(mean(df$Count[which(df$habitat=="open")]), std.error(df$Count[which(df$habitat=="open")]))
RF<-c(mean(df$Count[which(df$habitat=="forest")]), std.error(df$Count[which(df$habitat=="forest")]))

## Differences between sources
#Early
t4<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="early" & df$source=="exmoor")])
# no difference
#Mid
t5<-wilcox.test(df$Count[which(df$season=="mid" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="exmoor")])
#marginally, but prob. not after corrections
#Late
t6<-wilcox.test(df$Count[which(df$season=="late" & df$source=="galloway")],df$Count[which(df$season=="late" & df$source=="exmoor")])
#yes, but prob. not after corrections
# MEANS and sd. err
RGE<-c(mean(df$Count[which(df$season=="early" & df$source=="galloway")]), std.error(df$Count[which(df$season=="early" & df$source=="galloway")]))
RGM<-c(mean(df$Count[which(df$season=="mid" & df$source=="galloway")]), std.error(df$Count[which(df$season=="mid" & df$source=="galloway")]))
RGL<-c(mean(df$Count[which(df$season=="late" & df$source=="galloway")]), std.error(df$Count[which(df$season=="late" & df$source=="galloway")]))
REE<-c(mean(df$Count[which(df$season=="early" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="early" & df$source=="exmoor")]))
REM<-c(mean(df$Count[which(df$season=="mid" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="mid" & df$source=="exmoor")]))
REL<-c(mean(df$Count[which(df$season=="late" & df$source=="exmoor")]), std.error(df$Count[which(df$season=="late" & df$source=="exmoor")]))

## Differences between seasons
#Galloway
t7<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="galloway")])
t8<-wilcox.test(df$Count[which(df$season=="early" & df$source=="galloway")],df$Count[which(df$season=="late" & df$source=="galloway")])
t9<-wilcox.test(df$Count[which(df$season=="late" & df$source=="galloway")],df$Count[which(df$season=="mid" & df$source=="galloway")])

#Exmoor
t10<-wilcox.test(df$Count[which(df$season=="early" & df$source=="exmoor")],df$Count[which(df$season=="mid" & df$source=="exmoor")])
t11<-wilcox.test(df$Count[which(df$season=="early" & df$source=="exmoor")],df$Count[which(df$season=="late" & df$source=="exmoor")])
t12<-wilcox.test(df$Count[which(df$season=="late" & df$source=="exmoor")],df$Count[which(df$season=="mid" & df$source=="exmoor")])

#All
t13<-wilcox.test(df$Count[which(df$season=="early")],df$Count[which(df$season=="mid")])
t14<-wilcox.test(df$Count[which(df$season=="early")],df$Count[which(df$season=="late")])
t15<-wilcox.test(df$Count[which(df$season=="late")],df$Count[which(df$season=="mid")])


#Open vs. forest, each source
t16<-wilcox.test(df$Count[which(df$habitat=="open" & df$source=="galloway")],df$Count[which(df$habitat=="forest" & df$source=="galloway")])
t17<-wilcox.test(df$Count[which(df$habitat=="open" & df$source=="exmoor")],df$Count[which(df$habitat=="forest" & df$source=="exmoor")])

#Means and sd. err.
RE<-c(mean(df$Count[which(df$season=="early")]), std.error(df$Count[which(df$season=="early")]))
RM<-c(mean(df$Count[which(df$season=="mid")]), std.error(df$Count[which(df$season=="mid")]))
RL<-c(mean(df$Count[which(df$season=="late")]), std.error(df$Count[which(df$season=="late")]))

RGO<-c(mean(df$Count[which(df$habitat=="open" & df$source=="galloway")]), std.error(df$Count[which(df$habitat=="open" & df$source=="galloway")]))
RGF<-c(mean(df$Count[which(df$habitat=="forest" & df$source=="galloway")]), std.error(df$Count[which(df$habitat=="forest" & df$source=="galloway")]))
REO<-c(mean(df$Count[which(df$habitat=="open" & df$source=="exmoor")]), std.error(df$Count[which(df$habitat=="open" & df$source=="exmoor")]))
REF<-c(mean(df$Count[which(df$habitat=="forest" & df$source=="exmoor")]), std.error(df$Count[which(df$habitat=="forest" & df$source=="exmoor")]))

pvals<-data.frame(c(t1$p.value,t2$p.value,t3$p.value,t4$p.value,t5$p.value,t6$p.value,t7$p.value,t8$p.value,t9$p.value,t10$p.value,t11$p.value,t12$p.value,t13$p.value,t14$p.value,t15$p.value,t16$p.value,t17$p.value))
rownames(pvals)<-c("t1","t2","t3","t4","t5","t6","t7","t8","t9","t10","t11","t12","t13","t14","t15","t16","t17")
colnames(pvals)<-"p.value"

holm<-p.adjust(pvals$p.value, method="holm")
pvals<-cbind(pvals,"corrected"=holm)


significant<-c()
for (i in 1:nrow(pvals)) {
  if (pvals$corrected[i]<0.01) {significant<-append(significant, "yes")}
  else if (pvals$corrected[i]<0.05 && pvals$corrected[i]>0.01) {significant<-append(significant, "marginally")}
  else {significant<-append(significant, "no")}
}
pvals<-cbind(pvals, significant)

saveRDS(pvals, "COI/Local_analysis/output/RDS_files/pvals_difference_diptera")
write.table(pvals,"COI/Local_analysis/output/tables/pvals_difference_diptera.txt",sep="\t",row.names=TRUE)

means<-c("mean"=c(),"StERR"=c())
means<-rbind(means,RGE,RGM,RGL,REE,REM,REL,RE,RM,RL,RG,REx,RO,RF,RGO,RGF,REO,REF)
colnames(means)<-c("mean","StErr")

saveRDS(means, "COI/Local_analysis/output/RDS_files/means_groups_diptera")
write.table(means,"COI/Local_analysis/output/tables/means_groups_diptera.txt",sep="\t",row.names=TRUE)



```
